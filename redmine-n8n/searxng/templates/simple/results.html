{% extends "simple/base.html" %}
{% from 'simple/icons.html' import icon, icon_big, icon_small %}
{% macro engine_data_form(engine_data) -%}
    {% for engine_name, kv_data in engine_data.items() %}
        {% for k, v in kv_data.items() %}
            <input type="hidden" name="engine_data-{{ engine_name }}-{{ k|e }}" value="{{ v|e }}">
        {% endfor %}
    {% endfor %}
{%- endmacro %}
{% block title %}{% if query_in_title %}{{- q|e }} - {% endif %}{% endblock %}
{% block meta %}<link rel="alternate" type="application/rss+xml" title="MusaiSearch: {{ q|e }}" href="{{ url_for('search', _external=True) }}?q={{ q|urlencode }}&amp;categories={{ selected_categories|join(",") | replace(' ','+') }}&amp;pageno={{ pageno }}&amp;time_range={{ time_range }}&amp;language={{ current_language }}&amp;safesearch={{ safesearch }}&amp;format=rss">{% endblock %}
{% block content %}
{% include 'simple/search.html' %}

<section id="ai_chat" aria-label="AI assistant" data-q="{{ q|e }}" data-categories="{{ selected_categories|join(',')|e }}" data-pageno="{{ pageno }}" data-time-range="{{ time_range|e }}" data-language="{{ current_language|e }}" data-safesearch="{{ safesearch|e }}">
  <button id="ai_chat_toggle" class="ai-toggle" type="button" aria-label="Collapse AI assistant" title="Collapse">â–¾</button>
  <span class="ai-brand" aria-hidden="true">Musai</span>
  <form id="ai_chat_form" aria-label="Ask Musai..." onsubmit="return false" action="#">
    <input id="ai_chat_input" type="text" autocomplete="off" placeholder="Ask Musai..." inputmode="text" enterkeyhint="send" autocapitalize="sentences" aria-label="Ask Musai">
    <button id="ai_chat_send" type="button" title="Send" aria-label="Send">â†µ</button>
    <small id="ai_chat_status" aria-live="polite"></small>
  </form>
  <div id="ai_chat_output" hidden></div>
  <script>
    // very small helper to call your webhook with current search metadata
    const aiForm = document.getElementById('ai_chat_form');
    const aiInput = document.getElementById('ai_chat_input');
    const aiOut = document.getElementById('ai_chat_output');
    const aiStatus = document.getElementById('ai_chat_status');
    const aiSection = document.getElementById('ai_chat');
    const aiSend = document.getElementById('ai_chat_send');
    const aiToggle = document.getElementById('ai_chat_toggle');
    const rootHtml = document.documentElement;
    const collapseStorageKey = 'musai_ai_chat_collapsed';
    let chatBusy = false;
    // Initialize collapsed state from persistence
    try {
      const isCollapsed = localStorage.getItem(collapseStorageKey) === '1';
      if (isCollapsed) {
        aiSection.classList.add('collapsed');
        rootHtml.classList.add('ai-chat-collapsed');
        if (aiToggle) { aiToggle.setAttribute('aria-label', 'Expand AI assistant'); aiToggle.title = 'Expand'; aiToggle.textContent = 'â–¸'; }
      }
    } catch (e) { /* no-op */ }

    // Toggle collapse/expand for attentional control
    aiToggle?.addEventListener('click', function(ev)
    {
      ev.preventDefault();
      ev.stopPropagation();
      const willCollapse = !aiSection.classList.contains('collapsed');
      aiSection.classList.toggle('collapsed', willCollapse);
      rootHtml.classList.toggle('ai-chat-collapsed', willCollapse);
      try { localStorage.setItem(collapseStorageKey, willCollapse ? '1' : '0'); } catch (e) { /* no-op */ }
      if (aiToggle) {
        aiToggle.setAttribute('aria-label', willCollapse ? 'Expand AI assistant' : 'Collapse AI assistant');
        aiToggle.title = willCollapse ? 'Expand' : 'Collapse';
        aiToggle.textContent = willCollapse ? 'â–¸' : 'â–¾';
      }
    });
    let typingEl = null;

    // Submit on Enter, newline on Shift+Enter
    aiInput?.addEventListener('keydown', function (ev)
    {
      // Avoid interfering with IME composition
      if (ev.isComposing || ev.keyCode === 229) { return; }
      const isEnter = ev.key === 'Enter' || ev.keyCode === 13;
      if (isEnter && !ev.shiftKey)
      {
        ev.preventDefault();
        ev.stopPropagation();
        if (typeof aiForm.requestSubmit === 'function')
        {
          aiForm.requestSubmit();
        }
        else
        {
          aiForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
        }
      }
    });

    // Click on send button triggers the same submit flow without navigating
    aiSend?.addEventListener('click', function (ev)
    {
      ev.preventDefault();
      ev.stopPropagation();
      if (typeof aiForm.requestSubmit === 'function')
      {
        aiForm.requestSubmit();
      }
      else
      {
        aiForm.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
      }
    });

    // Extract a concise, psychologically salient context from the visible results
    function collectTopResultsContext(limit)
    {
      const maxItems = typeof limit === 'number' ? limit : 5;
      const resultArticles = Array.from(document.querySelectorAll('#urls article.result'));
      const top = resultArticles.slice(0, maxItems);
      const items = top.map(function (article)
      {
        const anchor = article.querySelector('h3 a');
        const title = (anchor && anchor.textContent ? anchor.textContent : '').trim();
        const url = (anchor && anchor.href ? anchor.href : '').trim();
        const snippetEl = article.querySelector('p.content');
        const snippetRaw = snippetEl ? (snippetEl.innerText || snippetEl.textContent || '') : '';
        const snippet = snippetRaw.replace(/\s+/g, ' ').trim();

        // Soft limits to reduce cognitive overload
        const maxTitleLen = 140;
        const maxSnippetLen = 220;
        const titleShort = title.length > maxTitleLen ? (title.slice(0, maxTitleLen - 1) + 'â€¦') : title;
        const snippetShort = snippet.length > maxSnippetLen ? (snippet.slice(0, maxSnippetLen - 1) + 'â€¦') : snippet;

        return { title: titleShort, url: url, snippet: snippetShort };
      }).filter(function (x)
      {
        return x.title || x.url || x.snippet;
      });

      return items;
    }

    aiForm?.addEventListener('submit', async function (ev) {
      ev.preventDefault();
      ev.stopPropagation();
      // If currently collapsed, expand to accept input
      if (aiSection.classList.contains('collapsed'))
      {
        aiSection.classList.remove('collapsed');
        rootHtml.classList.remove('ai-chat-collapsed');
        try { localStorage.setItem(collapseStorageKey, '0'); } catch (e) { /* no-op */ }
        if (aiToggle) { aiToggle.setAttribute('aria-label', 'Collapse AI assistant'); aiToggle.title = 'Collapse'; aiToggle.textContent = 'â–¾'; }
      }
      const userPrompt = aiInput.value.trim();
      if (!userPrompt) {
        return;
      }

      // Disable input & send to prevent duplicate submissions
      aiInput.disabled = true;
      aiSend.disabled = true;
      aiStatus.textContent = '';
      aiOut.hidden = true;
      chatBusy = true;

      // Render Musai-style typing indicator
      try {
        if (!typingEl) {
          typingEl = document.createElement('div');
          typingEl.className = 'ai-typing-bubble mystical-glow';
          typingEl.setAttribute('role', 'status');
          typingEl.setAttribute('aria-live', 'polite');
          typingEl.innerHTML = `
            <span class="ai-typing-icon" aria-hidden="true">ðŸ§ </span>
            <span class="ai-typing-label">Musai is thinking</span>
            <span style="display:inline-flex;align-items:center;gap:4px;margin-left:6px;">
              <span class="ai-typing-dot mystical-dots" style="animation-delay:0ms"></span>
              <span class="ai-typing-dot mystical-dots" style="animation-delay:200ms"></span>
              <span class="ai-typing-dot mystical-dots" style="animation-delay:400ms"></span>
            </span>
          `;
        }
        aiOut.hidden = false;
        aiOut.innerHTML = '';
        aiOut.appendChild(typingEl);
      } catch (e) {
        /* no-op */
      }

      // stable client session id using localStorage
      const storageKey = 'musai_session_id';
      let sessionId = localStorage.getItem(storageKey);
      if (!sessionId) {
        sessionId = 'web-' + Date.now() + '-' + Math.random().toString(36).slice(2);
        localStorage.setItem(storageKey, sessionId);
      }

      const ds = aiSection?.dataset || {};
      // Build search-contextual payload
      const contextResults = collectTopResultsContext(5);
      const contextBlock = contextResults.length
        ? ('[ascontext]\n' + contextResults.map(function (r, idx)
          {
            return (idx + 1) + ') ' + (r.title || r.url || 'Untitled') + (r.url ? (' â€” ' + r.url) : '') + (r.snippet ? ('\n   ' + r.snippet) : '');
          }).join('\n'))
        : '';
      const combinedQuery = contextBlock ? (contextBlock + '\n\n' + userPrompt) : userPrompt;

      // If overlay is open, capture that URL to send as a dedicated param
      var overlayUrl = '';
      try { overlayUrl = (window.musaiOverlayAPI && window.musaiOverlayAPI.isOpen()) ? (window.musaiOverlayAPI.currentUrl() || '') : ''; } catch (_) {}

      const payload = {
        sessionId: sessionId,
        query: combinedQuery,
        action: 'webhookChat',
        url: overlayUrl,
        meta: JSON.stringify({ search: {
          q: ds.q || '',
          selected_categories: (ds.categories || '').split(',').filter(Boolean),
          pageno: parseInt(ds.pageno || '1', 10),
          time_range: ds.timeRange || '',
          language: ds.language || '',
          safesearch: ds.safesearch || ''
        }, contextResults: contextResults })
      };

      try {
        const res = await fetch('https://n8n.codemusic.ca/webhook/chat/message', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Basic c2l0ZXVzZXI6Y29kZW11c2Fp'
          },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        // Normalize to first record shape { response, pov }
        const record = Array.isArray(data) ? (data[0] || {}) : (data || {});
        const responseText = record.response || '';
        const pov = Array.isArray(record.pov) ? record.pov : [];

        // Clear output and remove typing indicator
        aiOut.innerHTML = '';
        typingEl = null;

        // Main response (purplish bubble)
        const main = document.createElement('div');
        main.className = 'ai-main-bubble';
        main.textContent = responseText || (Object.keys(record).length ? JSON.stringify(record, null, 2) : '');

        // Extract logical/creative thoughts if present
        let logicalThought = '';
        let creativeThought = '';
        for (const p of pov) {
          const t = (p && (p.type || p.name) || '').toString().toLowerCase();
          if (!logicalThought && (t === 'logical' || /logic/.test(t)) && typeof p.thought === 'string') {
            logicalThought = p.thought;
          }
          if (!creativeThought && (t === 'creative' || /creativ/.test(t)) && typeof p.thought === 'string') {
            creativeThought = p.thought;
          }
        }

        if (logicalThought || creativeThought) {
          const toggles = document.createElement('div');
          toggles.className = 'ai-pov-toggle-group';

          const redBtn = document.createElement('button');
          redBtn.type = 'button';
          redBtn.className = 'ai-pov-toggle red';
          redBtn.textContent = 'Logical';
          if (!logicalThought) redBtn.disabled = true;

          const blueBtn = document.createElement('button');
          blueBtn.type = 'button';
          blueBtn.className = 'ai-pov-toggle blue';
          blueBtn.textContent = 'Creative';
          if (!creativeThought) blueBtn.disabled = true;

          const redPanel = document.createElement('div');
          redPanel.className = 'ai-pov-panel red';
          redPanel.textContent = logicalThought || '';
          redPanel.hidden = true;

          const bluePanel = document.createElement('div');
          bluePanel.className = 'ai-pov-panel blue';
          bluePanel.textContent = creativeThought || '';
          bluePanel.hidden = true;

          function setActive(which) {
            const isRed = which === 'red';
            const isBlue = which === 'blue';
            // Only one visible at a time: when a POV is active, hide the main response
            main.hidden = !!which;
            redPanel.hidden = !isRed;
            bluePanel.hidden = !isBlue;
            redBtn.classList.toggle('active', isRed);
            blueBtn.classList.toggle('active', isBlue);
          }

          redBtn.addEventListener('click', function () {
            if (redBtn.disabled) return;
            setActive(!redBtn.classList.contains('active') ? 'red' : null);
          });
          blueBtn.addEventListener('click', function () {
            if (blueBtn.disabled) return;
            setActive(!blueBtn.classList.contains('active') ? 'blue' : null);
          });

          // Render header first, then the single visible content beneath it
          aiOut.appendChild(toggles);
          toggles.appendChild(redBtn);
          toggles.appendChild(blueBtn);
          aiOut.appendChild(main);
          aiOut.appendChild(redPanel);
          aiOut.appendChild(bluePanel);
          // default: show only main response
          setActive(null);
        } else {
          // No POVs: just show main response
          aiOut.appendChild(main);
        }

        aiOut.hidden = false;
      } catch (err) {
        aiOut.textContent = 'Error contacting AI service.';
        aiOut.hidden = false;
      } finally {
        aiStatus.textContent = '';
        // Re-enable controls
        aiInput.disabled = false;
        aiSend.disabled = false;
        chatBusy = false;
      }
    });

    // Prevent accidental navigation while Musai is thinking
    window.addEventListener('beforeunload', function (e) {
      if (chatBusy) {
        e.preventDefault();
        e.returnValue = '';
      }
    });

    // Intercept clicks on in-origin links and submissions while chat is busy
    document.addEventListener('click', function (e) {
      if (!chatBusy) { return; }
      var anchor = e.target && (e.target.closest ? e.target.closest('a[href]') : null);
      if (anchor) {
        try {
          var href = anchor.getAttribute('href') || '';
          var isHashLink = href.charAt(0) === '#';
          if (isHashLink) { return; }
          var originMatches = false;
          try { originMatches = (anchor.origin === window.location.origin); } catch (_) {}
          var isSameOrigin = originMatches || href.indexOf(window.location.origin) === 0 || href.indexOf('/') === 0;
          if (isSameOrigin) {
            var ok = window.confirm('Musai is thinking. Navigating away will cancel the response. Continue?');
            if (!ok) {
              e.preventDefault();
              e.stopPropagation();
              return;
            }
          }
        } catch (_) { /* no-op */ }
      }
    }, true);

    // Intercept any form submissions (e.g., categories, pagination) while busy
    document.addEventListener('submit', function (e) {
      if (!chatBusy) { return; }
      var ok = window.confirm('Musai is thinking. Submitting will cancel the response. Continue?');
      if (!ok) {
        e.preventDefault();
        e.stopPropagation();
      }
    }, true);
  </script>
</section>

{% if results and results|map(attribute='template')|unique|list|count == 1 %}
  {% set only_template = 'only_template_' + results[0]['template']|default('default')|replace('.html', '') %}
{% else %}
  {% set only_template = '' %}
{% endif %}

<div id="results" class="{{ only_template }}">

  {%- if answers -%}
    {%- include 'simple/elements/answers.html' -%}
  {%- endif %}

    <div id="sidebar">

        {%- if number_of_results != '0' -%}
        <p id="result_count"><small>{{ _('Number of results') }}: {{ number_of_results }}</small></p>
        {%- endif -%}

        {%- if infoboxes -%}
          <div id="infoboxes">
            <details open class="sidebar-collapsible">
              <summary class="title">{{ _('Info') }}</summary>
              {%- for infobox in infoboxes -%}
                {%- include 'simple/elements/infobox.html' -%}
              {%- endfor -%}
            </details>
          </div>
        {%- endif -%}

        {%- if suggestions -%}
          {%- include 'simple/elements/suggestions.html' -%}
        {%- endif -%}

        {%- include 'simple/elements/engines_msg.html' -%}

        {%- if method == 'POST' -%}
          {%- include 'simple/elements/search_url.html' -%}
        {%- endif -%}

        {%- if search_formats -%}
          {%- include 'simple/elements/apis.html' -%}
        {%- endif -%}

        <div id="sidebar-end-collapsible"></div>
    </div>

    {%- if corrections -%}
      {%- include 'simple/elements/corrections.html' -%}
    {%- endif -%}

    <div id="urls" role="main">
    {% for result in results %}
        {% if result.open_group and not only_template %}<div class="template_group_{{ result['template']|replace('.html', '') }}">{% endif %}
        {% set index = loop.index %}
        {% include get_result_template('simple', result['template']) %}
        {% if result.close_group and not only_template %}</div>{% endif %}
    {% endfor %}
    {% if not results and not answers %}
        {% include 'simple/messages/no_results.html' %}
    {% endif %}
    </div>
    <div id="backToTop">
      <a href="#" aria-label="{{ _('Back to top') }}">{{ icon_small('navigate-up') }}</a>
    </div>
    {% if paging %}
    <nav id="pagination" role="navigation">
        {% if pageno > 1 %}
            <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}" class="previous_page">
                <div class="{% if rtl %}right{% else %}left{% endif %}">
                  <input type="hidden" name="q" value="{{ q|e }}" >
                  {% for category in selected_categories %}
                  <input type="hidden" name="category_{{ category }}" value="1" >
                  {% endfor %}
                  <input type="hidden" name="pageno" value="{{ pageno-1 }}" >
                  <input type="hidden" name="language" value="{{ current_language }}" >
                  <input type="hidden" name="time_range" value="{{ time_range }}" >
                  <input type="hidden" name="safesearch" value="{{ safesearch }}" >
                  <input type="hidden" name="theme" value="{{ theme }}" >
                  {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
                  {{- engine_data_form(engine_data) -}}
                  <button role="link" type="submit">{{ icon_small('navigate-left') }} {{ _('Previous page') }}</button>
                </div>
            </form>
        {% endif %}
        {%- if results | count > 0 -%}
          <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}" class="next_page">
              <div class="{% if rtl %}left{% else %}right{% endif %}">
                <input type="hidden" name="q" value="{{ q|e }}" >
                {% for category in selected_categories %}
                <input type="hidden" name="category_{{ category }}" value="1" >
                {% endfor %}
                <input type="hidden" name="pageno" value="{{ pageno+1 }}" >
                <input type="hidden" name="language" value="{{ current_language }}" >
                <input type="hidden" name="time_range" value="{{ time_range }}" >
                <input type="hidden" name="safesearch" value="{{ safesearch }}" >
                <input type="hidden" name="theme" value="{{ theme }}" >
                {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
                {{- engine_data_form(engine_data) -}}
                <button role="link"  type="submit">{{ _('Next page') }} {{ icon_small('navigate-right') }}</button>
              </div>
          </form>
        {%- endif -%}
        {% set pstart = 1 %}
        {% set pend = 11 %}
        {% if pageno > 5 %}
            {% set pstart = pageno - 4 %}
            {% set pend = pageno + 6 %}
        {% endif %}

        <div class="numbered_pagination">
        {% for x in range(pstart, pend) %}
            <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}" class="page_number">
                <input type="hidden" name="q" value="{{ q|e }}" >
                {% for category in selected_categories %}
                <input type="hidden" name="category_{{ category }}" value="1" >
                {% endfor %}
                <input type="hidden" name="pageno" value="{{ x }}" >
                <input type="hidden" name="language" value="{{ current_language }}" >
                <input type="hidden" name="time_range" value="{{ time_range }}" >
                <input type="hidden" name="safesearch" value="{{ safesearch }}" >
                <input type="hidden" name="theme" value="{{ theme }}" >
                {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
                {{- engine_data_form(engine_data) -}}
                {% if pageno == x %}
                <input role="link" class="page_number_current" type="button" value="{{ x }}">
                {% else %}
                <input role="link" class="page_number" type="submit" value="{{ x }}">
                {% endif %}
            </form>
        {% endfor %}
        </div>
    </nav>
    {% endif %}
</div>
{% endblock %}
