{% from 'simple/icons.html' import icon_small %}

<!-- Draw favicon -->
{% macro draw_favicon(favicon) -%}
    <img width="14" height="14" class="favicon" src="{{ url_for('static', filename='themes/simple/img/icons/' + favicon + '.png') }}" alt="{{ favicon }}">
{%- endmacro %}

{# Build a Morty-proxied URL when configured; optionally append a signed hash #}
{% macro morty_proxify(url) -%}
  {%- set p = (get_setting('server.result_proxy.url') or '').strip() -%}
  {%- if not p or not url -%}
    {{- url -}}
  {%- else -%}
    {%- if url[:8] == 'https://' -%}
      {%- set built = p ~ 'https/' ~ url[8:] -%}
    {%- elif url[:7] == 'http://' -%}
      {%- set built = p ~ 'http/' ~ url[7:] -%}
    {%- else -%}
      {%- set built = url -%}
    {%- endif -%}
    {%- if built and (get_setting('server.result_proxy.key') or '') and (sign_morty_url is defined) -%}
      {{- sign_morty_url(built) -}}
    {%- else -%}
      {{- built -}}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{% macro result_open_link(url, classes='') -%}
    <a href="{{ url }}" {% if classes %}class="{{ classes }}" {% endif %}{% if results_on_new_tab %}target="_blank" rel="noopener noreferrer"{% else %}rel="noreferrer"{% endif %}>
{%- endmacro %}

{%- macro result_close_link() -%}
    </a>
{%- endmacro %}

{%- macro result_link(url, title, classes='') -%}
    {{ result_open_link(url, classes) }}{{ title }}{{ result_close_link() }}
{%- endmacro -%}

<!-- Draw result header -->
{% macro result_header(result, favicons, image_proxify) -%}
<article id="result-item-{{ index }}" class="result {% if result['template'] %}result-{{ result.template|replace('.html', '') }}{% else %}result-default{% endif %} {% if result['category'] %}category-{{ result['category'] }}{% endif %}">
  {{- result_open_link(result.url, "url_header") -}}
  {%- if favicon_resolver != "" %}
  <div class="favicon"><img loading="lazy" src="{{ favicon_url(result.parsed_url.netloc) }}"></div>
  {%- endif -%}
  <div class="url_wrapper">
    {%- for part in get_pretty_url(result.parsed_url) -%}
    <span class="url_o{{loop.index}}"><span class="url_i{{loop.index}}">{{- part -}}</span></span>
    {%- endfor %}
  </div>
  {{- result_close_link() -}}
  {%- if result.thumbnail %}{{ result_open_link(result.url) }}<img class="thumbnail" src="{{ image_proxify(result.thumbnail) }}" title="{{ result.title|striptags }}" loading="lazy">{{ result_close_link() }}{% endif -%}
  <h3>
    {{ result_link(result.url, result.title|safe) }}
    {# Proxy badge: only this badge and the Musai overlay use the Morty URL #}
    {% set morty_prefix = (get_setting('server.result_proxy.url') or '') %}
    {% set morty_prefix = morty_prefix.strip() %}
    {% set is_morty = false %}
    {% if morty_prefix %}
      {% if result.url and (morty_prefix in result.url) %}
        {% set is_morty = true %}
      {% elif result.parsed_url and result.parsed_url.path and (result.parsed_url.path[:morty_prefix|length] == morty_prefix) %}
        {% set is_morty = true %}
      {% endif %}
    {% endif %}
    {% set proxied_link = morty_proxify(result.url) %}
    {% set allow_iframe = get_setting('ui.allow_musairesult_iframes') %}
    {% set is_http = result.url and (result.url[:7] == 'http://' or result.url[:8] == 'https://') %}
    {# Ensure the button shows only when the effective link is Morty-proxied #}
    {% set prox_is_morty = false %}
    {% if morty_prefix %}
      {% if proxied_link and (morty_prefix in proxied_link) %}
        {% set prox_is_morty = true %}
      {% elif proxied_link and proxied_link[:morty_prefix|length] == morty_prefix %}
        {% set prox_is_morty = true %}
      {% endif %}
    {% endif %}
    {# Show either the proxy badge OR the Musai iframe button; not both #}
    {% if morty_prefix and not allow_iframe %}
      <a href="{{ proxied_link }}" class="proxy-badge" {% if results_on_new_tab %}target="_blank" rel="noopener noreferrer"{% else %}rel="noreferrer"{% endif %} title="Proxied via Musai" aria-label="Proxied via Musai">
        <img class="musai-inline-icon" src="{{ url_for('static', filename='img/logo_musai_symbol.png') }}" alt="Proxy">
      </a>
    {% endif %}
    {# Show Musai overlay button only when iframe overlay is allowed, Morty proxy is configured, URL is http(s), and the final URL is Morty-proxied #}
    {% if allow_iframe and morty_prefix and is_http and prox_is_morty %}
    <button type="button" class="musai-open-iframe" data-musai-open="1" data-url="{{ proxied_link }}" data-source-url="{{ result.url }}" data-origin-id="result-item-{{ index }}" title="Open in Musai overlay" aria-label="Open in Musai overlay">
      <img class="musai-inline-icon" src="{{ url_for('static', filename='img/logo_musai_symbol.png') }}" alt="Musai">
    </button>
    {% endif %}
  </h3>
{%- endmacro -%}

<!-- Draw result sub header -->
{%- macro result_sub_header(result) -%}
  {%- if result.publishedDate %}<time class="published_date" datetime="{{ result.pubdate }}" >{{ result.publishedDate }}</time>{% endif -%}
  {%- if result.length %}<div class="result_length">{{ _('Length') }}: {{ result.length }}</div>{% endif -%}
  {%- if result.views %}<div class="result_views">{{ _('Views') }}: {{ result.views }}</div>{% endif -%}
  {%- if result.author %}<div class="result_author">{{ _('Author') }}: {{ result.author }}</div>{% endif -%}
  {%- if result.metadata %}<div class="highlight">{{ result.metadata|safe }}</div>{% endif -%}
{%- endmacro -%}

<!-- Draw result sub footer -->
{%- macro result_sub_footer(result) -%}
<div class="engines">
  {% for engine in result.engines %}<span>{{ engine }}</span>{% endfor %}
  {{ icon_small('ellipsis-vertical') + result_link(cache_url + result.url, _('cached'), "cache_link") }}
</div>{{- '' -}}
<div class="break"></div>{{- '' -}}
{%- endmacro -%}

<!-- Draw result footer -->
{%- macro result_footer(result) -%}
</article>
{%- endmacro -%}

<!-- input checkbox, on/off slider user can tap-->
{%- macro checkbox_onoff(name, checked) -%}
  <input type="checkbox" {{- ' ' -}}
         name="{{ name }}" {{- ' ' -}}
         id="{{ name }}" {{- ' ' -}}
         aria-labelledby="pref_{{ name }}"{{- ' ' -}}
         class="checkbox-onoff"{{- ' ' -}}
         {%- if checked -%} checked{%- endif -%}/>
{%- endmacro -%}
