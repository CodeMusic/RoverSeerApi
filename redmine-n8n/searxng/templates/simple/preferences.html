{%- from 'simple/icons.html' import icon_small, icon_big -%}
{%- extends "simple/page_with_header.html" -%}

{%- macro tabs_open() -%}
<div class="tabs" role="tablist">
{%- endmacro -%}

{%- macro tab_header(name, id, label, checked) -%}
<input type="radio" name="{{ name }}" id="tab-{{ id }}" {% if checked is sameas true %}checked="checked"{% endif %}>
<label id="tab-label-{{ id }}" for="tab-{{ id }}" role="tab" aria-controls="tab-content-{{ id }}">{{ label }}</label>
<section id="tab-content-{{ id }}" role="tabpanel" aria-hidden="false">
{%- endmacro -%}

{%- macro tab_footer() -%}
</section>
{%- endmacro -%}

{%- macro tabs_close() -%}
</div>
{%- endmacro -%}

{%- macro checkbox(name, checked, disabled) -%}
  {%- if checked == '?' -%}
    {{- icon_small('alert') -}}
  {%- else -%}
    <input type="checkbox" {%- if name %} name="{{ name }}" {%- endif %} value="None" {%- if checked %} checked {%- endif -%}{%- if disabled %} disabled {%- endif -%}>
  {%- endif -%}
{%- endmacro -%}

{%- macro checkbox_onoff_reversed(name, checked, labelledby) -%}
  <input type="checkbox" {{- ' ' -}}
         name="{{ name }}" {{- ' ' -}}
         id="{{ name }}" {{- ' ' -}}
         {%- if labelledby -%} aria-labelledby="{{ labelledby }}"{{- ' ' -}}{%- endif -%}
         class="checkbox-onoff reversed-checkbox"{{- ' ' -}}
         {%- if checked -%} checked{%- endif -%}>
{%- endmacro -%}

{%- macro plugin_preferences(section) -%}
  {%- for plugin in plugins_storage -%}
    {%- if plugin.preference_section == section -%}
      <fieldset>{{- '' -}}
	<legend>{{ _(plugin.name) }}</legend>{{- '' -}}
	<div class="value">
	  {{- checkbox_onoff_reversed('plugin_' + plugin.id, plugin.id not in allowed_plugins, 'plugin_labelledby' + plugin.id) -}}
	</div>{{- '' -}}
	<div class="description" id="{{ 'plugin_labelledby' + plugin.id }}">
	  {{- _(plugin.description) -}}
	</div>{{- '' -}}
      </fieldset>
    {%- endif -%}
  {%- endfor -%}
{%- endmacro -%}

{%- macro engine_about(search_engine) -%}
{%- if search_engine.about is defined -%}
  {%- set about = search_engine.about -%}
  <div class="engine-tooltip" role="tooltip">{{- '' -}}
    <p class="engine-description"></p>{{- '' -}}
    <p><a href="{{about.website}}" rel="noreferrer">{{about.website}}</a></p>{{- '' -}}
    {%- if about.wikidata_id -%}
      <p><a href="https://www.wikidata.org/wiki/{{about.wikidata_id}}" rel="noreferrer">wikidata.org/wiki/{{about.wikidata_id}}</a></p>
    {%- endif -%}
    {%- if search_engine.enable_http -%}
      <p>{{- icon_big('exclamation-sign', 'No HTTPS') -}}{{- _('No HTTPS')-}}</p>
    {% endif -%}
    {%- if reliabilities.get(search_engine.name, {}).errors or reliabilities.get(search_engine.name, {}).checker -%}
      <a href="{{ url_for('stats', engine=search_engine.name|e) }}" {{- ' ' -}}
         title="{{ _('View error logs and submit a bug report') }}">
      {{- _('View error logs and submit a bug report') -}}
      </a>
    {%- endif -%}
    <p>{{- '' -}}
      <span class="right">{{ _("!bang for this engine") }}</span>{{- '' -}}
      {%- for bang in [search_engine.name] + [search_engine.shortcut] -%}
        <span class="bang"> {{ '!' + bang.replace(' ', '_') }}</span>
      {%- endfor -%}
    </p>{{- '' -}}
    <p>{{- '' -}}
      <span class="right">{{ _("!bang for its categories") }}</span>
      {%- for bang in search_engine.categories -%}
        <span class="bang">{{ '!' + bang.replace(' ', '_') }}</span>
      {%- endfor -%}
    </p>{{- '' -}}
  </div>
{%- endif -%}
{%- endmacro -%}

{%- macro engine_time(engine_name) -%}
  <td class="{{ label }}">{{- '' -}}
    {%- if stats[engine_name].time != None -%}
    <span class="stacked-bar-chart-value">{{- stats[engine_name].time -}}</span>{{- '' -}}
    <span class="stacked-bar-chart" aria-hidden="true">
        {%- if max_rate95 is not none and max_rate95 > 0 -%}
        <div class="stacked-bar-chart-median bar{{ (100 * (stats[engine_name].time / max_rate95))|round }}"></div>{{- '' -}}
        <div class="stacked-bar-chart-rate80 bar{{ (100 * ((stats[engine_name].rate80 - stats[engine_name].time) / max_rate95))|round }}"></div>{{- '' -}}
        <div class="stacked-bar-chart-rate95 bar{{ (100 * ((stats[engine_name].rate95 - stats[engine_name].rate80) / max_rate95))|round }}"></div>{{- '' -}}
        <span class="stacked-bar-chart-rate100"></span>
        {%- endif -%}
    </span>{{- '' -}}
    <div class="engine-tooltip text-left" role="tooltip" id="{{engine_name}}_graph">{{- '' -}}
        <p>{{ _('Median') }}: {{ stats[engine_name].time }}</p>{{- '' -}}
        <p>{{ _('P80') }}: {{ stats[engine_name].rate80 }}</p>{{- '' -}}
        <p>{{ _('P95') }}: {{ stats[engine_name].rate95 }}</p>{{- '' -}}
    </div>
  {%- endif -%}
  </td>
{%- endmacro -%}

{%- macro engine_reliability(engine_name) -%}
  {%- set r = reliabilities.get(engine_name, {}).get('reliability', None) -%}
  {%- set checker_result = reliabilities.get(engine_name, {}).get('checker', []) -%}
  {%- set errors = reliabilities.get(engine_name, {}).get('errors', []) -%}
  {%- if r != None -%}
    {%- if r <= 50 -%}
      {% set label = 'danger' -%}
    {%- elif r < 80 -%}
      {%- set label = 'warning' -%}
    {%- elif r < 90 %}
      {%- set label = '' -%}
    {%- else -%}
      {%- set label = 'success' -%}
    {%- endif -%}
  {% else %}
    {%- set r = '' -%}
  {%- endif -%}
  {%- if checker_result or errors -%}
    <td class="{{ label }} column-reliability">{{- '' -}}
      <a href="{{ url_for('stats', engine=engine_name|e) }}">{{- '' -}}
        <span>
          {{- icon_big('alert', 'The engine is not reliabled') }} {{ r -}}
        </span>{{- '' -}}
      </a>{{- '' -}}
      <div class="engine-tooltip" role="tooltip" id="{{engine_name}}_reliability">
        {%- if checker_result -%}
          <p>{{ _("Failed checker test(s): ") }} {{ ', '.join(checker_result) }}</p>
        {%- endif -%}
        {%- if errors -%}<p>{{ _('Errors:') }}</p>{%- endif -%}
        {%- for error in errors -%}
          <p>{{ error }}</p>{{- '' -}}
        {%- endfor -%}
      </div>{{- '' -}}
    </td>
  {%- else -%}
    <td class="{{ label }}">{% if r %}<span>{{ r }}</span>
  {%- endif -%}
    </td>
  {%- endif -%}
{%- endmacro -%}

{%- block head -%}
<style>
  /* Scope to preferences page */
  #main_preferences {
    position: relative;
  }
  /* Frosted veil covering below the tab headers */
  #musai_veil_overlay {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    top: 0; /* dynamically adjusted by script to sit below the tabs */
    background: rgba(30,32,48,0.35);
    -webkit-backdrop-filter: saturate(1.4) blur(8px);
    backdrop-filter: saturate(1.4) blur(8px);
    z-index: 500; /* above content, below global UI */
    display: none; /* shown by script when locked */
    align-items: flex-start;
    justify-content: center;
    padding-top: 24px;
    pointer-events: auto;
  }
  .musai-veil-card {
    background: rgba(46,50,74,0.92);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    box-shadow: 0 6px 28px rgba(0,0,0,.35);
    color: var(--musai-text);
    width: min(560px, calc(100% - 28px));
    padding: 16px;
  }
  .musai-veil-card h2 {
    margin: 0 0 8px 0;
    font-size: 1.25rem;
  }
  .musai-veil-card p {
    margin: 0 0 12px 0;
    opacity: .9;
  }
  .musai-veil-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .musai-veil-row input[type="password"],
  .musai-veil-row input[type="text"] {
    flex: 1;
    min-width: 0;
    height: 40px;
    padding: 0 10px;
    border-radius: 10px;
    border: 1px solid var(--musai-primary);
    background: rgba(0,0,0,0.15);
    color: var(--musai-text);
  }
  .musai-veil-row button {
    height: 40px;
    padding: 0 14px;
    background: var(--musai-primary);
    color: #fff;
    border-radius: 10px;
    border: 0;
    cursor: pointer;
  }
  .musai-veil-row button:hover { filter: brightness(1.1); }
  .musai-veil-error {
    color: #fecaca; /* light red */
    margin-top: 8px;
    display: none;
  }
  @media (prefers-color-scheme: light) {
    html.theme-auto #musai_veil_overlay .musai-veil-card,
    html.theme-light #musai_veil_overlay .musai-veil-card {
      background: rgba(255,255,255,0.96);
      color: #222222;
    }
  }
</style>
<script>
  (function musaiVeilOfUncertainty()
  {
    try
    {
      var storageKey = 'musaiVeilUnlocked';
      var unlocked = false;
      try { unlocked = window.sessionStorage && window.sessionStorage.getItem(storageKey) === '1'; } catch (e) { unlocked = false; }

      var main = document.getElementById('main_preferences');
      if (!main) { return; }

      function ensureOverlay()
      {
        var ov = document.getElementById('musai_veil_overlay');
        if (ov) { return ov; }
        ov = document.createElement('div');
        ov.id = 'musai_veil_overlay';
        ov.setAttribute('aria-hidden', 'true');
        ov.innerHTML = '\n  <div class="musai-veil-card" role="dialog" aria-modal="true" aria-labelledby="veil_title">\n    <h2 id="veil_title">Musai\'s Vail of Uncertainty</h2>\n    <p>Protective fog is active. Enter the password to gain perspective and adjust preferences.</p>\n    <div class="musai-veil-row">\n      <input id="musai_veil_input" type="password" placeholder="Enter password" autocomplete="off" aria-label="Password">\n      <button id="musai_veil_unlock" type="button">Unveil</button>\n    </div>\n    <div id="musai_veil_error" class="musai-veil-error">That does not align with perspective. Try again.</div>\n  </div>\n';
        main.appendChild(ov);
        return ov;
      }

      function computeOverlayTop()
      {
        var overlay = document.getElementById('musai_veil_overlay');
        if (!overlay) { return; }
        var labels = main.querySelectorAll('.tabs > label[role="tab"]');
        var mainRect = main.getBoundingClientRect();
        var maxBottom = 0;
        for (var i = 0; i < labels.length; i++)
        {
          var r = labels[i].getBoundingClientRect();
          if (r.bottom > maxBottom) { maxBottom = r.bottom; }
        }
        var topOffset = 0;
        if (maxBottom > 0) { topOffset = Math.max(0, Math.round(maxBottom - mainRect.top)); }
        overlay.style.top = topOffset + 'px';
      }

      function lock()
      {
        var overlay = ensureOverlay();
        overlay.style.display = 'flex';
        computeOverlayTop();
        var input = document.getElementById('musai_veil_input');
        if (input) { setTimeout(function(){ try { input.focus(); } catch (e) {} }, 0); }
      }

      function unlock()
      {
        var overlay = document.getElementById('musai_veil_overlay');
        if (overlay) { overlay.style.display = 'none'; overlay.parentNode && overlay.parentNode.removeChild(overlay); }
        try { window.sessionStorage && window.sessionStorage.setItem(storageKey, '1'); } catch (e) {}
      }

      function onSubmit()
      {
        var input = document.getElementById('musai_veil_input');
        var error = document.getElementById('musai_veil_error');
        if (!input) { return; }
        var val = (input.value || '').trim().toLowerCase();
        if (val === 'perspective')
        {
          if (error) { error.style.display = 'none'; }
          unlock();
        }
        else
        {
          if (error) { error.style.display = 'block'; }
        }
      }

      if (!unlocked)
      {
        // Initialize overlay and handlers
        lock();
        var clickHandler = function(e)
        {
          if (!e) { return; }
          var t = e.target;
          if (t && t.id === 'musai_veil_unlock') { onSubmit(); }
        };
        var keyHandler = function(e)
        {
          if (!e) { return; }
          if (e.key === 'Enter')
          {
            var input = document.getElementById('musai_veil_input');
            if (document.activeElement === input) { e.preventDefault(); onSubmit(); }
          }
        };
        document.addEventListener('click', clickHandler);
        document.addEventListener('keydown', keyHandler);
        window.addEventListener('resize', computeOverlayTop, { passive: true });
        // Recompute once images/fonts layout settle
        setTimeout(computeOverlayTop, 0);
        setTimeout(computeOverlayTop, 250);
        setTimeout(computeOverlayTop, 1000);
      }
    }
    catch (e)
    {
      /* no-op */
    }
  })();
</script>
{%- endblock -%}
{%- block linkto_preferences -%}{%- endblock -%}

{%- block content -%}

  <h1>{{ _('Preferences') }}</h1>
  {# Musai's Vail of Uncertainty overlay is injected by script and scoped to this page #}

  <form id="search_form" method="post" action="{{ url_for('preferences') }}" autocomplete="off">
    {{- tabs_open() -}}

    {# tab: general #}

    {{- tab_header('maintab', 'general', _('General'), True) -}}
    {%- if 'categories' not in locked_preferences -%}
      <fieldset>
        <legend>{{- _('Default categories') -}}</legend>
        {% set display_tooltip = false %}
        {% include 'simple/categories.html' %}
      </fieldset>
    {%- endif -%}
    {%- if 'language' not in locked_preferences -%}
      {%- include 'simple/preferences/language.html' -%}
    {% endif %}
    {%- if 'autocomplete' not in locked_preferences -%}
      {%- include 'simple/preferences/autocomplete.html' -%}
    {%- endif -%}
    {%- if 'favicon' not in locked_preferences -%}
      {%- include 'simple/preferences/favicon.html' -%}
    {%- endif -%}
    {% if 'safesearch' not in locked_preferences %}
      {%- include 'simple/preferences/safesearch.html' -%}
    {%- endif -%}
    {%- include 'simple/preferences/tokens.html' -%}
    {{- plugin_preferences('general') -}}


    {%- if 'doi_resolver' not in locked_preferences %}
      {%- include 'simple/preferences/doi_resolver.html' -%}
    {%- endif -%}
    {{- tab_footer() -}}

    {# tab: ui #}

    {{- tab_header('maintab', 'ui', _('User interface')) -}}
    {%- if 'locale' not in locked_preferences -%}
      {%- include 'simple/preferences/ui_locale.html' -%}
    {%- endif -%}
    {%- if 'theme' not in locked_preferences -%}
      {%- include 'simple/preferences/theme.html' -%}
    {%- endif -%}
    {%- if 'results_on_new_tab' not in locked_preferences -%}
      {%- include 'simple/preferences/results_on_new_tab.html' -%}
    {%- endif -%}
    {%- if 'infinite_scroll' not in locked_preferences -%}
      {%- include 'simple/preferences/infinite_scroll.html' -%}
    {%- endif -%}
    {%- if 'search_on_category_select' not in locked_preferences -%}
      {%- include 'simple/preferences/search_on_category_select.html' -%}
    {%- endif -%}
    {%- include 'simple/preferences/hotkeys.html' -%}
    {%- include 'simple/preferences/urlformatting.html' -%}
    {{- plugin_preferences('ui') -}}
    {{- tab_footer() -}}

    {# tab: privacy #}

    {{- tab_header('maintab', 'privacy', _('Privacy')) -}}
    {%- if 'method' not in locked_preferences -%}
      {%- include 'simple/preferences/method.html' -%}
    {%- endif -%}
    {%- if 'image_proxy' not in locked_preferences -%}
      {%- include 'simple/preferences/image_proxy.html' -%}
    {%- endif -%}
    {%- if 'query_in_title' not in locked_preferences -%}
      {%- include 'simple/preferences/query_in_title.html' -%}
    {%- endif -%}
    {{- plugin_preferences('privacy') -}}
    {{- tab_footer() -}}

    {# tab: enignes #}

    {{- tab_header('maintab', 'engines', _('Engines')) -}}
    <p>
      {{- _('Currently used search engines') -}}
    </p>
    {{- tabs_open() -}}
    {%- include 'simple/preferences/engines.html' -%}
    {{- tabs_close() -}}
    {{- tab_footer() -}}

    {# tab: query #}

    {{- tab_header('maintab', 'query', _('Special Queries')) -}}
    {%- if answer_storage -%}
      {%- include 'simple/preferences/answerers.html' -%}
    {%- endif -%}
    {{- tab_footer() -}}

    {# tab: cookies #}

    {{- tab_header('maintab', 'cookies', _('Cookies')) -}}
    {%- include 'simple/preferences/cookies.html' -%}
    {{- tab_footer() -}}
    {{- tabs_close() -}}

    {# footer with save & reset buttons #}

    {%- include 'simple/preferences/footer.html' -%}

  </form>{{- '' -}}
{%- endblock -%}
