{% from 'simple/icons.html' import icon_big %}
{%- set category_icons = {
    'apps': 'appstore',
    'dictionaries': 'book',
    'files': 'file-tray-full',
    'general': 'search',
    'images': 'image',
    'it': 'layers',
    'map': 'location',
    'music': 'musical-notes',
    'news': 'newspaper',
    'radio': 'radio',
    'science': 'school',
    'social media': 'people',
    'TV': 'tv',
    'videos': 'play',
}  -%}
<div id="categories" class="search_categories">{{- '' -}}
    <div class="categories_toolbar">
        <button id="categories_icon_toggle" type="button" aria-pressed="false"
            title="{{ _('Show icons only') }}"
            data-label-off="{{ _('Symbols') }}"
            data-label-on="{{ _('Labels') }}"
            data-title-off="{{ _('Show icons only') }}"
            data-title-on="{{ _('Show search type names') }}">
            <span class="icon" aria-hidden="true">âœ¦</span>
            <span class="label">{{ _('Symbols') }}</span>
        </button>
    </div>
    <div id="categories_container">
        {%- if not search_on_category_select or not display_tooltip -%}
            {%- for category in categories -%}
                <div class="category category_checkbox">{{- '' -}}
                    <input type="checkbox" id="checkbox_{{ category|replace(' ', '_') }}" name="category_{{ category }}"{% if category in selected_categories %} checked="checked"{% endif %}>
                    <label for="checkbox_{{ category|replace(' ', '_') }}" class="tooltips" title="{{ _('TV') if category == 'TV' else _(category)|title }}">
                        {{- icon_big(category_icons[category]) if category in category_icons  else icon_big('globe') -}}
                        <div class="category_name">{{- _(category) -}}</div>
                    </label>
                </div>
            {%- endfor -%}
            {%- if display_tooltip %}<div class="help">{{ _('Click on the magnifier to perform search') }}</div>{% endif -%}
        {%- else -%}
            {%- for category in categories -%}{{- '\n' -}}
                <button type="submit" name="category_{{ category }}" class="category category_button {% if category in selected_categories %}selected{% endif %}"
                    title="{{ _('TV') if category == 'TV' else _(category)|title }}">
                    {{- icon_big(category_icons[category]) if category in category_icons else icon_big('globe') -}}
                    <div class="category_name">{{- _(category) -}}</div>{{- '' -}}
                </button>{{- '' -}}
            {%- endfor -%}
            <input name="categories" id="selected-categories" type="hidden" />
            {{- '\n' -}}
        {%- endif -%}
    </div>{{- '' -}}
</div>
<div id="categories_mobile" class="hide_if_nojs">{{- '' -}}
  <label for="categories_select" class="categories_label">{{ icon_big('layers') }}<span>{{ _('Search Type') }}</span></label>{{- '' -}}
  <select id="categories_select" aria-label="{{ _('Search type') }}">{{- '' -}}
    <option value="">{{ _('Choose Type') }}</option>
    {%- for category in categories -%}
      <option value="{{ category }}"{% if category in selected_categories %} selected{% endif %}>{{ _('TV') if category == 'TV' else _(category)|title }}</option>
    {%- endfor -%}
  </select>{{- '' -}}
</div>
<script>
(function initMobileCategorySelect()
{
  try
  {
    var selectEl = document.getElementById('categories_select');
    var formEl = document.getElementById('search');
    if (!selectEl || !formEl) { return; }

    selectEl.addEventListener('change', function ()
    {
      // Remove any prior category inputs (checkbox or hidden) so only one category is submitted
      var allCategoryInputs = formEl.querySelectorAll('input[name^="category_"]');
      for (var i = 0; i < allCategoryInputs.length; i++)
      {
        var inp = allCategoryInputs[i];
        if (inp.type === 'checkbox') { inp.checked = false; }
        if (inp.type === 'hidden') { inp.parentNode && inp.parentNode.removeChild(inp); }
      }

      var category = selectEl.value;
      if (!category) { return; }

      // Create a hidden input as if a category button/checkbox was selected
      var hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'category_' + category;
      hidden.value = '1';
      formEl.appendChild(hidden);

      if (typeof formEl.requestSubmit === 'function')
      {
        formEl.requestSubmit();
      }
      else
      {
        formEl.submit();
      }
    });
  }
  catch (e) { /* no-op */ }
})();
</script>
<script>
(function initCategoryOverflowToggle()
{
  try
  {
    var container = document.getElementById('categories_container');
    if (!container) { return; }

    var currentDisplayValue = '';
    var moreButton = null;
    var isExpanded = false;

    var ensureMoreButton = function()
    {
      if (moreButton) { return moreButton; }
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.id = 'categories_more_toggle';
      btn.className = 'category category_button';
      btn.setAttribute('aria-expanded', 'false');
      btn.textContent = (typeof window !== 'undefined' && window.SEARCH_I18N_MORE) ? window.SEARCH_I18N_MORE : 'More';
      btn.addEventListener('click', function()
      {
        isExpanded = !isExpanded;
        btn.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
        btn.textContent = isExpanded ? ((window.SEARCH_I18N_LESS) || 'Less') : ((window.SEARCH_I18N_MORE) || 'More');
        applyLayout();
      });
      moreButton = btn;
      return moreButton;
    };

    var getItems = function()
    {
      return container.querySelectorAll('.category');
    };

    var hideOverflowFromIndex = function(startIndex)
    {
      var items = getItems();
      for (var i = 0; i < items.length; i++)
      {
        var el = items[i];
        if (i > startIndex)
        {
          el.style.display = 'none';
          el.dataset.overflow = '1';
        }
        else
        {
          el.style.display = currentDisplayValue || '';
          delete el.dataset.overflow;
        }
      }
    };

    var showAll = function()
    {
      var items = getItems();
      for (var i = 0; i < items.length; i++)
      {
        var el = items[i];
        el.style.display = currentDisplayValue || '';
        delete el.dataset.overflow;
      }
    };

    var applyLayout = function()
    {
      var items = getItems();
      if (!items.length) { return; }

      currentDisplayValue = window.getComputedStyle(items[0]).display || '';

      var firstTop = items[0].offsetTop;
      var lastFirstRowIndex = 0;
      for (var i = 1; i < items.length; i++)
      {
        if (items[i].offsetTop !== firstTop)
        {
          break;
        }
        lastFirstRowIndex = i;
      }

      var needsToggle = lastFirstRowIndex < items.length - 1;
      if (!needsToggle)
      {
        showAll();
        if (moreButton && moreButton.parentNode) { moreButton.parentNode.removeChild(moreButton); }
        return;
      }

      var btn = ensureMoreButton();
      if (btn.parentNode !== container)
      {
        container.appendChild(btn);
      }

      if (isExpanded)
      {
        showAll();
        container.appendChild(btn);
      }
      else
      {
        hideOverflowFromIndex(lastFirstRowIndex);
        container.appendChild(btn);
      }
    };

    var scheduleApply = function()
    {
      try { applyLayout(); } catch (_) {}
    };

    if (document.readyState === 'loading')
    {
      document.addEventListener('DOMContentLoaded', scheduleApply);
    }
    else
    {
      scheduleApply();
    }

    window.addEventListener('resize', function()
    {
      scheduleApply();
    });
  }
  catch (e) { /* no-op */ }
})();
</script>
<script>
(function initCategoryIconToggle()
{
  try
  {
    var toggle = document.getElementById('categories_icon_toggle');
    var container = document.getElementById('categories_container');
    if (!toggle || !container) { return; }

    var labelEl = toggle.querySelector('.label');
    var offLabel = toggle.getAttribute('data-label-off') || 'Symbols';
    var onLabel = toggle.getAttribute('data-label-on') || 'Labels';
    var offTitle = toggle.getAttribute('data-title-off') || 'Show icons only';
    var onTitle = toggle.getAttribute('data-title-on') || 'Show search type names';
    var storageKey = 'musai_categories_icon_mode';

    var apply = function(active)
    {
      container.classList.toggle('icon-only', !!active);
      toggle.setAttribute('aria-pressed', active ? 'true' : 'false');
      toggle.setAttribute('title', active ? onTitle : offTitle);
      if (labelEl) { labelEl.textContent = active ? onLabel : offLabel; }
    };

    var initial = false;
    try { initial = localStorage.getItem(storageKey) === '1'; } catch (_) { initial = false; }
    apply(initial);

    toggle.addEventListener('click', function()
    {
      var next = !container.classList.contains('icon-only');
      apply(next);
      try { localStorage.setItem(storageKey, next ? '1' : '0'); } catch (_) { /* no-op */ }
      try { window.dispatchEvent(new Event('resize')); } catch (_) { /* no-op */ }
    });
  }
  catch (_)
  {
    /* no-op */
  }
})();
</script>
