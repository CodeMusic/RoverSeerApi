<form id="search" method="{{ method or 'POST' }}" action="{{ url_for('search') }}" role="search">
  <div id="search_header">
    <div id="search_logo">
      <a href="{{ url_for('index') }}" title="MusaiSearch" aria-label="MusaiSearch home">
        <img src="{{ url_for('static', filename='img/logo_musai_symbol.png') }}" alt="Musai">
      </a>
    </div>
    <div id="search_view">
      <div class="search_box">
        <input id="q" name="q" type="text" placeholder="{{ _('Search for...') }}" tabindex="1" autocomplete="off" autocapitalize="none" spellcheck="false" autocorrect="off" dir="auto" value="{{ q or '' }}" inputmode="search" enterkeyhint="search" aria-label="{{ _('Search for...') }}">
        <button id="clear_search" type="button" class="hide_if_nojs" aria-label="{{ _('Clear search') }}">âœ•</button>
        <button id="send_search" type="submit" {%- if search_on_category_select -%}name="category_{{ selected_categories[0]|replace(' ', '_') }}"{%- endif -%} aria-label="{{ _('search') }}"><span class="hide_if_nojs">{{ icon_big('search') }}</span><span class="show_if_nojs">{{ _('search') }}</span></button>
        <div class="autocomplete hide_if_nojs"><ul></ul></div>
      </div>
    </div>
    {% set display_tooltip = true %}
    {% include 'simple/categories.html' %}
  </div>
  <div class="search_filters">
    {% include 'simple/filters/languages.html' %}
    {% include 'simple/filters/time_range.html' %}
    {% include 'simple/filters/safesearch.html' %}
  </div>
  <input type="hidden" name="theme" value="{{ theme }}" >
  {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
</form>
<script>
  (function ensureEnterSubmitsSearch()
  {
    try
    {
      var searchForm = document.getElementById('search');
      var queryInput = document.getElementById('q');
      if (!searchForm || !queryInput) { return; }

      queryInput.addEventListener('keydown', function (ev)
      {
        if (ev && (ev.isComposing || ev.keyCode === 229)) { return; }
        var isEnter = (ev && (ev.key === 'Enter' || ev.keyCode === 13));
        if (isEnter && !ev.shiftKey)
        {
          ev.preventDefault();
          ev.stopPropagation();
          if (typeof searchForm.requestSubmit === 'function')
          {
            searchForm.requestSubmit();
          }
          else
          {
            searchForm.submit();
          }
        }
      });
    }
    catch (e) { /* no-op */ }
  })();
  </script>
<script>
  (function interceptUrlOnResultsPage()
  {
    try
    {
      var isOnResultsPage = !!document.getElementById('main_results');
      if (!isOnResultsPage) { return; }

      var searchForm = document.getElementById('search');
      var queryInput = document.getElementById('q');
      if (!searchForm || !queryInput) { return; }

      var hasScheme = function(value)
      {
        return /^(?:[a-z][a-z0-9+.-]*):\/\//i.test(value);
      };

      var looksLikeUrl = function(value)
      {
        if (!value) { return false; }
        if (/\s/.test(value)) { return false; }
        if (hasScheme(value)) { return true; }
        if (/^www\./i.test(value)) { return true; }
        // localhost[:port][/path]
        if (/^(?:localhost)(?::\d+)?(?:[\/\?#].*)?$/i.test(value)) { return true; }
        // IPv4[:port][/path]
        if (/^(?:\d{1,3})(?:\.\d{1,3}){3}(?::\d+)?(?:[\/\?#].*)?$/.test(value)) { return true; }
        // domain.tld or sub.domain.tld with optional path/query/hash
        return /^[^\s]+\.[a-z]{2,}(?:[\/\?#].*)?$/i.test(value);
      };

      var normalizeUrl = function(value)
      {
        if (!value) { return value; }
        if (hasScheme(value)) { return value; }
        if (/^www\./i.test(value)) { return 'https://' + value; }
        if (/^(?:localhost|\d{1,3}(?:\.\d{1,3}){3})(?::\d+)?(?:[\/\?#].*)?$/i.test(value)) { return 'http://' + value; }
        // Bare domain -> assume https
        return 'https://' + value;
      };

      searchForm.addEventListener('submit', function(ev)
      {
        try
        {
          var raw = (queryInput.value || '').trim();
          if (!raw) { return; }
          if (!looksLikeUrl(raw)) { return; }

          ev.preventDefault();
          ev.stopPropagation();

          var finalUrl = normalizeUrl(raw);
          try { if (window.musaiAI && typeof window.musaiAI.markInternalNav === 'function') { window.musaiAI.markInternalNav(); } } catch (_) { /* no-op */ }
          if (window.musaiOverlayAPI && typeof window.musaiOverlayAPI.open === 'function')
          {
            window.musaiOverlayAPI.open(finalUrl, 'searchbar-direct');
          }
          else
          {
            // Fallback: open in new tab if overlay is unavailable
            try { window.open(finalUrl, '_blank', 'noopener'); } catch (_) { /* no-op */ }
          }
        }
        catch (_) { /* no-op */ }
      });
    }
    catch (e) { /* no-op */ }
  })();
</script>
