<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RoverSeer System</title>
    <style>
        body 
        { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; 
            background: #f4f4f4; 
            color: #333; 
            margin: 20px;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            body {
                margin: 0;
                padding: 0;
                background: #000000;
            }
            
            .header {
                background: #1c1c1e;
                color: white;
                padding: 15px 10px 10px 10px;
                padding-top: max(15px, env(safe-area-inset-top));
                flex-direction: column;
                gap: 10px;
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .container {
                flex-direction: column;
                gap: 10px;
                margin-top: 10px;
                padding: 0 10px;
            }
            
            .sidebar {
                flex: none;
                margin-bottom: 10px;
                border-radius: 0;
                box-shadow: none;
                background: #1c1c1e;
                color: white;
            }
            
            .main-content {
                border-radius: 0;
                box-shadow: none;
                padding: 15px 10px;
                background: white;
            }
            
            .status-display {
                background: #1e3a8a !important;
                color: white !important;
                padding: 12px 15px !important;
                border-radius: 8px !important;
                font-size: 16px !important;
                font-weight: bold !important;
                border: 2px solid #3b82f6 !important;
                text-align: center !important;
                margin: 0 10px !important;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
            }
            
            .status-display .status-indicator {
                font-size: 18px !important;
                margin-right: 8px !important;
            }
            
            .refresh-btn {
                font-size: 14px;
                padding: 10px 15px;
                margin: 0 10px;
                width: calc(100% - 20px);
                box-sizing: border-box;
            }
            
            .back-header-link {
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }
            
            .log-type {
                background: #2c2c2e;
                color: white;
                border: 1px solid #3a3a3c;
            }
            
            .log-type:hover {
                background: #3a3a3c;
            }
            
            .log-type.active {
                background: #007AFF;
                border-color: #007AFF;
            }
            
            .model-list-table {
                font-size: 12px;
            }
            
            .model-list-table th,
            .model-list-table td {
                padding: 8px 6px;
            }
            
            /* Make command buttons touch-friendly */
            .command-item button {
                min-height: 44px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .setting-item button {
                min-height: 44px;
                font-size: 16px;
                width: 100%;
            }
            
            .setting-item select {
                min-height: 44px;
                font-size: 16px;
            }
        }
        .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .container { display: flex; gap: 20px; margin-top: 20px; }
        .sidebar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); flex: 0 0 300px; }
        .main-content { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); flex: 1; }
        .log-type { background: #f0f0f0; padding: 10px 15px; margin: 5px 0; border-radius: 5px; cursor: pointer; text-decoration: none; color: #333; display: block; transition: background 0.3s; }
        .log-type:hover { background: #e0e0e0; }
        .log-type.active { background: #4169e1; color: white; }
        .top-models { margin-bottom: 30px; }
        .model-item { background: #f8f8f8; padding: 8px; margin: 3px 0; border-radius: 3px; display: flex; justify-content: space-between; }
        .log-entry { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .log-entry:hover { background: #e8e8e8; }
        .log-entry-summary { display: flex; justify-content: space-between; align-items: center; }
        .log-entry-details { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; font-family: monospace; font-size: 12px; }
        .log-entry.expanded .log-entry-details { display: block; }
        .log-entry-meta { font-size: 12px; color: #666; }
        .play-button { background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px; }
        .play-button:hover { background: #45a049; }
        .play-button:disabled { background: #ccc; cursor: not-allowed; }
        .refresh-btn { background: #4CAF50; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .refresh-btn:hover { background: #45a049; }
        .rank { font-weight: bold; color: #666; margin-right: 10px; }
        .no-logs { color: #999; font-style: italic; text-align: center; padding: 20px; }
        .date-selector { margin: 15px 0; }
        .date-selector select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
        .log-info { background: #e7f3ff; padding: 10px; margin: 10px 0; border-radius: 5px; font-size: 14px; }
        .sort-controls { margin-bottom: 15px; }
        .sort-btn { background: #f0f0f0; border: 1px solid #ddd; padding: 6px 12px; margin-right: 5px; border-radius: 4px; text-decoration: none; color: #333; font-size: 12px; }
        .sort-btn.active { background: #4169e1; color: white; border-color: #4169e1; }
        .sort-btn:hover { background: #e0e0e0; }
        .sort-btn.active:hover { background: #3558d1; }
        .model-stats { display: flex; gap: 10px; align-items: center; font-size: 11px; color: #666; }
        .see-all-models { background: #f0f8ff; padding: 8px 12px; margin: 10px 0; border-radius: 5px; text-align: center; }
        .see-all-models a { color: #4169e1; text-decoration: none; font-weight: bold; }
        .see-all-models a:hover { text-decoration: underline; }
        .model-list-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        .model-list-table th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: bold; }
        .model-list-table td { padding: 10px 12px; border-bottom: 1px solid #dee2e6; }
        .model-list-table tr:nth-child(even) { background: #f8f9fa; }
        .model-list-table tr:nth-child(odd) { background: white; }
        .model-list-table tr:hover { background: #e3f2fd; cursor: pointer; }
        .model-detail-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .model-detail-header { background: #4169e1; color: white; padding: 15px; border-radius: 8px 8px 0 0; margin: -20px -20px 20px -20px; }
        .model-detail-section { margin: 15px 0; }
        .model-detail-section h4 { color: #333; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .model-detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .model-detail-item { background: white; padding: 10px; border-radius: 5px; border-left: 4px solid #4169e1; }
        .model-detail-item .label { font-weight: bold; color: #666; font-size: 12px; text-transform: uppercase; }
        .model-detail-item .value { font-size: 16px; color: #333; margin-top: 5px; }
        .clickable-model { cursor: pointer; transition: background 0.3s; }
        .clickable-model:hover { background: #e3f2fd !important; }
        .back-arrow { 
            color: white; 
            text-decoration: none; 
            font-size: 24px; 
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        .back-arrow:hover {
            color: #e0e0e0;
        }
        .commands-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .command-group {
            margin-bottom: 20px;
        }
        .command-group h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .command-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .command-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .command-item button {
            background: #4169e1;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .command-item button:hover {
            background: #3558d1;
        }
        .command-item button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .status-message.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        .settings-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .settings-group {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .settings-group:last-child {
            border-bottom: none;
        }
        .settings-group h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .setting-item {
            margin-bottom: 15px;
        }
        .setting-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .setting-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        .setting-item button {
            background: #4169e1;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .setting-item button:hover {
            background: #3558d1;
        }
        .setting-item button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .current-value {
            color: #666;
            font-style: italic;
            margin-left: 10px;
        }
        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .log-entry-preview {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        /* Mobile truncation for log entries */
        @media (max-width: 768px) {
            .log-entry-preview {
                font-size: 12px;
                line-height: 1.3;
            }
            
            .log-entry-preview-mobile {
                max-width: 100%;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            .log-entry-preview-truncated {
                display: block;
            }
            
            .log-entry-preview-full {
                display: none;
            }
            
            .log-entry-preview.expanded .log-entry-preview-truncated {
                display: none;
            }
            
            .log-entry-preview.expanded .log-entry-preview-full {
                display: block;
            }
            
            .expand-preview-btn {
                color: #007AFF;
                background: none;
                border: none;
                padding: 0;
                font-size: 12px;
                cursor: pointer;
                text-decoration: underline;
                margin-left: 5px;
            }
            
            .expand-preview-btn:hover {
                color: #0051D5;
            }
        }
        .think-tag {
            background-color: #f0f0f0;
            border-left: 3px solid #999;
            padding: 10px;
            margin: 10px 0;
            font-style: italic;
            color: #666;
        }
        .think-tag-collapsed {
            cursor: pointer;
            background-color: #f8f8f8;
            padding: 5px 10px;
            margin: 5px 0;
            border-radius: 3px;
            display: inline-block;
            font-size: 12px;
            color: #666;
        }
        .think-tag-collapsed:hover {
            background-color: #e8e8e8;
        }
        .log-detail-view {
            display: none;
        }
        .log-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .back-button {
            background: #4169e1;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .back-button:hover {
            background: #3558d1;
        }
        .log-detail-content {
            max-width: 800px;
            margin: 0 auto;
        }
        .log-detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .log-detail-section h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .log-detail-section pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: monospace;
            font-size: 14px;
        }
        .status-display {
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }
        .status-display .status-indicator {
            font-size: 16px;
            margin-right: 5px;
        }
        
        /* Error context styles */
        .error-context {
            background: #fff3f3;
            border: 1px solid #ffcdd2;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .error-context-item {
            margin-bottom: 15px;
        }
        
        .error-context-item:last-child {
            margin-bottom: 0;
        }
        
        .error-context-item strong {
            color: #d32f2f;
            display: block;
            margin-bottom: 5px;
        }
        
        .error-context-item pre {
            background: #fff;
            border: 1px solid #ffcdd2;
            border-radius: 3px;
            padding: 10px;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 12px;
            color: #333;
        }
        
        /* Conversation group styles */
        .conversation-group { 
            background: #f8f9fa; 
            border: 2px solid #e9ecef; 
            border-radius: 8px; 
            margin: 15px 0; 
            transition: all 0.3s ease;
        }
        .conversation-group:hover { 
            border-color: #4169e1; 
            box-shadow: 0 2px 8px rgba(65, 105, 225, 0.2);
        }
        .conversation-group.expanded { 
            border-color: #4169e1; 
            background: #ffffff;
        }
        .conversation-header { 
            padding: 15px; 
            cursor: pointer; 
            border-bottom: none;
            transition: background-color 0.2s;
        }
        .conversation-header:hover { 
            background: #f0f4ff; 
        }
        .conversation-group.expanded .conversation-header {
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
        }
        .conversation-title { 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .conversation-meta { 
            display: flex; 
            flex-wrap: wrap;
            gap: 15px;
            font-size: 12px; 
            color: #666; 
            margin-bottom: 8px;
        }
        .conversation-summary { 
            font-size: 14px; 
            color: #555; 
            font-style: italic;
            margin-top: 8px;
        }
        .conversation-entries { 
            padding: 0 15px 15px 15px; 
            display: none; 
        }
        .conversation-group.expanded .conversation-entries { 
            display: block; 
        }
        .thread-id-badge {
            background: #e8f4fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            font-weight: normal;
        }
        .conversation-stats {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #666;
        }
        .participants-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .participant-badge {
            background: #f0f8ff;
            color: #4169e1;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .models-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .model-badge {
            background: #f5f5f5;
            color: #666;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
        }
        .conversation-entry {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin: 10px 0;
            transition: all 0.2s;
        }
        .conversation-entry:hover {
            border-color: #4169e1;
            box-shadow: 0 1px 4px rgba(65, 105, 225, 0.15);
        }
        
        /* Loading animation for conversations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Add this enhanced loading animation CSS */
        .loading-animation 
        {
            display: inline-block;
            position: relative;
            font-size: 1.2em;
            height: 1.5em;
            width: 3em;
            text-align: center;
            font-family: monospace;
        }

        .loading-animation .dot 
        {
            display: inline-block;
            position: relative;
            width: 0.5em;
            height: 0.5em;
            margin: 0 0.1em;
            animation: dot-to-star 3s infinite;
            opacity: 0.8;
            transform-origin: center;
        }

        .loading-animation .dot:nth-child(1) 
        {
            animation-delay: 0s;
        }

        .loading-animation .dot:nth-child(2) 
        {
            animation-delay: 0.5s;
        }

        .loading-animation .dot:nth-child(3) 
        {
            animation-delay: 1s;
        }

        @keyframes dot-to-star 
        {
            0%, 100% 
            {
                content: ".";
                transform: translateY(0);
            }
            20% 
            {
                content: ".";
                transform: translateY(-10px);
            }
            30% 
            {
                content: "âœ§";
                transform: translateY(-15px) rotate(72deg);
            }
            40% 
            {
                content: "â˜…";
                transform: translateY(-15px) rotate(144deg);
            }
            50% 
            {
                content: "â˜…";
                transform: translateY(-15px) rotate(216deg);
            }
            60% 
            {
                content: "â˜…";
                transform: translateY(-15px) rotate(288deg);
            }
            70% 
            {
                content: "â˜…";
                transform: translateY(-15px) rotate(360deg);
            }
            80% 
            {
                content: ".";
                transform: translateY(0) scale(1.2);
            }
            90% 
            {
                content: ".";
                transform: translateY(0) scale(1);
            }
        }

        /* Conversation section styling with enhanced animation */
        .conversation-section {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
        }

        .conversation-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .filter-controls select, .filter-controls button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filter-controls button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-left: 10px;
        }

        .conversation-display {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            height: 500px;
        }

        .conversation-list, .conversation-details {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow-y: auto;
            padding: 15px;
            background-color: #fafafa;
        }

        .conversation-list {
            height: 100%;
        }

        .conversation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .conversation-item:hover {
            background-color: #f0f0f0;
        }

        .conversation-item.selected {
            background-color: #e0f7fa;
        }

        .conversation-item .meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .loading-animation-container {
            text-align: center;
            padding: 20px;
        }

        /* Enhanced message display for conversation details */
        .conversation-thread {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .thread-info {
            background-color: #f5f5f5;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        .thread-info h3 {
            margin: 0 0 10px 0;
        }

        .thread-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #555;
        }

        .conversation-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* iPhone-style message bubbles */
        .message {
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-self: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-bubble {
            background: #0084ff;
            color: white;
            border-top-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: #e5e5ea;
            color: black;
            border-top-left-radius: 4px;
        }

        .message-info {
            font-size: 11px;
            color: #8e8e93;
            margin-top: 4px;
            padding: 0 10px;
        }

        .message.user .message-info {
            text-align: right;
        }

        .message-meta {
            font-size: 10px;
            opacity: 0.8;
            margin-top: 4px;
        }

        .empty-message, .error-message {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        .error-message {
            color: #f44336;
        }
    </style>
    
    <!-- Template data as JSON to avoid linter conflicts -->
    <script type="application/json" id="system-roverseer-data">
        {
            "categorizedVoices": {{ categorized_voices | tojson }}
        }
    </script>
    
    <script>
        // Parse template data from JSON script
        var systemDataScript = document.getElementById('system-roverseer-data');
        var systemData = JSON.parse(systemDataScript.textContent);
        var categorizedVoices = systemData.categorizedVoices;
        
        function refreshPage() {
            window.location.reload();
        }
        function changeDate(logType) {
            var select = document.getElementById('date-select');
            var date = select.value;
            var url = '/system?log_type=' + logType + '&date=' + date;
            var sortBy = '{{ sort_by }}';
            if (sortBy) {
                url += '&sort_by=' + sortBy;
            }
            window.location.href = url;
        }
        function executeCommand(type, target) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Restarting...';
            
            fetch('/system/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `type=${type}&target=${encodeURIComponent(target)}`
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = data.message;
                statusDiv.className = `status-message ${data.status}`;
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = 'Error executing command: ' + error;
                statusDiv.className = 'status-message error';
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        function loadContainers() {
            fetch('/system/containers')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const containerList = document.getElementById('container-list');
                        containerList.innerHTML = data.containers.map(container => `
                            <div class="command-item">
                                <span>${container}</span>
                                <button onclick="executeCommand('container', '${container}')">Restart</button>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error loading containers:', error);
                });
        }
        function updateSetting(type, value) {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Updating...';
            
            fetch('/system/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `type=${type}&value=${encodeURIComponent(value)}`
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = data.message;
                statusDiv.className = `status-message ${data.status}`;
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                    if (data.status === 'success') {
                        // Update the current value display
                        const currentSpan = document.getElementById(`current-${type}`);
                        if (currentSpan) {
                            currentSpan.textContent = value;
                        }
                    }
                }, 3000);
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = 'Error updating setting: ' + error;
                statusDiv.className = 'status-message error';
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        function saveVoiceSetting() {
            const voiceSelect = document.getElementById('voice-select');
            const selectedVoice = voiceSelect.value;
            updateSetting('voice', selectedVoice);
        }
        
        function loadPersonalities() {
            fetch('/system/personalities')
                .then(response => {
                    console.log('Personality response status:', response.status);
                    console.log('Personality response headers:', response.headers.get('content-type'));
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    // Check if response is actually JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`Expected JSON, got: ${contentType}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    console.log('Personality data received:', data);
                    
                    if (data.status === 'success') {
                        const select = document.getElementById('personality-select');
                        const currentSpan = document.getElementById('current-personality');
                        
                        // Clear and populate select
                        select.innerHTML = '';
                        data.personalities.forEach(personality => {
                            const option = document.createElement('option');
                            option.value = personality.name;
                            option.textContent = `${personality.avatar_emoji} ${personality.name}`;
                            if (personality.name === data.current) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                        
                        // Update current display
                        currentSpan.textContent = data.current || 'None';
                        
                        // Load details for current personality
                        if (data.current) {
                            loadPersonalityDetails();
                        }
                        
                        console.log('âœ… Personalities loaded successfully');
                    } else {
                        throw new Error(data.message || 'Unknown error from API');
                    }
                })
                .catch(error => {
                    console.error('âŒ Error loading personalities:', error);
                    
                    // Show error in UI
                    const currentSpan = document.getElementById('current-personality');
                    currentSpan.textContent = 'Error loading';
                    currentSpan.style.color = '#dc3545';
                    
                    // Try to show helpful error message
                    if (error.message.includes('Unexpected token')) {
                        console.error('ðŸš¨ JSON parsing error - likely receiving HTML instead of JSON');
                    }
                });
        }
        
        function loadPersonalityDetails() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            if (!selectedName) {
                document.getElementById('personality-details').style.display = 'none';
                return;
            }
            
            // Find the selected personality in the options (has all the data)
            fetch('/system/personalities')
                .then(response => response.json())
                .then(data => {
                    const personality = data.personalities.find(p => p.name === selectedName);
                    if (personality) {
                        document.getElementById('personality-name').textContent = `${personality.avatar_emoji} ${personality.name}`;
                        document.getElementById('personality-description').textContent = personality.description;
                        document.getElementById('personality-voice').textContent = personality.voice_id;
                        document.getElementById('personality-model').textContent = personality.model_preference || 'System Default';
                        document.getElementById('personality-mini-model').textContent = personality.mini_model || 'None';
                        document.getElementById('personality-threshold').textContent = personality.mini_model_threshold || '1000';
                        document.getElementById('personality-details').style.display = 'block';
                        
                        // Show delete button only for custom personalities
                        const deleteSection = document.getElementById('custom-personality-actions');
                        if (personality.is_custom) {
                            deleteSection.style.display = 'block';
                        } else {
                            deleteSection.style.display = 'none';
                        }
                        
                        // Hide intro message for now (will show after switching)
                        document.getElementById('personality-intro').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error loading personality details:', error);
                });
        }
        
        function switchPersonality() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            if (!selectedName) {
                alert('Please select a personality');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Switching...';
            
            fetch('/system/personality/switch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `personality=${encodeURIComponent(selectedName)}`
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = data.message;
                statusDiv.className = `status-message ${data.status}`;
                
                if (data.status === 'success') {
                    // Update current personality display
                    document.getElementById('current-personality').textContent = selectedName;
                    
                    // Update voice if changed
                    if (data.voice) {
                        const voiceSelect = document.getElementById('voice-select');
                        if (voiceSelect) {
                            voiceSelect.value = data.voice;
                            document.getElementById('current-voice').textContent = data.voice;
                        }
                    }
                    
                    // Show intro message
                    if (data.intro) {
                        document.getElementById('intro-message').textContent = data.intro;
                        document.getElementById('personality-intro').style.display = 'block';
                    }
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = 'Error switching personality: ' + error;
                statusDiv.className = 'status-message error';
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        function saveConcurrentSetting() {
            const input = document.getElementById('concurrent-requests-input');
            const value = input.value;
            updateSetting('concurrent_requests', value);
        }
        
        function editPersonality() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            if (!selectedName) {
                alert('No personality selected');
                return;
            }
            
            // Find the selected personality data
            fetch('/system/personalities')
                .then(response => response.json())
                .then(data => {
                    const personality = data.personalities.find(p => p.name === selectedName);
                    if (personality && personality.is_custom) {
                        // Populate the form with current values
                        document.getElementById('new-personality-name').value = personality.name;
                        document.getElementById('new-personality-voice').value = personality.voice_id;
                        document.getElementById('new-personality-model').value = personality.model_preference || '';
                        document.getElementById('new-personality-mini-model').value = personality.mini_model || '';
                        document.getElementById('new-personality-threshold').value = personality.mini_model_threshold || 1000;
                        document.getElementById('new-personality-description').value = personality.description || '';
                        document.getElementById('new-personality-system').value = personality.system_message || '';
                        document.getElementById('new-personality-emoji').value = personality.avatar_emoji || 'ðŸ¤–';
                        
                        // Show current moods list when editing
                        document.getElementById('current-moods-list').style.display = 'block';
                        loadPersonalityMoodsForEdit();
                        
                        // Clear temp mood storage and reset form
                        tempMoodStorage = [];
                        resetMoodForm();
                        updateTempMoodsDisplay();
                        
                        // Show mood management section for editing
                        document.getElementById('personality-mood-section').style.display = 'block';
                        
                        // Make sure the add mood button is visible (not the form)
                        document.getElementById('add-mood-button-container').style.display = 'block';
                        document.getElementById('add-mood-form').style.display = 'none';
                        
                        // Change the button text and set editing mode
                        const createButton = document.querySelector('button[onclick="createPersonality()"]');
                        createButton.textContent = 'Update Personality';
                        createButton.setAttribute('data-editing', selectedName);
                        
                        // Scroll to the form
                        document.querySelector('#new-personality-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Update the section title
                        const sectionTitle = document.getElementById('create-personality-title');
                        if (sectionTitle) {
                            sectionTitle.textContent = 'âœï¸ Edit Personality';
                        }
                        
                        console.log('Editing personality:', selectedName);
                    }
                })
                .catch(error => {
                    console.error('Error loading personality for editing:', error);
                    alert('Error loading personality data');
                });
        }
        
        function createPersonality() {
            const name = document.getElementById('new-personality-name').value.trim();
            const voice = document.getElementById('new-personality-voice').value;
            const model = document.getElementById('new-personality-model').value;
            const miniModel = document.getElementById('new-personality-mini-model').value;
            const threshold = parseInt(document.getElementById('new-personality-threshold').value) || 1000;
            const description = document.getElementById('new-personality-description').value.trim();
            const systemMessage = document.getElementById('new-personality-system').value.trim();
            const emoji = document.getElementById('new-personality-emoji').value.trim() || 'ðŸ¤–';
            
            if (!name) {
                alert('Please enter a personality name');
                return;
            }
            
            if (!systemMessage) {
                alert('Please enter a system message');
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            const isEditing = button.getAttribute('data-editing');
            
            button.disabled = true;
            button.textContent = isEditing ? 'Updating...' : 'Creating...';
            
            const url = isEditing ? '/system/personality/update' : '/system/personality/create';
            const requestData = {
                name: name,
                voice_id: voice,
                model_preference: model || null,
                mini_model: miniModel || null,
                mini_model_threshold: threshold,
                description: description,
                system_message: systemMessage,
                avatar_emoji: emoji
            };
            
            if (isEditing) {
                requestData.old_name = isEditing;
            }
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = data.message;
                statusDiv.className = `status-message ${data.status}`;
                
                if (data.status === 'success') {
                    // Save temporary moods if any exist - WAIT for personality creation first
                    if (tempMoodStorage.length > 0) {
                        const finalPersonalityName = isEditing ? name : name;
                        console.log('About to save moods for:', finalPersonalityName);
                        
                        // Save moods AFTER successful personality creation
                        saveTempMoodsToPersonality(finalPersonalityName)
                            .then(success => {
                                if (success) {
                                    console.log('Moods saved successfully');
                                } else {
                                    console.log('Some moods failed to save');
                                }
                                
                                // Clean up after mood saving (success or failure)
                                tempMoodStorage = [];
                                updateTempMoodsDisplay();
                            })
                            .catch(error => {
                                console.error('Error in mood saving process:', error);
                                tempMoodStorage = [];
                                updateTempMoodsDisplay();
                            });
                    }
                    
                    // Clear form
                    document.getElementById('new-personality-name').value = '';
                    document.getElementById('new-personality-description').value = '';
                    document.getElementById('new-personality-system').value = '';
                    document.getElementById('new-personality-emoji').value = 'ðŸ¤–';
                    document.getElementById('new-personality-mini-model').value = '';
                    document.getElementById('new-personality-threshold').value = '1000';
                    
                    // Reset mood form and hide section
                    resetMoodForm();
                    document.getElementById('current-moods-list').style.display = 'none';
                    document.getElementById('personality-mood-section').style.display = 'none';
                    
                    // Reset button
                    button.removeAttribute('data-editing');
                    button.textContent = 'Create Personality';
                    
                    // Reset section title
                    const sectionTitle = document.getElementById('create-personality-title');
                    if (sectionTitle) {
                        sectionTitle.textContent = 'âž• Create New Personality';
                    }
                    
                    // Reload personalities
                    loadPersonalities();
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = `Error ${isEditing ? 'updating' : 'creating'} personality: ` + error;
                statusDiv.className = 'status-message error';
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        function deletePersonality() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            if (!selectedName) {
                alert('No personality selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete the personality "${selectedName}"? This action cannot be undone.`)) {
                return;
            }
            
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Deleting...';
            
            fetch('/system/personality/delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: selectedName
                })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = data.message;
                statusDiv.className = `status-message ${data.status}`;
                
                if (data.status === 'success') {
                    // Hide details section
                    document.getElementById('personality-details').style.display = 'none';
                    
                    // Reload personalities
                    loadPersonalities();
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = 'Error deleting personality: ' + error;
                statusDiv.className = 'status-message error';
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = originalText;
            });
        }
        
        function toggleLogEntry(entryId) {
            const entry = document.getElementById('log-'+entryId);
            if (entry) {
                entry.classList.toggle('expanded');
            }
        }
        
        function togglePreview(entryId) {
            const preview = document.getElementById('preview-' + entryId);
            if (preview) {
                preview.classList.toggle('expanded');
            }
        }
        
        function playLogEntry(event, entryId) {
            // Prevent event bubbling more aggressively
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const button = event ? event.target : document.querySelector(`#log-${entryId} .play-button`);
            const text = button.getAttribute('data-text');
            const voice = button.getAttribute('data-voice');
            
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'Playing<span class="loading"></span>';
            
            // Use the existing /tts endpoint
            fetch('/tts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    voice: voice || 'en_US-GlaDOS',
                    speak: false  // We want the file returned
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
                button.innerHTML = 'Playing...';
                audio.addEventListener('ended', () => {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                });
                audio.addEventListener('error', () => {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    alert('Error playing audio');
                });
            })
            .catch(error => {
                console.error('Error playing TTS:', error);
                button.disabled = false;
                button.innerHTML = originalContent;
                alert('Error generating audio: ' + error);
            });
            
            return false;  // Extra prevention of event bubbling
        }
        
        function playDetailAudio(button) {
            const text = button.getAttribute('data-text');
            const voice = button.getAttribute('data-voice');
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'Playing<span class="loading"></span>';
            
            // Use the existing /tts endpoint
            fetch('/tts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: text,
                    voice: voice || 'en_US-GlaDOS',
                    speak: false  // We want the file returned
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
                button.innerHTML = 'Playing...';
                audio.addEventListener('ended', () => {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                });
                audio.addEventListener('error', () => {
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    alert('Error playing audio');
                });
            })
            .catch(error => {
                console.error('Error playing TTS:', error);
                button.disabled = false;
                button.innerHTML = originalContent;
                alert('Error generating audio: ' + error);
            });
        }
        
        function processThinkTags(text) {
            // Process <think> tags to make them collapsible
            return text.replace(/<think>([\s\S]*?)<\/think>/g, function(match, content) {
                const id = 'think-' + Math.random().toString(36).substr(2, 9);
                return `
                    <span class="think-tag-collapsed" onclick="toggleThink('${id}')">[Click to show AI thinking]</span>
                    <div id="${id}" class="think-tag" style="display: none;">
                        ${content}
                    </div>
                `;
            });
        }
        
        function toggleThink(id) {
            const element = document.getElementById(id);
            const toggle = element.previousElementSibling;
            if (element.style.display === 'none') {
                element.style.display = 'block';
                toggle.textContent = '[Click to hide AI thinking]';
            } else {
                element.style.display = 'none';
                toggle.textContent = '[Click to show AI thinking]';
            }
        }
        
        function showLogDetailById(entryElement) {
            // Get all the data from the log entry element
            const entryDiv = entryElement.closest('.log-entry');
            if (!entryDiv) {
                console.error('Could not find log entry div');
                return;
            }
            
            const entryType = entryDiv.getAttribute('data-type');
            const entryId = entryDiv.id.replace('log-', '');
            
            // Build entry object from DOM data
            const entry = {
                type: entryType,
                id: entryId
            };
            
            try {
                // Extract common data
                const metaElement = entryDiv.querySelector('.log-entry-meta');
                if (metaElement) {
                    const metaText = metaElement.textContent;
                    entry.timestamp = metaText.split(' - ')[0];
                    const runtimeMatch = metaText.match(/([\d.]+)s/);
                    if (runtimeMatch) {
                        entry.runtime = parseFloat(runtimeMatch[1]);
                        entry.processing_time = entry.runtime;
                        entry.total_time = entry.runtime;
                    }
                }
                
                // Extract data based on entry type
                if (entryType === 'llm_usage') {
                    const detailsDiv = entryDiv.querySelector('.log-entry-details');
                    entry.model = entryDiv.querySelector('.log-entry-summary strong').textContent;
                    const personalitySpan = entryDiv.querySelector('.log-entry-summary span[style*="color: #666"]');
                    if (personalitySpan) {
                        entry.personality = personalitySpan.textContent.replace(/[()]/g, '');
                    }
                    
                    // Get text content from paragraphs
                    const paragraphs = detailsDiv.querySelectorAll('p');
                    paragraphs.forEach(p => {
                        const text = p.textContent;
                        if (text.startsWith('User:')) {
                            entry.user_prompt = text.substring(6).trim();
                        } else if (text.startsWith('System:')) {
                            entry.system_message = text.substring(8).trim();
                        } else if (text.startsWith('Reply:')) {
                            const replySpan = p.querySelector('span');
                            entry.llm_reply = replySpan ? replySpan.textContent : text.substring(7).trim();
                        } else if (text.startsWith('Voice:')) {
                            entry.voice_id = text.substring(7).trim();
                        }
                    });
                } else if (entryType === 'tts_usage') {
                    entry.voice_id = entryDiv.querySelector('.log-entry-summary strong').textContent.replace('TTS: ', '');
                    const textP = entryDiv.querySelector('.log-entry-details p');
                    if (textP) {
                        entry.text = textP.textContent.replace('Text: ', '');
                    }
                } else if (entryType === 'asr_usage') {
                    const textP = entryDiv.querySelector('.log-entry-details p');
                    if (textP) {
                        entry.text = textP.textContent.replace('Text: ', '');
                    }
                } else if (entryType === 'penphin_mind') {
                    const paragraphs = entryDiv.querySelectorAll('.log-entry-details p');
                    paragraphs.forEach(p => {
                        const text = p.textContent;
                        if (text.startsWith('Prompt:')) {
                            entry.original_prompt = text.substring(8).trim();
                        } else if (text.startsWith('Logical:')) {
                            entry.logical_response = text.substring(9).trim();
                        } else if (text.startsWith('Creative:')) {
                            entry.creative_response = text.substring(10).trim();
                        } else if (text.startsWith('Final:')) {
                            entry.final_synthesis = text.substring(7).trim();
                        }
                    });
                } else if (entryType === 'errors') {
                    const errorTypeElement = entryDiv.querySelector('.log-entry-summary strong');
                    if (errorTypeElement) {
                        entry.error_type = errorTypeElement.textContent.replace('Error: ', '');
                    }
                    
                    const paragraphs = entryDiv.querySelectorAll('.log-entry-details p');
                    entry.context = {};
                    paragraphs.forEach(p => {
                        const text = p.textContent;
                        if (text.startsWith('Message:')) {
                            entry.message = text.substring(9).trim();
                        } else if (text.includes(':') && !text.startsWith('Context:')) {
                            const [key, value] = text.split(':', 2);
                            entry.context[key.trim()] = value.trim();
                        }
                    });
                }
                
                // Show the detail view
                showLogDetail(entry);
            } catch (error) {
                console.error('Error extracting log data:', error);
                alert('Error displaying log details. Check console for details.');
            }
        }
        
        function showLogDetail(entry) {
            // Save current main content
            const mainContent = document.querySelector('.main-content');
            if (!mainContent.hasAttribute('data-original-content')) {
                mainContent.setAttribute('data-original-content', mainContent.innerHTML);
            }
            
            let html = '';
            
            if (entry.type === 'llm_usage') {
                // Build mood details section
                let moodDetailsHtml = '';
                if (entry.mood_data && Object.keys(entry.mood_data).length > 0) {
                    const moodData = entry.mood_data;
                    
                    moodDetailsHtml = `
                        <div class="log-detail-section">
                            <h4>ðŸ§  Mood System Details</h4>
                            <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <p><strong>Context Triggers Detected:</strong> ${(moodData.context_triggers_detected || []).join(', ') || 'None'}</p>
                                <p><strong>Total Moods Available:</strong> ${moodData.total_moods_available || 0}</p>
                                <p><strong>Moods Activated:</strong> ${(moodData.moods_activated || []).join(', ') || 'None'}</p>
                                
                                ${moodData.activation_summary ? `
                                    <div style="margin-top: 10px;">
                                        <strong>Activation Summary:</strong>
                                        <ul style="margin: 5px 0;">
                                            <li>Triggered: ${moodData.activation_summary.triggered_moods || 0}/${moodData.activation_summary.total_moods || 0}</li>
                                            <li>Activated: ${moodData.activation_summary.activated_moods || 0}</li>
                                            <li>Success Rate: ${((moodData.activation_summary.activation_rate || 0) * 100).toFixed(1)}%</li>
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${moodData.moods_checked && moodData.moods_checked.length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <h5>ðŸ“Š Detailed Mood Probabilities</h5>
                                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                                        ${moodData.moods_checked.map(mood => `
                                            <div style="margin-bottom: 15px; padding: 10px; background: ${mood.activated ? '#e8f5e8' : mood.triggered ? '#fff8e1' : '#f5f5f5'}; border-radius: 5px;">
                                                <div style="font-weight: bold; color: ${mood.activated ? '#2e7d32' : mood.triggered ? '#f57c00' : '#666'};">
                                                    ${mood.mood_name} ${mood.activated ? 'âœ…' : mood.triggered ? 'âš¡' : 'ðŸ’¤'}
                                                </div>
                                                <div style="font-size: 12px; margin-top: 5px;">
                                                    <div>Probability: <strong>${(mood.trigger_probability * 100).toFixed(1)}%</strong></div>
                                                    <div>Triggers: ${(mood.context_triggers || []).join(', ')}</div>
                                                    ${mood.matching_triggers ? `<div style="color: #f57c00;">Matched: ${mood.matching_triggers.join(', ')}</div>` : ''}
                                                    ${mood.activation_roll !== undefined ? `<div>Roll: ${(mood.activation_roll * 100).toFixed(1)}% ${mood.activated ? '(Success)' : '(Failed)'}</div>` : ''}
                                                    ${mood.selected_influence ? `<div style="margin-top: 5px; font-style: italic; color: #2e7d32;">"${mood.selected_influence.text.substring(0, 80)}${mood.selected_influence.text.length > 80 ? '...' : ''}"</div>` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }
                
                // Build tag information section
                let tagInfoHtml = '';
                if (entry.has_tags) {
                    tagInfoHtml = `
                        <div class="log-detail-section">
                            <h4>ðŸ·ï¸ Response Tags</h4>
                            <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0;">
                                ${entry.extracted_personality ? `<p><strong>&lt;personality&gt;</strong> ${entry.extracted_personality}</p>` : ''}
                                ${entry.extracted_mood ? `
                                    <p><strong>&lt;mood&gt;</strong></p>
                                    <pre style="font-size: 11px; margin: 5px 0; padding: 5px; background: white; border-radius: 3px;">${JSON.stringify(entry.extracted_mood, null, 2)}</pre>
                                ` : ''}
                                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                                    ðŸ’¡ These tags are automatically added for log analysis and are not shown to users
                                </p>
                            </div>
                        </div>
                    `;
                }
                
                html = `
                    <div class="log-detail-header">
                        <h2>LLM Usage Log Entry</h2>
                        <button class="back-button" onclick="hideLogDetail()">â† Back to Logs</button>
                    </div>
                    <div class="log-detail-section">
                        <h4>Metadata</h4>
                        <p><strong>Timestamp:</strong> ${entry.timestamp}</p>
                        <p><strong>Model:</strong> ${entry.model}</p>
                        <p><strong>Personality:</strong> ${entry.personality}</p>
                        <p><strong>Runtime:</strong> ${entry.runtime.toFixed(2)} seconds</p>
                        ${entry.voice_id ? `<p><strong>Voice:</strong> ${entry.voice_id}</p>` : ''}
                    </div>
                    ${tagInfoHtml}
                    ${moodDetailsHtml}
                    <div class="log-detail-section">
                        <h4>User Prompt</h4>
                        <pre>${entry.user_prompt}</pre>
                    </div>
                    <div class="log-detail-section">
                        <h4>System Message</h4>
                        <pre>${entry.system_message}</pre>
                    </div>
                    <div class="log-detail-section">
                        <h4>LLM Response</h4>
                        <pre>${entry.llm_reply}</pre>
                    </div>
                `;
            } else if (entry.type === 'tts_usage') {
                html = `
                    <div class="log-detail-header">
                        <h2>TTS Usage Log Entry</h2>
                        <button class="back-button" onclick="hideLogDetail()">â† Back to Logs</button>
                    </div>
                    <div class="log-detail-section">
                        <h4>Metadata</h4>
                        <p><strong>Timestamp:</strong> ${entry.timestamp}</p>
                        <p><strong>Voice:</strong> ${entry.voice_id}</p>
                        <p><strong>Processing Time:</strong> ${entry.processing_time.toFixed(2)} seconds</p>
                    </div>
                    <div class="log-detail-section">
                        <h4>Text</h4>
                        <pre>${entry.text}</pre>
                    </div>
                `;
            } else if (entry.type === 'asr_usage') {
                html = `
                    <div class="log-detail-header">
                        <h2>ASR Usage Log Entry</h2>
                        <button class="back-button" onclick="hideLogDetail()">â† Back to Logs</button>
                    </div>
                    <div class="log-detail-section">
                        <h4>Metadata</h4>
                        <p><strong>Timestamp:</strong> ${entry.timestamp}</p>
                        <p><strong>Processing Time:</strong> ${entry.processing_time.toFixed(2)} seconds</p>
                    </div>
                    <div class="log-detail-section">
                        <h4>Transcribed Text</h4>
                        <pre>${entry.text}</pre>
                    </div>
                `;
            }
            
            // Replace main content with detail view
            mainContent.innerHTML = html;
        }
        
        function hideLogDetail() {
            const mainContent = document.querySelector('.main-content');
            const originalContent = mainContent.getAttribute('data-original-content');
            if (originalContent) {
                mainContent.innerHTML = originalContent;
                mainContent.removeAttribute('data-original-content');
            }
        }
        
        function refreshStatus() {
            fetch('/status_only')
                .then(response => response.json())
                .then(data => {
                    if (data.ai_pipeline) {
                        const statusSpan = document.getElementById('roverseer-status');
                        let statusHtml = `<span class="status-indicator">${data.ai_pipeline.status}</span>`;
                        statusHtml += 'RoverSeer';
                        
                        if (data.ai_pipeline.activity !== 'idle') {
                            statusHtml += ` - ${data.ai_pipeline.activity}`;
                        }
                        
                        if (data.ai_pipeline.detail) {
                            statusHtml += ` (${data.ai_pipeline.detail})`;
                        }
                        
                        if (data.ai_pipeline.requests) {
                            statusHtml += ` [${data.ai_pipeline.requests}]`;
                        }
                        
                        statusSpan.innerHTML = statusHtml;
                    }
                })
                .catch(error => {
                    console.error('Error refreshing status:', error);
                    document.getElementById('roverseer-status').innerHTML = 'âš ï¸ Status unavailable';
                });
        }
        
        function previewVoice() {
            const voiceSelect = document.getElementById('new-personality-voice');
            const selectedVoice = voiceSelect.value;
            const nameInput = document.getElementById('new-personality-name');
            const personalityName = nameInput.value.trim();
            const button = event.target;
            
            if (!selectedVoice) {
                alert('Please select a voice first');
                return;
            }
            
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = 'Playing<span class="loading"></span>';
            
            // Sample text for voice preview - personalized if name is entered
            let sampleText;
            if (personalityName) {
                sampleText = `Hello! I'm ${personalityName}. This is how I sound. I'm looking forward to being your assistant.`;
            } else {
                sampleText = "Hello! This is how I sound. I'm looking forward to being your assistant.";
            }
            
            fetch('/tts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: sampleText,
                    voice: selectedVoice,
                    speak: false  // We want the file returned
                })
            })
            .then(response => response.blob())
            .then(blob => {
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
                button.innerHTML = 'Playing...';
                audio.addEventListener('ended', () => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                });
                audio.addEventListener('error', () => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                    alert('Error playing audio');
                });
            })
            .catch(error => {
                console.error('Error playing voice preview:', error);
                button.disabled = false;
                button.innerHTML = originalText;
                alert('Error generating voice preview: ' + error);
            });
        }
        
        // Load containers when page loads
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('container-list')) {
                loadContainers();
            }
            
            // Load personalities if on settings page
            if (document.getElementById('personality-select')) {
                loadPersonalities();
            }
            
            // Load voice training components if on voice training page
            if (document.getElementById('training-status-display')) {
                initializeVoiceTraining();
            }
            
            // Show mood section when starting personality creation
            const personalityNameInput = document.getElementById('new-personality-name');
            if (personalityNameInput) {
                personalityNameInput.addEventListener('focus', function() {
                    // Mood section is now shown only when "Add Contextual Mood" button is clicked
                    // No longer automatically showing mood section on name field focus
                    /*
                    const moodSection = document.getElementById('personality-mood-section');
                    if (moodSection && moodSection.style.display === 'none') {
                        moodSection.style.display = 'block';
                        // Don't show current moods list for new personalities
                        document.getElementById('current-moods-list').style.display = 'none';
                    }
                    */
                });
            }
            
            // Initial status load
            refreshStatus();
            
            // Auto-refresh status every 5 seconds
            setInterval(refreshStatus, 5000);
        });
        
        // ======= NEURAL VOICE TRAINING FUNCTIONS =======
        
        function initializeVoiceTraining() {
            refreshTrainingStatus();
            refreshAvailableVoices();
            refreshVoiceRegistry();
            
            // Auto-refresh training status every 10 seconds when on training page
            setInterval(function() {
                if (document.getElementById('training-status-display')) {
                    refreshTrainingStatus();
                }
            }, 10000);
        }
        
        function refreshTrainingStatus() {
            fetch('/train-status')
                .then(response => response.json())
                .then(data => {
                    const statusText = document.getElementById('training-status-text');
                    const logSection = document.getElementById('training-log-section');
                    const logDiv = document.getElementById('training-log');
                    const cancelBtn = document.getElementById('cancel-training-btn');
                    const progressDiv = document.getElementById('training-progress');
                    
                    if (data.status === 'neural_synthesis_active') {
                        statusText.innerHTML = `ðŸ§  <strong>Neural Training Active:</strong> ${data.voice_identity}`;
                        statusText.style.color = '#28a745';
                        
                        // Show training log
                        logSection.style.display = 'block';
                        logDiv.textContent = data.neural_log || 'Neural pathway initialization...';
                        logDiv.scrollTop = logDiv.scrollHeight; // Auto-scroll to bottom
                        
                        // Show cancel button
                        cancelBtn.style.display = 'inline-block';
                        
                        // Show progress with percentage from backend
                        progressDiv.style.display = 'block';
                        const progress = data.progress_percentage || 0;
                        document.getElementById('progress-bar').style.width = progress + '%';
                        
                        // Enhanced progress text with percentage
                        let progressText = `Neural synthesis in progress... ${progress}%`;
                        if (data.log_length) {
                            progressText += ` (${data.log_length} training events)`;
                        }
                        document.getElementById('progress-text').textContent = progressText;
                        
                        // Disable start training
                        document.getElementById('start-training-btn').disabled = true;
                        document.getElementById('start-training-btn').textContent = 'ðŸ§  Neural Synthesis Active...';
                        
                    } else if (data.status === 'neural_pathway_idle') {
                        statusText.innerHTML = 'ðŸ”µ <strong>Neural Pathways Idle:</strong> Ready for voice synthesis';
                        statusText.style.color = '#6c757d';
                        
                        // Hide training log and progress
                        logSection.style.display = 'none';
                        cancelBtn.style.display = 'none';
                        progressDiv.style.display = 'none';
                        
                        // Enable start training
                        document.getElementById('start-training-btn').disabled = false;
                        document.getElementById('start-training-btn').textContent = 'ðŸ§  Start Neural Voice Training';
                        
                    } else {
                        // Handle other statuses (errors, etc.)
                        statusText.innerHTML = `âš ï¸ <strong>Status:</strong> ${data.message || data.status}`;
                        statusText.style.color = '#ffc107';
                        
                        // Hide training controls
                        logSection.style.display = 'none';
                        cancelBtn.style.display = 'none';
                        progressDiv.style.display = 'none';
                        
                        // Enable start training
                        document.getElementById('start-training-btn').disabled = false;
                        document.getElementById('start-training-btn').textContent = 'ðŸ§  Start Neural Voice Training';
                    }
                })
                .catch(error => {
                    console.error('Error fetching training status:', error);
                    document.getElementById('training-status-text').innerHTML = 'âŒ <strong>Neural Status Error:</strong> Connection failed';
                    document.getElementById('training-status-text').style.color = '#dc3545';
                });
        }
        
        function refreshAvailableVoices() {
            fetch('/available-voices')
                .then(response => response.json())
                .then(data => {
                    const voicesList = document.getElementById('available-voices-list');
                    const voiceSelect = document.getElementById('training-voice-select');
                    
                    // Clear existing options (except first placeholder)
                    voiceSelect.innerHTML = '<option value="">Select a voice...</option>';
                    
                    if (data.voices && data.voices.length > 0) {
                        let voicesHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">';
                        
                        data.voices.forEach(voice => {
                            // Add to list display
                            voicesHtml += `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #28a745;">
                                    <strong>ðŸ“ ${voice.name}</strong><br>
                                    <small style="color: #666;">${voice.audio_count} audio files</small><br>
                                    <small style="color: #999; font-family: monospace;">${voice.path}</small>
                                </div>
                            `;
                            
                            // Add to select dropdown
                            const option = document.createElement('option');
                            option.value = voice.name;
                            option.textContent = `${voice.name} (${voice.audio_count} files)`;
                            voiceSelect.appendChild(option);
                        });
                        
                        voicesHtml += '</div>';
                        voicesList.innerHTML = voicesHtml;
                        
                    } else {
                        voicesList.innerHTML = '<p style="color: #666; font-style: italic;">No voice sample directories found. Please add voice samples to /home/codemusic/texty/voice_data/</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching available voices:', error);
                    document.getElementById('available-voices-list').innerHTML = '<p style="color: #dc3545;">Error loading voice samples: ' + error + '</p>';
                });
        }
        
        function refreshVoiceRegistry() {
            fetch('/voice-registry')
                .then(response => response.json())
                .then(data => {
                    const registryDiv = document.getElementById('voice-registry');
                    
                    if (data.registry && Object.keys(data.registry).length > 0) {
                        let registryHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;">';
                        
                        for (const [voiceName, voiceData] of Object.entries(data.registry)) {
                            const statusColor = voiceData.last_status === 'training_started' ? '#28a745' : 
                                              voiceData.last_status === 'training_cancelled' ? '#dc3545' : '#6c757d';
                            
                            registryHtml += `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid ${statusColor};">
                                    <strong>ðŸŽ¤ ${voiceName}</strong><br>
                                    <small style="color: #666;">Status: ${voiceData.last_status}</small><br>
                                    <small style="color: #999;">Updated: ${new Date(voiceData.last_update).toLocaleString()}</small>
                                </div>
                            `;
                        }
                        
                        registryHtml += '</div>';
                        registryDiv.innerHTML = registryHtml;
                        
                    } else {
                        registryDiv.innerHTML = '<p style="color: #666; font-style: italic;">No voice training history found.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching voice registry:', error);
                    document.getElementById('voice-registry').innerHTML = '<p style="color: #dc3545;">Error loading voice registry: ' + error + '</p>';
                });
        }
        
        function startVoiceTraining() {
            const voiceSelect = document.getElementById('training-voice-select');
            const selectedVoice = voiceSelect.value;
            
            if (!selectedVoice) {
                alert('Please select a voice to train from the dropdown.');
                return;
            }
            
            if (!confirm(`Start neural voice training for "${selectedVoice}"?\n\nThis process will take 30-60 minutes and cannot be paused.\n\nProceed?`)) {
                return;
            }
            
            const startBtn = document.getElementById('start-training-btn');
            const originalText = startBtn.textContent;
            
            startBtn.disabled = true;
            startBtn.textContent = 'ðŸš€ Initiating Neural Synthesis...';
            
            fetch('/train-voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    voice_name: selectedVoice
                })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('training-status-message');
                
                if (data.status === 'neural_synthesis_initiated') {
                    statusDiv.textContent = `Neural voice synthesis started for ${data.voice_identity}. Training process will take 30-60 minutes.`;
                    statusDiv.className = 'status-message success';
                    
                    // Refresh status immediately
                    setTimeout(refreshTrainingStatus, 2000);
                    
                } else {
                    statusDiv.textContent = data.message || 'Failed to start training';
                    statusDiv.className = 'status-message error';
                    
                    // Re-enable button
                    startBtn.disabled = false;
                    startBtn.textContent = originalText;
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 10000);
            })
            .catch(error => {
                console.error('Error starting training:', error);
                
                const statusDiv = document.getElementById('training-status-message');
                statusDiv.textContent = 'Error starting training: ' + error;
                statusDiv.className = 'status-message error';
                
                // Re-enable button
                startBtn.disabled = false;
                startBtn.textContent = originalText;
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 10000);
            });
        }
        
        function cancelTraining() {
            if (!confirm('Cancel the current voice training process?\n\nAll progress will be lost and cannot be recovered.\n\nProceed?')) {
                return;
            }
            
            const cancelBtn = document.getElementById('cancel-training-btn');
            const originalText = cancelBtn.textContent;
            
            cancelBtn.disabled = true;
            cancelBtn.textContent = 'ðŸ›‘ Terminating...';
            
            fetch('/cancel-training', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('training-status-message');
                statusDiv.textContent = data.message || 'Training cancelled';
                statusDiv.className = 'status-message success';
                
                // Refresh status
                setTimeout(refreshTrainingStatus, 2000);
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                console.error('Error cancelling training:', error);
                
                const statusDiv = document.getElementById('training-status-message');
                statusDiv.textContent = 'Error cancelling training: ' + error;
                statusDiv.className = 'status-message error';
                
                cancelBtn.disabled = false;
                cancelBtn.textContent = originalText;
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            });
        }
        
        // Mood Management Functions
        let currentEditingMood = null;
        let moodInfluenceCounter = 0;
        
        function showMoodForm() {
            document.getElementById('add-mood-button-container').style.display = 'none';
            document.getElementById('add-mood-form').style.display = 'block';
        }
        
        function hideMoodForm() {
            document.getElementById('add-mood-form').style.display = 'none';
            document.getElementById('add-mood-button-container').style.display = 'block';
            resetMoodForm();
        }
        
        function loadPersonalityMoods() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            if (!selectedName) return;
            
            fetch(`/system/personality/${encodeURIComponent(selectedName)}/moods`)
                .then(response => response.json())
                .then(data => {
                    const moodsDisplay = document.getElementById('moods-display');
                    
                    if (data.status === 'success' && Object.keys(data.moods).length > 0) {
                        let html = '';
                        for (const [moodName, moodData] of Object.entries(data.moods)) {
                            html += `
                                <div style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 10px; background: #fafafa;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong>${moodName}</strong>
                                        <div>
                                            <button onclick="editMood('${moodName}')" style="background: #ffc107; color: black; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-right: 5px;">Edit</button>
                                            <button onclick="deleteMood('${moodName}')" style="background: #dc3545; color: white; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Delete</button>
                                        </div>
                                    </div>
                                    <div style="font-size: 11px; color: #666; margin-top: 5px;">
                                        <div>Probability: ${moodData.trigger_probability}</div>
                                        <div>Triggers: ${moodData.context_triggers.join(', ')}</div>
                                        <div>Influences: ${moodData.mood_influences.length} configured</div>
                                    </div>
                                </div>
                            `;
                        }
                        moodsDisplay.innerHTML = html;
                    } else {
                        moodsDisplay.innerHTML = '<em style="color: #666;">No moods configured yet</em>';
                    }
                })
                .catch(error => {
                    console.error('Error loading moods:', error);
                    document.getElementById('moods-display').innerHTML = '<em style="color: #f00;">Error loading moods</em>';
                });
        }
        
        // New mood management for personality creation/editing
        let tempMoodStorage = []; // Store moods temporarily during creation/editing
        
        function loadPersonalityMoodsForEdit() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            if (!selectedName) return;
            
            fetch(`/system/personality/${encodeURIComponent(selectedName)}/moods`)
                .then(response => response.json())
                .then(data => {
                    const moodsDisplay = document.getElementById('moods-display');
                    
                    if (data.status === 'success' && Object.keys(data.moods).length > 0) {
                        let html = '';
                        for (const [moodName, moodData] of Object.entries(data.moods)) {
                            html += `
                                <div style="border: 1px solid #ddd; border-radius: 5px; padding: 8px; margin-bottom: 8px; background: #fafafa;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="font-size: 13px;">${moodName}</strong>
                                        <div>
                                            <button onclick="editMoodFromPersonalityView('${moodName}')" style="background: #ffc107; color: black; border: none; padding: 2px 5px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-right: 3px;">Edit</button>
                                            <button onclick="deleteMoodFromEdit('${moodName}')" style="background: #dc3545; color: white; border: none; padding: 2px 5px; border-radius: 3px; cursor: pointer; font-size: 10px;">Delete</button>
                                        </div>
                                    </div>
                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">
                                        ${moodData.context_triggers.join(', ')} (${moodData.trigger_probability})
                                    </div>
                                </div>
                            `;
                        }
                        moodsDisplay.innerHTML = html;
                    } else {
                        moodsDisplay.innerHTML = '<em style="color: #666;">No moods configured yet</em>';
                    }
                })
                .catch(error => {
                    console.error('Error loading moods for edit:', error);
                });
        }
        
        function saveMoodToForm() {
            const moodName = document.getElementById('mood-name').value.trim();
            const probability = parseFloat(document.getElementById('mood-probability').value);
            const triggersText = document.getElementById('mood-triggers').value.trim();
            
            if (!moodName) {
                alert('Please enter a mood name');
                return;
            }
            
            if (!triggersText) {
                alert('Please enter at least one trigger');
                return;
            }
            
            // Parse triggers
            const triggers = triggersText.split(',').map(t => t.trim()).filter(t => t);
            
            // Collect trance words
            const tranceWords = [];
            const influenceItems = document.querySelectorAll('.mood-influence-item');
            influenceItems.forEach(item => {
                const textInput = item.querySelector('input[type="text"]');
                const weightInput = item.querySelector('input[type="number"]');
                const text = textInput.value.trim();
                const weight = parseFloat(weightInput.value) || 1.0;
                
                if (text) {
                    tranceWords.push({ text, weight });
                }
            });
            
            if (tranceWords.length === 0) {
                alert('Please add at least one trance word');
                return;
            }
            
            // Add to temporary storage
            const moodData = {
                mood_name: moodName,
                trigger_probability: probability,
                context_triggers: triggers,
                mood_influences: tranceWords
            };
            
            // Remove existing mood with same name if it exists
            tempMoodStorage = tempMoodStorage.filter(m => m.mood_name !== moodName);
            tempMoodStorage.push(moodData);
            
            // Update the display
            updateTempMoodsDisplay();
            
            // Clear the form
            resetMoodForm();
            
            showStatusMessage(`Mood "${moodName}" added to personality`, 'success');
        }
        
        function updateTempMoodsDisplay() {
            const tempMoodsList = document.getElementById('temp-moods-list');
            
            if (tempMoodStorage.length === 0) {
                tempMoodsList.innerHTML = '<em style="color: #666;">No moods configured yet. Add moods above to enhance this personality.</em>';
                return;
            }
            
            let html = '';
            tempMoodStorage.forEach((mood, index) => {
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 5px; padding: 8px; margin-bottom: 8px; background: #fff;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="font-size: 13px;">${mood.mood_name}</strong>
                            <div>
                                <button onclick="editTempMood(${index})" style="background: #ffc107; color: black; border: none; padding: 2px 5px; border-radius: 3px; cursor: pointer; font-size: 10px; margin-right: 3px;">Edit</button>
                                <button onclick="removeTempMood(${index})" style="background: #dc3545; color: white; border: none; padding: 2px 5px; border-radius: 3px; cursor: pointer; font-size: 10px;">Remove</button>
                            </div>
                        </div>
                        <div style="font-size: 10px; color: #666; margin-top: 3px;">
                            Triggers: ${mood.context_triggers.join(', ')} (${mood.trigger_probability})<br>
                            Trance Words: ${mood.mood_influences.map(tw => tw.text).join(', ')}
                        </div>
                    </div>
                `;
            });
            
            tempMoodsList.innerHTML = html;
        }
        
        function removeTempMood(index) {
            tempMoodStorage.splice(index, 1);
            updateTempMoodsDisplay();
        }
        
        function editTempMood(index) {
            const mood = tempMoodStorage[index];
            
            // Populate the form with the mood data
            document.getElementById('mood-name').value = mood.mood_name;
            document.getElementById('mood-probability').value = mood.trigger_probability;
            document.getElementById('mood-triggers').value = mood.context_triggers.join(', ');
            
            // Clear and populate trance words
            const influencesList = document.getElementById('mood-influences-list');
            influencesList.innerHTML = '';
            moodInfluenceCounter = 0;
            
            mood.mood_influences.forEach(influence => {
                addMoodInfluence(influence.text, influence.weight);
            });
            
            // Remove the mood from temp storage (will be re-added when saved)
            tempMoodStorage.splice(index, 1);
            updateTempMoodsDisplay();
            
            // Show the form
            showMoodForm();
        }
        
        function deleteMoodFromEdit(moodName) {
            if (!confirm(`Are you sure you want to delete the mood "${moodName}"? This action cannot be undone.`)) {
                return;
            }
            
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            fetch(`/system/personality/${encodeURIComponent(selectedName)}/moods/${encodeURIComponent(moodName)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadPersonalityMoodsForEdit(); // Refresh the display
                    showStatusMessage(data.message, 'success');
                } else {
                    showStatusMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting mood:', error);
                showStatusMessage('Error deleting mood: ' + error, 'error');
            });
        }
        
        function editMoodFromPersonalityView(moodName) {
            // Simply call the existing editMood function and ensure form visibility
            editMood(moodName);
            
            // Also ensure the mood form button container is hidden when editing
            document.getElementById('add-mood-button-container').style.display = 'none';
            
            showStatusMessage(`Editing mood "${moodName}"`, 'info');
        }
        
        function editMood(moodName) {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            fetch(`/system/personality/${encodeURIComponent(selectedName)}/moods`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.moods[moodName]) {
                        const mood = data.moods[moodName];
                        currentEditingMood = moodName;
                        
                        // Populate form
                        document.getElementById('mood-name').value = moodName;
                        document.getElementById('mood-probability').value = mood.trigger_probability;
                        document.getElementById('mood-triggers').value = mood.context_triggers.join(', ');
                        
                        // Clear and populate mood influences
                        const influencesList = document.getElementById('mood-influences-list');
                        influencesList.innerHTML = '';
                        moodInfluenceCounter = 0;
                        
                        mood.mood_influences.forEach(influence => {
                            addMoodInfluence(influence.text, influence.weight);
                        });
                        
                        document.getElementById('add-mood-form').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading mood for editing:', error);
                    alert('Error loading mood data');
                });
        }
        
        function deleteMood(moodName) {
            if (!confirm(`Are you sure you want to delete the mood "${moodName}"? This action cannot be undone.`)) {
                return;
            }
            
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            fetch(`/system/personality/${encodeURIComponent(selectedName)}/moods/${encodeURIComponent(moodName)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadPersonalityMoods(); // Refresh the display
                    showStatusMessage(data.message, 'success');
                } else {
                    showStatusMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting mood:', error);
                showStatusMessage('Error deleting mood: ' + error, 'error');
            });
        }
        
        function addMoodInfluence(text = '', weight = 1.0) {
            const influencesList = document.getElementById('mood-influences-list');
            const influenceId = ++moodInfluenceCounter;
            
            const influenceDiv = document.createElement('div');
            influenceDiv.className = 'mood-influence-item';
            influenceDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
            influenceDiv.innerHTML = `
                <input type="text" placeholder="e.g., 'Be creative', 'Focus on art', 'You feel inspired'..." value="${text}" 
                       style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;">
                <input type="number" value="${weight}" min="0.1" max="2.0" step="0.1" 
                       style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;" 
                       placeholder="Weight" title="Influence strength (0.1 - 2.0)">
                <button type="button" onclick="this.parentElement.remove()" 
                        style="background: #dc3545; color: white; border: none; padding: 4px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">Remove</button>
            `;
            
            influencesList.appendChild(influenceDiv);
        }
        
        function resetMoodForm() {
            document.getElementById('mood-name').value = '';
            document.getElementById('mood-probability').value = '0.7';
            document.getElementById('mood-triggers').value = '';
            document.getElementById('mood-influences-list').innerHTML = '';
            moodInfluenceCounter = 0;
        }
        
        function saveTempMoodsToPersonality(personalityName) {
            // Save all temporary moods to the personality
            if (tempMoodStorage.length === 0) {
                console.log('No temporary moods to save');
                return Promise.resolve();
            }
            
            console.log(`Saving ${tempMoodStorage.length} moods to ${personalityName}`);
            
            const promises = tempMoodStorage.map(mood => {
                console.log('Saving mood:', mood);
                return fetch(`/system/personality/${encodeURIComponent(personalityName)}/moods`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mood)
                });
            });
            
            return Promise.all(promises)
                .then(responses => {
                    // Check if all succeeded
                    const allSucceeded = responses.every(r => r.ok);
                    if (allSucceeded) {
                        console.log(`âœ… Successfully saved ${tempMoodStorage.length} moods to ${personalityName}`);
                        showStatusMessage(`Saved ${tempMoodStorage.length} moods to personality`, 'success');
                    } else {
                        console.warn('Some moods failed to save');
                        showStatusMessage('Some moods failed to save', 'error');
                    }
                    return allSucceeded;
                })
                .catch(error => {
                    console.error('Error saving temporary moods:', error);
                    showStatusMessage('Error saving moods: ' + error, 'error');
                    return false;
                });
        }
        
        function cancelMoodEdit() {
            document.getElementById('add-mood-form').style.display = 'none';
            resetMoodForm();
            currentEditingMood = null;
        }
        
        function saveMood() {
            const select = document.getElementById('personality-select');
            const selectedName = select.value;
            
            const moodName = document.getElementById('mood-name').value.trim();
            const probability = parseFloat(document.getElementById('mood-probability').value);
            const triggersText = document.getElementById('mood-triggers').value.trim();
            
            if (!moodName) {
                alert('Please enter a mood name');
                return;
            }
            
            if (!triggersText) {
                alert('Please enter at least one trigger');
                return;
            }
            
            // Parse triggers
            const triggers = triggersText.split(',').map(t => t.trim()).filter(t => t);
            
            // Collect mood influences
            const influences = [];
            const influenceItems = document.querySelectorAll('.mood-influence-item');
            influenceItems.forEach(item => {
                const textInput = item.querySelector('input[type="text"]');
                const weightInput = item.querySelector('input[type="number"]');
                const text = textInput.value.trim();
                const weight = parseFloat(weightInput.value) || 1.0;
                
                if (text) {
                    influences.push({ text, weight });
                }
            });
            
            if (influences.length === 0) {
                alert('Please add at least one mood influence');
                return;
            }
            
            const moodData = {
                mood_name: moodName,
                trigger_probability: probability,
                context_triggers: triggers,
                mood_influences: influences
            };
            
            const url = currentEditingMood ? 
                `/system/personality/${encodeURIComponent(selectedName)}/moods/${encodeURIComponent(currentEditingMood)}` :
                `/system/personality/${encodeURIComponent(selectedName)}/moods`;
            const method = currentEditingMood ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(moodData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    cancelMoodEdit();
                    loadPersonalityMoods(); // Refresh the display
                    showStatusMessage(data.message, 'success');
                } else {
                    showStatusMessage(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving mood:', error);
                showStatusMessage('Error saving mood: ' + error, 'error');
            });
        }
        
        function toggleMoodHelp() {
            const helpDiv = document.getElementById('mood-help');
            helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // Load containers when page loads
        
        // ======= CONVERSATION THREADING FUNCTIONS =======
        
        function loadConversations(date = null, logType = 'llm_usage') {
            // Show loading state
            const mainContent = document.querySelector('.main-content');
            const loadingHtml = `
                <h2>ðŸ’¬ Conversations</h2>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 20px auto;"></div>
                    Loading conversations...
                </div>
            `;
            mainContent.innerHTML = loadingHtml;
            
            // Build API URL with parameters
            let url = '/system/conversations';
            const params = new URLSearchParams();
            if (date) params.append('date', date);
            if (logType) params.append('type', logType);
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayConversations(data.conversations, data.date);
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    mainContent.innerHTML = `
                        <h2>ðŸ’¬ Conversations</h2>
                        <div style="color: #dc3545; text-align: center; padding: 40px;">
                            <strong>Error loading conversations:</strong> ${error.message}
                        </div>
                    `;
                });
        }
        
        function displayConversations(conversations, date) {
            const mainContent = document.querySelector('.main-content');
            
            if (!conversations || conversations.length === 0) {
                mainContent.innerHTML = `
                    <h2>ðŸ’¬ Conversations</h2>
                    <div class="log-info">
                        ðŸ“‹ Conversations are automatically grouped by thread ID. Each conversation thread starts when context is cleared or the system restarts.
                    </div>
                    <p class="no-logs">No conversations found for ${date || 'today'}</p>
                `;
                return;
            }
            
            let conversationsHtml = `
                <h2>ðŸ’¬ Conversations (${conversations.length})</h2>
                <div class="log-info">
                    ðŸ“‹ Conversations are automatically grouped by thread ID. Click any conversation to view its detailed exchanges.
                </div>
                <div class="conversations-container">
            `;
            
            conversations.forEach((conversation, index) => {
                const shortId = conversation.thread_id.substring(0, 8) + '...';
                const duration = calculateDuration(conversation.start_time, conversation.end_time);
                const safeThreadId = conversation.thread_id.replace(/[^a-zA-Z0-9]/g, '_'); // Safe ID for HTML elements
                
                conversationsHtml += `
                    <div class="conversation-group" id="conversation-${safeThreadId}">
                        <div class="conversation-header" onclick="toggleConversation('${conversation.thread_id}')">
                            <div class="conversation-title">
                                <span>ðŸ”— Conversation ${index + 1}</span>
                                <span class="thread-id-badge">${shortId}</span>
                            </div>
                            <div class="conversation-meta">
                                <span>â±ï¸ ${duration}</span>
                                <span>ðŸ’¬ ${conversation.message_count} messages</span>
                                <span>ðŸ“… ${formatTime(conversation.start_time)} - ${formatTime(conversation.end_time)}</span>
                            </div>
                            <div class="conversation-stats">
                                <div class="stat-item">
                                    <span>ðŸŽ­ Participants:</span>
                                    <div class="participants-list">
                                        ${conversation.participants.map(p => `<span class="participant-badge">${p}</span>`).join('')}
                                    </div>
                                </div>
                                <div class="stat-item">
                                    <span>ðŸ¤– Models:</span>
                                    <div class="models-list">
                                        ${conversation.models_used.map(m => `<span class="model-badge">${m}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="conversation-entries" id="entries-${safeThreadId}">
                            <div class="loading-placeholder" style="text-align: center; padding: 20px; color: #666;">
                                Loading conversation details...
                            </div>
                        </div>
                    </div>
                `;
            });
            
            conversationsHtml += '</div>';
            mainContent.innerHTML = conversationsHtml;
        }
        
        function toggleConversation(threadId) {
            const safeThreadId = threadId.replace(/[^a-zA-Z0-9]/g, '_'); // Convert to safe ID for DOM
            const conversationGroup = document.getElementById(`conversation-${safeThreadId}`);
            const entriesDiv = document.getElementById(`entries-${safeThreadId}`);
            
            if (conversationGroup.classList.contains('expanded')) {
                // Collapse
                conversationGroup.classList.remove('expanded');
            } else {
                // Expand and load details if not already loaded
                conversationGroup.classList.add('expanded');
                
                if (entriesDiv.querySelector('.loading-placeholder')) {
                    loadConversationDetails(threadId);
                }
            }
        }
        
        function loadConversationDetails(threadId) {
            const entriesDiv = document.getElementById(`entries-${threadId}`);
            
            fetch(`/system/conversation/${threadId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        entriesDiv.innerHTML = `<div style="color: #dc3545; padding: 15px;">Error: ${data.error}</div>`;
                        return;
                    }
                    
                    displayConversationEntries(data, entriesDiv);
                })
                .catch(error => {
                    console.error('Error loading conversation details:', error);
                    entriesDiv.innerHTML = `<div style="color: #dc3545; padding: 15px;">Error loading details: ${error.message}</div>`;
                });
        }
        
        function displayConversationEntries(conversation, entriesDiv) {
            if (!conversation.entries || conversation.entries.length === 0) {
                entriesDiv.innerHTML = '<div style="padding: 15px; color: #666;">No entries found in this conversation.</div>';
                return;
            }
            
            let entriesHtml = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #666;">
                    ðŸ“Š <strong>Thread Summary:</strong> ${conversation.total_entries} total entries, ${conversation.message_count} messages
                    from ${formatTime(conversation.start_time)} to ${formatTime(conversation.end_time)}
                </div>
            `;
            
            conversation.entries.forEach((entry, index) => {
                entriesHtml += `
                    <div class="conversation-entry log-entry" data-type="${entry.type}" onclick="toggleLogEntry('conv-${entry.type}-${index}')">
                        ${renderConversationEntry(entry, index)}
                    </div>
                `;
            });
            
            entriesDiv.innerHTML = entriesHtml;
        }
        
        function renderConversationEntry(entry, index) {
            const entryId = `conv-${entry.type}-${index}`;
            
            if (entry.type === 'llm_usage') {
                return `
                    <div class="log-entry-summary">
                        <div style="flex: 1;">
                            <div>
                                <strong>${entry.model}</strong> 
                                <span style="color: #666;">(${entry.personality})</span>
                                <span class="log-entry-meta">${formatTime(entry.timestamp)} - ${entry.runtime.toFixed(2)}s</span>
                                
                                ${entry.mood_data && entry.mood_data.moods_activated ? `
                                    <span title="Mood system activated: ${entry.mood_data.moods_activated.join(', ')}" style="background: #e8f5e8; color: #2e7d32; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">
                                        ðŸ§ ${entry.mood_data.moods_activated.length}
                                    </span>
                                ` : ''}
                                
                                ${entry.has_tags ? `
                                    <span title="Response contains personality/mood tags" style="background: #f0f8ff; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">
                                        ðŸ·ï¸
                                    </span>
                                ` : ''}
                            </div>
                            <div class="log-entry-preview">
                                ${entry.user_prompt.length > 80 ? 
                                    `User: "${entry.user_prompt.substring(0, 80)}..."` : 
                                    `User: "${entry.user_prompt}"`
                                }
                            </div>
                        </div>
                        <button class="play-button" data-text="${entry.llm_reply}" data-voice="${entry.voice_id || 'null'}" onclick="playLogEntry(event, '${entryId}'); return false;">Play</button>
                    </div>
                    <div class="log-entry-details" id="details-${entryId}">
                        <p><strong>User:</strong> ${entry.user_prompt}</p>
                        <p><strong>System:</strong> ${entry.system_message}</p>
                        <p><strong>Reply:</strong> ${entry.llm_reply}</p>
                        ${entry.voice_id ? `<p><strong>Voice:</strong> ${entry.voice_id}</p>` : ''}
                    </div>
                `;
            } else if (entry.type === 'penphin_mind') {
                return `
                    <div class="log-entry-summary">
                        <div style="flex: 1;">
                            <div>
                                <strong>ðŸ§  PenphinMind</strong>
                                <span class="log-entry-meta">${formatTime(entry.timestamp)} - ${entry.total_time.toFixed(2)}s</span>
                            </div>
                            <div class="log-entry-preview">
                                ${entry.original_prompt.length > 80 ? 
                                    `"${entry.original_prompt.substring(0, 80)}..."` : 
                                    `"${entry.original_prompt}"`
                                }
                            </div>
                        </div>
                    </div>
                    <div class="log-entry-details" id="details-${entryId}">
                        <p><strong>Prompt:</strong> ${entry.original_prompt}</p>
                        <p><strong>Logical:</strong> ${entry.logical_response}</p>
                        <p><strong>Creative:</strong> ${entry.creative_response}</p>
                        <p><strong>Final:</strong> ${entry.final_synthesis}</p>
                    </div>
                `;
            }
            
            return `<div class="log-entry-summary">Unknown entry type: ${entry.type}</div>`;
        }
        
        function calculateDuration(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            
            if (diffMs < 60000) {
                return `${Math.round(diffMs / 1000)}s`;
            } else if (diffMs < 3600000) {
                return `${Math.round(diffMs / 60000)}m`;
            } else {
                return `${Math.round(diffMs / 3600000)}h`;
            }
        }
        
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }
        
        // Handle conversation log type selection
        function handleLogTypeClick(logType) {
            if (logType === 'conversations') {
                // Store original content before switching to conversation view
                const mainContent = document.querySelector('.main-content');
                if (!mainContent.getAttribute('data-original-content')) {
                    mainContent.setAttribute('data-original-content', mainContent.innerHTML);
                }
                
                loadConversations();
                return false; // Prevent default link behavior
            }
            
            // For other log types, proceed normally
            return true;
        }
        
        // ======= END CONVERSATION THREADING FUNCTIONS =======

        function updateMaxRequests() {
            const maxRequests = document.getElementById('max-requests').value;
            
            fetch('/system/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'max_concurrent_requests': maxRequests
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showToast('Max concurrent requests updated');
                } else {
                    showToast('Error: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showToast('Error: ' + error, 'error');
            });
        }

        // Add streaming TTS toggle handler
        document.addEventListener('DOMContentLoaded', function() {
            const streamingTtsToggle = document.getElementById('streaming-tts');
            if (streamingTtsToggle) {
                streamingTtsToggle.addEventListener('change', function() {
                    fetch('/system/settings/streaming_tts', {
                        method: 'POST'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showToast(`Streaming TTS ${data.streaming_tts_enabled ? 'enabled' : 'disabled'}`);
                        } else {
                            showToast('Error: ' + data.message, 'error');
                            // Reset toggle to previous state
                            streamingTtsToggle.checked = !streamingTtsToggle.checked;
                        }
                    })
                    .catch(error => {
                        showToast('Error: ' + error, 'error');
                        // Reset toggle to previous state
                        streamingTtsToggle.checked = !streamingTtsToggle.checked;
                    });
                });
            }
        });

        // Conversation loading function with enhanced animation
        function loadConversationDetails(threadId, date) 
        {
            var detailsDiv = document.getElementById('conversation-details');
            
            // Show fancy loading animation
            detailsDiv.innerHTML = `
                <div class="loading-animation-container">
                    <span>Loading conversation details</span>
                    <span class="loading-animation">
                        <span class="dot" style="--index: 0;"></span>
                        <span class="dot" style="--index: 1;"></span>
                        <span class="dot" style="--index: 2;"></span>
                    </span>
                </div>
            `;
            
            // Build URL with date parameter if provided
            var url = '/system/conversation/' + threadId;
            if (date) {
                url += '?date=' + date;
            }
            
            // Add debug logging
            console.log('Loading conversation details from URL:', url);
            
            // Fetch conversation details with retry logic
            fetchWithRetry(url, {
                retries: 3,
                retryDelay: 1000
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Conversation details loaded:', data);
                
                if (!data || !data.entries || data.entries.length === 0) {
                    detailsDiv.innerHTML = '<div class="empty-message">No conversation details available</div>';
                    return;
                }
                
                // Format conversation details as a chat-like interface
                var html = '<div class="conversation-thread">';
                
                // Add thread information
                html += '<div class="thread-info">';
                html += '<h3>Conversation Thread: ' + data.thread_id + '</h3>';
                html += '<p>Started: ' + formatTimestamp(data.start_time) + '</p>';
                html += '<p>Messages: ' + data.entries.length + '</p>';
                
                if (data.participants && data.participants.length > 0) {
                    html += '<p>Participants: ' + data.participants.join(', ') + '</p>';
                }
                
                if (data.models_used && data.models_used.length > 0) {
                    html += '<p>Models: ' + data.models_used.join(', ') + '</p>';
                }
                
                html += '</div>';
                
                // Add the actual conversation
                html += '<div class="conversation-messages">';
                
                data.entries.forEach(function(entry, index) {
                    var role = entry.role || (index % 2 === 0 ? 'user' : 'assistant');
                    var content = entry.content || entry.response || entry.user_prompt || '';
                    var timestamp = entry.timestamp ? formatTimestamp(entry.timestamp) : '';
                    var model = entry.model || '';
                    
                    html += '<div class="message ' + role + '">';
                    html += '<div class="message-bubble">' + escapeHtml(content) + '</div>';
                    html += '<div class="message-info">';
                    
                    if (role === 'user') {
                        html += 'User';
                    } else {
                        html += model || 'Assistant';
                    }
                    
                    if (timestamp) {
                        html += ' â€¢ ' + timestamp;
                    }
                    
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>'; // end conversation-messages
                html += '</div>'; // end conversation-thread
                
                detailsDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading conversation details:', error);
                detailsDiv.innerHTML = '<div class="error-message">Error loading conversation details: ' + error.message + '</div>';
            });
        }

        // Helper function for fetch with retry
        function fetchWithRetry(url, options = {}) {
            const { retries = 3, retryDelay = 1000 } = options;
            
            return new Promise((resolve, reject) => {
                const attempt = (attemptsLeft) => {
                    fetch(url)
                        .then(resolve)
                        .catch((error) => {
                            console.warn(`Fetch attempt failed, ${attemptsLeft} attempts left. Error:`, error);
                            
                            if (attemptsLeft === 0) {
                                reject(error);
                                return;
                            }
                            
                            setTimeout(() => {
                                attempt(attemptsLeft - 1);
                            }, retryDelay);
                        });
                };
                
                attempt(retries);
            });
        }

        // Helper function to format timestamps
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp; // Return as-is if parsing fails
            }
        }

        // Enhanced conversation viewer JavaScript
        function refreshConversations() {
            var dateFilterElement = document.getElementById('conversation-date-filter');
            var dateFilter = dateFilterElement ? dateFilterElement.value : '';
            var listDiv = document.querySelector('.conversation-list');
            
            // Show loading animation
            listDiv.innerHTML = `
                <div class="loading-animation-container">
                    <span>Loading conversations</span>
                    <span class="loading-animation">
                        <span class="dot" style="--index: 0;"></span>
                        <span class="dot" style="--index: 1;"></span>
                        <span class="dot" style="--index: 2;"></span>
                    </span>
                </div>
            `;
            
            // Build URL with date parameter
            var url = '/system/conversations';
            if (dateFilter) {
                url += '?date=' + dateFilter;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.conversations || Object.keys(data.conversations).length === 0) {
                        listDiv.innerHTML = '<div class="empty-message">No conversations available</div>';
                        return;
                    }
                    
                    var html = '';
                    
                    // Convert object to array for sorting
                    var conversationArray = Object.values(data.conversations);
                    
                    // Sort by start_time descending (most recent first)
                    conversationArray.sort((a, b) => {
                        return new Date(b.start_time) - new Date(a.start_time);
                    });
                    
                    conversationArray.forEach(function(conversation) {
                        var startTime = formatTimestamp(conversation.start_time);
                        var messageCount = conversation.message_count;
                        
                        html += `<div class="conversation-item" onclick="loadConversationDetails('${conversation.thread_id}', '${dateFilter}')">`;
                        html += `<strong>Conversation #${conversation.thread_id.substring(0, 8)}...</strong>`;
                        html += `<div class="meta">`;
                        html += `Started: ${startTime}<br>`;
                        html += `Messages: ${messageCount}`;
                        
                        if (conversation.participants && conversation.participants.length > 0) {
                            html += `<br>With: ${conversation.participants.join(', ')}`;
                        }
                        
                        html += `</div></div>`;
                    });
                    
                    listDiv.innerHTML = html;
                    
                    // Auto-select first conversation if none selected
                    if (conversationArray.length > 0 && !document.querySelector('.conversation-item.selected')) {
                        var firstItem = document.querySelector('.conversation-item');
                        if (firstItem) {
                            firstItem.classList.add('selected');
                            loadConversationDetails(conversationArray[0].thread_id, dateFilter);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    listDiv.innerHTML = '<div class="error-message">Error loading conversations: ' + error.message + '</div>';
                });
        }

        function loadConversationDetails(threadId, date) {
            var detailsDiv = document.getElementById('conversation-details');
            
            // Highlight selected conversation
            document.querySelectorAll('.conversation-item').forEach(function(item) {
                item.classList.remove('selected');
            });
            
            document.querySelectorAll('.conversation-item').forEach(function(item) {
                if (item.textContent.includes(threadId.substring(0, 8))) {
                    item.classList.add('selected');
                }
            });
            
            // Show fancy loading animation
            detailsDiv.innerHTML = `
                <div class="loading-animation-container">
                    <span>Loading conversation details</span>
                    <span class="loading-animation">
                        <span class="dot" style="--index: 0;"></span>
                        <span class="dot" style="--index: 1;"></span>
                        <span class="dot" style="--index: 2;"></span>
                    </span>
                </div>
            `;
            
            // Build URL with date parameter if provided
            var url = '/system/conversation/' + threadId;
            if (date) {
                url += '?date=' + date;
            }
            
            // Add debug logging
            console.log('Loading conversation details from URL:', url);
            
            // Fetch conversation details with retry logic
            fetchWithRetry(url, {
                retries: 3,
                retryDelay: 1000
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Conversation details loaded:', data);
                
                if (!data || !data.entries || data.entries.length === 0) {
                    detailsDiv.innerHTML = '<div class="empty-message">No conversation details available</div>';
                    return;
                }
                
                // Format conversation details as a chat-like interface
                var html = '<div class="conversation-thread">';
                
                // Add thread information
                html += '<div class="thread-info">';
                html += '<h3>Conversation Thread: ' + data.thread_id + '</h3>';
                html += '<p>Started: ' + formatTimestamp(data.start_time) + '</p>';
                html += '<p>Messages: ' + data.entries.length + '</p>';
                
                if (data.participants && data.participants.length > 0) {
                    html += '<p>Participants: ' + data.participants.join(', ') + '</p>';
                }
                
                if (data.models_used && data.models_used.length > 0) {
                    html += '<p>Models: ' + data.models_used.join(', ') + '</p>';
                }
                
                html += '</div>';
                
                // Add the actual conversation
                html += '<div class="conversation-messages">';
                
                data.entries.forEach(function(entry) {
                    var role = entry.role || 'unknown';
                    var content = entry.content || '';
                    var timestamp = entry.timestamp ? formatTimestamp(entry.timestamp) : '';
                    var model = entry.model || '';
                    var personality = entry.personality || '';
                    var runtime = entry.runtime ? (entry.runtime.toFixed(2) + 's') : '';
                    
                    html += '<div class="message ' + role + '">';
                    html += '<div class="message-bubble">' + escapeHtml(content) + '</div>';
                    html += '<div class="message-info">';
                    
                    if (role === 'user') {
                        html += 'User';
                    } else if (model) {
                        if (personality && personality !== 'default') {
                            html += personality;
                        } else {
                            html += model;
                        }
                    } else {
                        html += 'Assistant';
                    }
                    
                    if (timestamp) {
                        html += ' â€¢ ' + timestamp;
                    }
                    
                    if (runtime) {
                        html += ' â€¢ ' + runtime;
                    }
                    
                    html += '</div>';
                    html += '</div>';
                });
                
                html += '</div>'; // end conversation-messages
                html += '</div>'; // end conversation-thread
                
                detailsDiv.innerHTML = html;
                
                // Scroll to bottom to show most recent messages
                var messagesContainer = detailsDiv.querySelector('.conversation-messages');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            })
            .catch(error => {
                console.error('Error loading conversation details:', error);
                detailsDiv.innerHTML = '<div class="error-message">Error loading conversation details: ' + error.message + '</div>';
            });
        }

        // Helper function for fetch with retry
        function fetchWithRetry(url, options = {}) {
            const { retries = 3, retryDelay = 1000 } = options;
            
            return new Promise((resolve, reject) => {
                const attempt = (attemptsLeft) => {
                    fetch(url)
                        .then(resolve)
                        .catch((error) => {
                            console.warn(`Fetch attempt failed, ${attemptsLeft} attempts left. Error:`, error);
                            
                            if (attemptsLeft === 0) {
                                reject(error);
                                return;
                            }
                            
                            setTimeout(() => {
                                attempt(attemptsLeft - 1);
                            }, retryDelay);
                        });
                };
                
                attempt(retries);
            });
        }

        // Helper function to format timestamps
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp; // Return as-is if parsing fails
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load conversations on page load
        document.addEventListener('DOMContentLoaded', function() {
            refreshConversations();
            loadOllamaConfig(); // Load Ollama configuration when page loads
        });

        // -------- OLLAMA CONFIGURATION FUNCTIONS -------- //
        
        function loadOllamaConfig() {
            fetch('/system/ollama/config')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('remote-ollama-enabled').checked = data.remote_enabled;
                        document.getElementById('remote-ollama-host').value = data.remote_host;
                        document.getElementById('remote-ollama-port').value = data.remote_port;
                    }
                })
                .catch(error => {
                    console.error('Error loading Ollama configuration:', error);
                });
            
            // Also load current server status
            refreshOllamaStatus();
        }
        
        function refreshOllamaStatus() {
            fetch('/system/ollama/status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const statusText = `Currently using: ${data.current_server.type} server (${data.current_server.url})`;
                        document.getElementById('ollama-current-server').textContent = statusText;
                    }
                })
                .catch(error => {
                    document.getElementById('ollama-current-server').textContent = 'Error loading server status';
                    console.error('Error loading Ollama status:', error);
                });
        }
        
        function saveOllamaConfig() {
            const enabled = document.getElementById('remote-ollama-enabled').checked;
            const host = document.getElementById('remote-ollama-host').value.trim();
            const port = parseInt(document.getElementById('remote-ollama-port').value);
            
            if (!host && enabled) {
                alert('Please enter a remote host');
                return;
            }
            
            const data = {
                enabled: enabled,
                host: host,
                port: port
            };
            
            fetch('/system/ollama/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = data.message;
                statusDiv.className = `status-message ${data.status}`;
                statusDiv.style.display = 'block';
                
                if (data.status === 'success') {
                    refreshOllamaStatus();
                }
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = 'Error updating configuration: ' + error;
                statusDiv.className = 'status-message error';
                statusDiv.style.display = 'block';
            });
        }
        
        function testOllamaServers() {
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Testing...';
            
            fetch('/system/ollama/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const resultsDiv = document.getElementById('ollama-test-results');
                    const remoteDiv = document.getElementById('remote-test-result');
                    const localDiv = document.getElementById('local-test-result');
                    
                    // Show remote server result
                    remoteDiv.textContent = `ðŸŒ Remote Server: ${data.servers.remote.message}`;
                    remoteDiv.style.background = data.servers.remote.available ? '#d4edda' : '#f8d7da';
                    remoteDiv.style.color = data.servers.remote.available ? '#155724' : '#721c24';
                    remoteDiv.style.border = data.servers.remote.available ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                    
                    // Show local server result
                    localDiv.textContent = `ðŸ  Local Server: ${data.servers.local.message}`;
                    localDiv.style.background = data.servers.local.available ? '#d4edda' : '#f8d7da';
                    localDiv.style.color = data.servers.local.available ? '#155724' : '#721c24';
                    localDiv.style.border = data.servers.local.available ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
                    
                    resultsDiv.style.display = 'block';
                }
            })
            .catch(error => {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = 'Error testing servers: ' + error;
                statusDiv.className = 'status-message error';
                statusDiv.style.display = 'block';
            })
            .finally(() => {
                button.disabled = false;
                button.textContent = 'ðŸ” Test Servers';
            });
        }
        
        // ========= OLLAMA MODEL LIBRARY FUNCTIONS ========= //
        
        async function searchOllamaModels() {
            const searchInput = document.getElementById('model-search-input');
            const sizeFilter = document.getElementById('model-size-filter');
            const resultsDiv = document.getElementById('ollama-models-results');
            const loadingDiv = document.getElementById('models-loading');
            const modelsListDiv = document.getElementById('models-list');
            
            const searchQuery = searchInput.value.trim();
            const sizeFilterValue = sizeFilter.value;
            
            // Show loading state
            resultsDiv.style.display = 'block';
            loadingDiv.style.display = 'block';
            modelsListDiv.innerHTML = '';
            
            try {
                const url = new URL('/system/ollama/models', window.location.origin);
                if (searchQuery) url.searchParams.append('search', searchQuery);
                if (sizeFilterValue !== 'all') url.searchParams.append('size', sizeFilterValue);
                
                const response = await fetch(url);
                const data = await response.json();
                
                loadingDiv.style.display = 'none';
                
                if (response.ok && data.models) {
                    displayOllamaModels(data.models);
                } else {
                    modelsListDiv.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 20px;">
                        <p>Error: ${data.error || 'Failed to fetch models'}</p>
                    </div>`;
                }
            } catch (error) {
                loadingDiv.style.display = 'none';
                modelsListDiv.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 20px;">
                    <p>Network error: ${error.message}</p>
                </div>`;
            }
        }
        
        function displayOllamaModels(models) {
            const modelsListDiv = document.getElementById('models-list');
            
            if (models.length === 0) {
                modelsListDiv.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">
                    <p>No models found matching your criteria.</p>
                </div>`;
                return;
            }
            
            let html = '';
            models.forEach(model => {
                const sizeClass = model.size_category === 'small' ? 'success' : 
                                model.size_category === 'medium' ? 'warning' : 
                                model.size_category === 'large' ? 'danger' : 'secondary';
                
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0 0 5px 0; color: #333;">${model.name}</h5>
                                <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">${model.description}</p>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <span class="badge badge-${sizeClass}" style="background: ${getSizeBadgeColor(model.size_category)}; color: white; padding: 3px 8px; border-radius: 12px; font-size: 12px;">
                                        ${model.size_category.toUpperCase()}
                                    </span>
                                    <span style="color: #666; font-size: 12px;">
                                        Tags: ${model.tags.slice(0, 3).join(', ')}${model.tags.length > 3 ? '...' : ''}
                                    </span>
                                </div>
                            </div>
                            <div style="margin-left: 15px;">
                                <select id="tag-select-${model.name.replace(/[^a-zA-Z0-9]/g, '_')}" style="margin-bottom: 8px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    ${model.tags.map(tag => `<option value="${tag}">${tag}</option>`).join('')}
                                </select>
                                <br>
                                <button onclick="downloadOllamaModel('${model.name}')" 
                                        style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    ðŸ“¥ Download
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            modelsListDiv.innerHTML = html;
        }
        
        function getSizeBadgeColor(sizeCategory) {
            switch(sizeCategory) {
                case 'small': return '#28a745';
                case 'medium': return '#ffc107';
                case 'large': return '#dc3545';
                default: return '#6c757d';
            }
        }
        
        async function downloadOllamaModel(modelName) {
            const selectId = `tag-select-${modelName.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const tagSelect = document.getElementById(selectId);
            const selectedTag = tagSelect ? tagSelect.value : 'latest';
            
            const progressDiv = document.getElementById('download-progress');
            const statusDiv = document.getElementById('download-status');
            
            // Show progress section
            progressDiv.style.display = 'block';
            statusDiv.textContent = `Starting download of ${modelName}:${selectedTag}...`;
            
            try {
                const response = await fetch('/system/ollama/models/download', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        model_name: modelName,
                        tag: selectedTag
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.innerHTML = `
                        <div style="color: #28a745;">âœ… ${data.message}</div>
                        <div style="font-size: 12px; margin-top: 5px;">
                            Monitor progress in your terminal with: <code>ollama ps</code>
                        </div>
                    `;
                    
                    // Hide progress after 10 seconds
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                    }, 10000);
                } else {
                    statusDiv.innerHTML = `<div style="color: #dc3545;">âŒ ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div style="color: #dc3545;">âŒ Network error: ${error.message}</div>`;
            }
        }

    </script>
</head>
<body>
    <div class="header">
        <div style="display: flex; align-items: center;">
            <a href="/" class="back-header-link" style="display: flex; align-items: center; text-decoration: none; color: inherit; cursor: pointer;">
                <span class="back-arrow">â†</span>
                <h1 style="margin: 0; margin-left: 10px;">ðŸ—„ï¸ RoverSeer System</h1>
            </a>
        </div>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div class="status-display">
                <span id="roverseer-status">Loading...</span>
            </div>
            <button class="refresh-btn" onclick="refreshPage()">ðŸ”„ Refresh</button>
        </div>
    </div>
    
    <div class="container">
        <div class="sidebar">
            <div class="top-models">
                <h3>ðŸ† Top 10 {{ sort_label }}</h3>
                <div class="sort-controls">
                    <a href="/system?sort_by=fastest{% if selected_log_type %}&log_type={{ selected_log_type }}{% endif %}{% if selected_date %}&date={{ selected_date }}{% endif %}" 
                       class="sort-btn {% if sort_by == 'fastest' %}active{% endif %}">
                       âš¡ Fastest
                    </a>
                    <a href="/system?sort_by=usage{% if selected_log_type %}&log_type={{ selected_log_type }}{% endif %}{% if selected_date %}&date={{ selected_date }}{% endif %}" 
                       class="sort-btn {% if sort_by == 'usage' %}active{% endif %}">
                       ðŸ“Š Most Used
                    </a>
                </div>
                {% if top_models %}
                    {% for model, short_name, avg_time, run_count in top_models %}
                        <div class="model-item clickable-model" onclick="window.location.href='/system?view=model_detail&model={{ model }}&sort_by={{ sort_by }}'">
                            <span><span class="rank">#{{ loop.index }}</span>{{ short_name }}</span>
                            <div class="model-stats">
                                {% if sort_by == 'usage' %}
                                    <span><strong>{{ run_count }}</strong> uses</span>
                                    <span>{{ "%.2f"|format(avg_time) }}s avg</span>
                                {% else %}
                                    <span><strong>{{ "%.2f"|format(avg_time) }}s</strong></span>
                                    <span>{{ run_count }} uses</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-logs">No performance data yet</p>
                {% endif %}
                
                <div class="see-all-models">
                    <a href="/system?view=models&sort_by={{ sort_by }}">ðŸ“‹ See All Models</a>
                </div>
            </div>
            
            <h3>ðŸ“ Log Types</h3>
            {% for log_type in log_types %}
                {% if log_type.id == 'conversations' %}
                    <a href="#" onclick="handleLogTypeClick('conversations'); return false;" 
                       class="log-type {% if selected_log_type == log_type.id %}active{% endif %}">
                        {{ log_type.icon }} {{ log_type.name }}
                    </a>
                {% else %}
                    <a href="/system?log_type={{ log_type.id }}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" 
                       class="log-type {% if selected_log_type == log_type.id %}active{% endif %}">
                        {{ log_type.icon }} {{ log_type.name }}
                    </a>
                {% endif %}
            {% endfor %}
            
            <h3 style="margin-top: 20px;">âš™ï¸ System</h3>
            <a href="/system?view=commands" 
               class="log-type {% if view_mode == 'commands' %}active{% endif %}">
               ðŸ› ï¸ Commands
            </a>
            <a href="/system?view=settings" 
               class="log-type {% if view_mode == 'settings' %}active{% endif %}">
               ðŸ”§ Settings
            </a>
            <a href="/system?view=voice_training" 
               class="log-type {% if view_mode == 'voice_training' %}active{% endif %}">
               ðŸ§  Voice Training
            </a>
            <a href="/system?view=training_activity" 
               class="log-type {% if view_mode == 'training_activity' %}active{% endif %}">
               ðŸ“Š Training Activity
            </a>
        </div>
        
        <div class="main-content">
            {% if view_mode == 'commands' %}
                <h2>ðŸ› ï¸ System Commands</h2>
                
                <div class="commands-section">
                    <div class="command-group">
                        <h3>Services</h3>
                        <div class="command-list">
                            <div class="command-item">
                                <span>roverseer.service</span>
                                <button onclick="executeCommand('service', 'roverseer.service')">Restart</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="command-group">
                        <h3>Docker Containers</h3>
                        <div id="container-list" class="command-list">
                            <!-- Containers will be loaded dynamically -->
                        </div>
                    </div>
                    
                    <div id="status-message" class="status-message"></div>
                </div>
                
            {% elif view_mode == 'models' %}
                <h2>ðŸ¤– All Models</h2>
                <p>Click on any model to view detailed information.</p>
                
                {% if all_models_data %}
                    <table class="model-list-table">
                        <thead>
                            <tr>
                                <th>Model Name</th>
                                <th>Parameters</th>
                                <th>Size (GB)</th>
                                <th>Family</th>
                                <th>Quantization</th>
                                <th>Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in all_models_data %}
                                <tr class="clickable-model" onclick="window.location.href='/system?view=model_detail&model={{ model.name }}&sort_by={{ sort_by }}'">
                                    <td><strong>{{ extract_short_model_name(model.name) }}</strong></td>
                                    <td>{{ model.parameters }}</td>
                                    <td>{{ model.size_gb }} GB</td>
                                    <td>{{ model.family.title() if model.family else 'Unknown' }}</td>
                                    <td>{{ model.quantization }}</td>
                                    <td>
                                        {% if model.average_runtime %}
                                            {{ "%.2f"|format(model.average_runtime) }}s avg<br>
                                            <small>{{ model.run_count }} uses</small>
                                        {% else %}
                                            <em>No data yet</em>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="no-logs">Failed to load model data</p>
                {% endif %}
                
            {% elif view_mode == 'model_detail' and model_detail %}
                <h2>ðŸ” Model Details</h2>
                <div class="model-detail-card">
                    <div class="model-detail-header">
                        <h3>{{ extract_short_model_name(model_detail.name) }}</h3>
                        <p>{{ model_detail.name }}</p>
                    </div>
                    
                    <div class="model-detail-section">
                        <h4>ðŸ“Š Basic Information</h4>
                        <div class="model-detail-grid">
                            <div class="model-detail-item">
                                <div class="label">Parameters</div>
                                <div class="value">{{ model_detail.parameters }}</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Size on Disk</div>
                                <div class="value">{{ model_detail.size_gb }} GB</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Model Family</div>
                                <div class="value">{{ model_detail.family.title() if model_detail.family else 'Unknown' }}</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Quantization</div>
                                <div class="value">{{ model_detail.quantization }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="model-detail-section">
                        <h4>âš¡ Performance Metrics</h4>
                        <div class="model-detail-grid">
                            <div class="model-detail-item">
                                <div class="label">Average Runtime</div>
                                <div class="value">
                                    {% if model_detail.average_runtime %}
                                        {{ "%.2f"|format(model_detail.average_runtime) }} seconds
                                    {% else %}
                                        No data yet
                                    {% endif %}
                                </div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Total Uses</div>
                                <div class="value">{{ model_detail.run_count }} times</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Last Runtime</div>
                                <div class="value">
                                    {% if model_detail.last_runtime %}
                                        {{ "%.2f"|format(model_detail.last_runtime) }} seconds
                                    {% else %}
                                        No recent data
                                    {% endif %}
                                </div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Last Modified</div>
                                <div class="value">
                                    {% if model_detail.modified_at %}
                                        {{ model_detail.modified_at[:10] }}
                                    {% else %}
                                        Unknown
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if model_detail.families and model_detail.families|length > 1 %}
                    <div class="model-detail-section">
                        <h4>ðŸ—ï¸ Technical Details</h4>
                        <div class="model-detail-grid">
                            <div class="model-detail-item">
                                <div class="label">Model Families</div>
                                <div class="value">{{ model_detail.families|join(', ') }}</div>
                            </div>
                            <div class="model-detail-item">
                                <div class="label">Format</div>
                                <div class="value">{{ model_detail.format.upper() if model_detail.format else 'Unknown' }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <p><a href="/system?view=models&sort_by={{ sort_by }}">&larr; Back to All Models</a></p>
                
            {% elif view_mode == 'model_detail' and not model_detail %}
                <h2>âŒ Model Not Found</h2>
                <p>The requested model "{{ model_name }}" could not be found.</p>
                <p><a href="/system?view=models&sort_by={{ sort_by }}">&larr; Back to All Models</a></p>
                
            {% elif selected_log_type %}
                <h2>{{ selected_log_type|replace("_", " ")|title }} Logs</h2>
                
                {% if selected_log_type == 'penphin_mind' %}
                    <div class="log-info">
                        â„¹ï¸ PenphinMind logs show the complete 3-mind (2 minds + convergence) processing flow. 
                        Individual mind calls are not logged separately to keep logs clean.
                    </div>
                {% endif %}
                
                {% if available_dates %}
                    <div class="date-selector">
                        <label>Select Date:</label>
                        <select id="date-select" onchange="changeDate('{{ selected_log_type }}')">
                            {% for date in available_dates %}
                                <option value="{{ date }}" {% if date == selected_date %}selected{% endif %}>
                                    {{ date }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                {% endif %}
                
                {% if log_entries %}
                    <div class="log-entries">
                        {% for entry in log_entries %}
                            {% if entry.type == 'llm_usage' %}
                                <div class="log-entry" id="log-{{ entry.id }}" data-type="llm_usage" onclick="toggleLogEntry('{{ entry.id }}')">
                                    <div class="log-entry-summary">
                                        <div style="flex: 1;">
                                            <div>
                                                <strong>{{ entry.model }}</strong> 
                                                <span style="color: #666;">({{ entry.personality }})</span>
                                                <span class="log-entry-meta">{{ entry.timestamp }} - {{ "%.2f"|format(entry.runtime) }}s</span>
                                                
                                                <!-- Enhanced indicators for mood data and tags -->
                                                {% if entry.mood_data and entry.mood_data.get('moods_activated') %}
                                                    <span title="Mood system activated: {{ ', '.join(entry.mood_data.get('moods_activated', [])) }}" style="background: #e8f5e8; color: #2e7d32; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">
                                                        ðŸ§ {{ entry.mood_data.get('moods_activated')|length }}
                                                    </span>
                                                {% elif entry.mood_data and entry.mood_data.get('total_moods_available', 0) > 0 %}
                                                    <span title="Mood system available but no moods activated" style="background: #f5f5f5; color: #666; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">
                                                        ðŸ§ -
                                                    </span>
                                                {% endif %}
                                                
                                                {% if entry.has_tags %}
                                                    <span title="Response contains personality/mood tags" style="background: #f0f8ff; color: #1976d2; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 5px;">
                                                        ðŸ·ï¸
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="log-entry-preview log-entry-preview-mobile" id="preview-{{ entry.id }}">
                                                {% if entry.user_prompt|length > 50 %}
                                                    <span class="log-entry-preview-truncated">
                                                        User: "{{ entry.user_prompt[:50] }}..."
                                                        <button class="expand-preview-btn" onclick="event.stopPropagation(); togglePreview('{{ entry.id }}');">more</button>
                                                    </span>
                                                    <span class="log-entry-preview-full">
                                                        User: "{{ entry.user_prompt }}"
                                                        <button class="expand-preview-btn" onclick="event.stopPropagation(); togglePreview('{{ entry.id }}');">less</button>
                                                    </span>
                                                {% else %}
                                                    User: "{{ entry.user_prompt }}"
                                                {% endif %}
                                            </div>
                                        </div>
                                        <button class="play-button" data-text="{{ entry.llm_reply }}" data-voice="{{ (entry.voice_id if entry.voice_id else 'null') }}" onclick="playLogEntry(event, '{{ entry.id }}'); return false;">Play</button>
                                    </div>
                                    <div class="log-entry-details">
                                        <p><strong>User:</strong> {{ entry.user_prompt }}</p>
                                        <p><strong>System:</strong> {{ entry.system_message }}</p>
                                        <p><strong>Reply:</strong> <span id="reply-{{ entry.id }}">{{ entry.llm_reply }}</span></p>
                                        {% if entry.voice_id %}
                                        <p><strong>Voice:</strong> {{ entry.voice_id }}</p>
                                        {% endif %}
                                        <p><a href="#" onclick="event.preventDefault(); showLogDetailById(this); return false;">View Full Details â†’</a></p>
                                        <script>
                                            // Process think tags for this entry
                                            document.getElementById('reply-{{ entry.id }}').innerHTML = processThinkTags(document.getElementById('reply-{{ entry.id }}').innerHTML);
                                        </script>
                                    </div>
                                </div>
                            {% elif entry.type == 'tts_usage' %}
                                <div class="log-entry" id="log-{{ entry.id }}" data-type="tts_usage" onclick="toggleLogEntry('{{ entry.id }}')">
                                    <div class="log-entry-summary">
                                        <div style="flex: 1;">
                                            <div>
                                                <strong>TTS: {{ entry.voice_id }}</strong>
                                                <span class="log-entry-meta">{{ entry.timestamp }} - {{ "%.2f"|format(entry.processing_time) }}s</span>
                                            </div>
                                            <div class="log-entry-preview">
                                                "{{ entry.text[:100] }}{% if entry.text|length > 100 %}...{% endif %}"
                                            </div>
                                        </div>
                                        <button class="play-button" data-text="{{ entry.text }}" data-voice="{{ (entry.voice_id if entry.voice_id else 'null') }}" onclick="playLogEntry(event, '{{ entry.id }}'); return false;">Play</button>
                                    </div>
                                    <div class="log-entry-details">
                                        <p><strong>Text:</strong> {{ entry.text }}</p>
                                        <p><a href="#" onclick="event.preventDefault(); showLogDetailById(this); return false;">View Full Details â†’</a></p>
                                    </div>
                                </div>
                            {% elif entry.type == 'asr_usage' %}
                                <div class="log-entry" id="log-{{ entry.id }}" data-type="asr_usage" onclick="toggleLogEntry('{{ entry.id }}')">
                                    <div class="log-entry-summary">
                                        <div style="flex: 1;">
                                            <div>
                                                <strong>ASR Transcription</strong>
                                                <span class="log-entry-meta">{{ entry.timestamp }} - {{ "%.2f"|format(entry.processing_time) }}s</span>
                                            </div>
                                            <div class="log-entry-preview">
                                                "{{ entry.text[:100] }}{% if entry.text|length > 100 %}...{% endif %}"
                                            </div>
                                        </div>
                                    </div>
                                    <div class="log-entry-details">
                                        <p><strong>Text:</strong> {{ entry.text }}</p>
                                        <p><a href="#" onclick="event.preventDefault(); showLogDetailById(this); return false;">View Full Details â†’</a></p>
                                    </div>
                                </div>
                            {% elif entry.type == 'penphin_mind' %}
                                <div class="log-entry" id="log-{{ entry.id }}" data-type="penphin_mind" onclick="toggleLogEntry('{{ entry.id }}')">
                                    <div class="log-entry-summary">
                                        <div style="flex: 1;">
                                            <div>
                                                <strong>PenphinMind</strong>
                                                <span class="log-entry-meta">{{ entry.timestamp }} - {{ "%.2f"|format(entry.total_time) }}s</span>
                                            </div>
                                            <div class="log-entry-preview">
                                                "{{ entry.original_prompt[:100] }}{% if entry.original_prompt|length > 100 %}...{% endif %}"
                                            </div>
                                        </div>
                                    </div>
                                    <div class="log-entry-details">
                                        <p><strong>Prompt:</strong> {{ entry.original_prompt }}</p>
                                        <p><strong>Logical:</strong> {{ entry.logical_response }}</p>
                                        <p><strong>Creative:</strong> {{ entry.creative_response }}</p>
                                        <p><strong>Final:</strong> {{ entry.final_synthesis }}</p>
                                        <p><a href="#" onclick="event.preventDefault(); showLogDetailById(this); return false;">View Full Details â†’</a></p>
                                    </div>
                                </div>
                            {% elif entry.type == 'errors' %}
                                <div class="log-entry" id="log-{{ entry.id }}" data-type="errors" onclick="toggleLogEntry('{{ entry.id }}')">
                                    <div class="log-entry-summary">
                                        <div style="flex: 1;">
                                            <div>
                                                <strong>Error: {{ entry.error_type }}</strong>
                                                <span class="log-entry-meta">{{ entry.timestamp }}</span>
                                            </div>
                                            <div class="log-entry-preview">
                                                {{ entry.message[:100] }}{% if entry.message|length > 100 %}...{% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="log-entry-details">
                                        <p><strong>Message:</strong> {{ entry.message }}</p>
                                        {% if entry.context %}
                                            <p><strong>Context:</strong></p>
                                            {% for key, value in entry.context.items() %}
                                                <p>{{ key }}: {{ value }}</p>
                                            {% endfor %}
                                        {% endif %}
                                        <p><a href="#" onclick="event.preventDefault(); showLogDetailById(this); return false;">View Full Details â†’</a></p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="no-logs">No log entries found for {{ selected_log_type|replace("_", " ") }}{% if selected_date %} on {{ selected_date }}{% endif %}</p>
                {% endif %}
            
            {% elif view_mode == 'settings' %}
                <h2>ðŸ”§ System Settings</h2>
                
                <div class="settings-section">
                    <div class="settings-group">
                        <h3>ðŸ—£ï¸ Voice Settings</h3>
                        <div class="setting-item">
                            <label for="voice-select">Default Voice</label>
                            <select id="voice-select">
                                {% if categorized_voices and categorized_voices.categorized %}
                                    {% for category_name, voices_list in categorized_voices.categorized.items() %}
                                        {% if category_name == 'uncategorized' %}
                                            <!-- Add uncategorized voices directly (no optgroup) -->
                                            {% for voice in voices_list %}
                                                <option value="{{ voice }}" {% if voice == current_voice %}selected{% endif %}>
                                                    {{ voice }}
                                                </option>
                                            {% endfor %}
                                        {% else %}
                                            <!-- Create optgroup for categorized voices -->
                                            <optgroup label="{{ category_name }}">
                                                {% for voice in voices_list %}
                                                    <option value="{{ voice }}" {% if voice == current_voice %}selected{% endif %}>
                                                        {{ voice }}
                                                    </option>
                                                {% endfor %}
                                            </optgroup>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback to flat list if no categorization -->
                                    {% for voice in voices %}
                                        <option value="{{ voice }}" {% if voice == current_voice %}selected{% endif %}>
                                            {{ voice }}
                                        </option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                            <span class="current-value">Current: <span id="current-voice">{{ current_voice }}</span></span>
                            <br>
                            <button onclick="saveVoiceSetting()">Update Default Voice</button>
                            <p style="margin-top: 10px; color: #666; font-size: 14px;">
                                This voice will be used for all device speech output and as the default in the web interface.
                            </p>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3>ðŸ¤– Personality Settings</h3>
                        <div class="setting-item">
                            <label for="personality-select">Active Personality</label>
                            <select id="personality-select" onchange="loadPersonalityDetails()">
                                <!-- Will be populated dynamically -->
                            </select>
                            <span class="current-value">Current: <span id="current-personality">Loading...</span></span>
                            <br>
                            <button onclick="switchPersonality()">Switch Personality</button>
                        </div>
                        
                        <div id="personality-details" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                            <h4 id="personality-name" style="margin: 0 0 10px 0;">Personality Details</h4>
                            <p id="personality-description" style="margin: 10px 0;"></p>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <strong>Voice:</strong> <span id="personality-voice"></span>
                                </div>
                                <div>
                                    <strong>Preferred Model:</strong> <span id="personality-model"></span>
                                </div>
                                <div>
                                    <strong>Mini Model:</strong> <span id="personality-mini-model"></span>
                                </div>
                                <div>
                                    <strong>Mini Threshold:</strong> <span id="personality-threshold"></span> tokens
                                </div>
                            </div>
                            <div id="personality-intro" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-style: italic; display: none;">
                                <strong>Introduction:</strong> <span id="intro-message"></span>
                            </div>
                            <div id="custom-personality-actions" style="margin-top: 15px; display: none;">
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="editPersonality()" style="background-color: #4169e1; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">âœï¸ Edit Personality</button>
                                    <button onclick="deletePersonality()" style="background-color: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ðŸ—‘ï¸ Delete Personality</button>
                                </div>
                                <p style="margin-top: 5px; color: #666; font-size: 12px;">âš ï¸ Deletion cannot be undone</p>
                            </div>
                        </div>
                        
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Personalities combine a voice, model preference, and unique interaction style. When you switch personalities, the voice and default model will automatically update.
                        </p>
                    </div>
                    
                    <div class="settings-group">
                        <h3 id="create-personality-title">âž• Create New Personality</h3>
                        <div class="setting-item">
                            <label for="new-personality-name">Personality Name</label>
                            <input type="text" id="new-personality-name" placeholder="e.g., Assistant" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-voice">Voice</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <select id="new-personality-voice" style="flex: 1;">
                                    {% if categorized_voices and categorized_voices.categorized %}
                                        {% for category_name, voices_list in categorized_voices.categorized.items() %}
                                            {% if category_name == 'uncategorized' %}
                                                <!-- Add uncategorized voices directly (no optgroup) -->
                                                {% for voice in voices_list %}
                                                    <option value="{{ voice }}">{{ voice }}</option>
                                                {% endfor %}
                                            {% else %}
                                                <!-- Create optgroup for categorized voices -->
                                                <optgroup label="{{ category_name }}">
                                                    {% for voice in voices_list %}
                                                        <option value="{{ voice }}">{{ voice }}</option>
                                                    {% endfor %}
                                                </optgroup>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <!-- Fallback to flat list if no categorization -->
                                        {% for voice in voices %}
                                            <option value="{{ voice }}">{{ voice }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                                <button type="button" onclick="previewVoice()" style="background: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                                    ðŸ”Š Preview
                                </button>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-model">Preferred Model (optional)</label>
                            <select id="new-personality-model" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">Select preferred model (optional)</option>
                                {% if categorized_models %}
                                    {% for category_name, models_list in categorized_models.items() %}
                                        <optgroup label="{{ category_name }}">
                                            {% for model in models_list %}
                                                <option value="{{ model.full_name }}">{{ model.display_name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                {% else %}
                                    <!-- Fallback to flat list if no categorization -->
                                    {% for model in available_models %}
                                        <option value="{{ model }}">{{ extract_short_model_name(model) }}</option>
                                    {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-mini-model">Mini Model (optional)</label>
                            <select id="new-personality-mini-model">
                                <option value="">None (always use preferred model)</option>
                                {% for model in available_models %}
                                    <option value="{{ model }}">{{ extract_short_model_name(model) }}</option>
                                {% endfor %}
                            </select>
                            <p style="margin-top: 5px; color: #666; font-size: 12px;">
                                A smaller, faster model used when conversation context gets large (context overflow protection).
                            </p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-threshold">Mini Model Threshold (tokens)</label>
                            <input type="number" id="new-personality-threshold" value="1000" min="50" max="2000" step="50" 
                                   style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <p style="margin-top: 5px; color: #666; font-size: 12px;">
                                Switch to mini model when total context (conversation + input) exceeds this token count.
                            </p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-description">Description</label>
                            <input type="text" id="new-personality-description" placeholder="Brief description" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-system">System Message</label>
                            <textarea id="new-personality-system" placeholder="Enter the system message for this personality..." style="width: 100%; height: 120px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit;"></textarea>
                        </div>
                        
                        <div class="setting-item">
                            <label for="new-personality-emoji">Avatar Emoji</label>
                            <input type="text" id="new-personality-emoji" placeholder="ðŸ¤–" value="ðŸ¤–" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 20px; text-align: center;">
                        </div>
                        
                        <!-- Mood Management Section (only shown during create/edit) -->
                        <div id="personality-mood-section" class="setting-item" style="display: none;">
                            <h4 style="margin: 20px 0 15px 0; color: #1a472a;">ðŸŽ­ Contextual Moods</h4>
                            
                            <!-- Current Moods Display (only show when editing) -->
                            <div id="current-moods-list" style="margin-bottom: 15px; display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <span style="font-weight: bold;">Current Moods:</span>
                                    <button type="button" onclick="loadPersonalityMoodsForEdit()" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">ðŸ”„ Refresh</button>
                                </div>
                                <div id="moods-display" style="min-height: 40px; background: white; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                                    <em style="color: #666;">No moods configured yet</em>
                                </div>
                            </div>
                            
                            <!-- Add Mood Button (shows by default) -->
                            <div id="add-mood-button-container" style="margin-bottom: 15px;">
                                <button type="button" onclick="showMoodForm()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">ðŸŽ­ Add Contextual Mood</button>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Create dynamic personality shifts based on context triggers</p>
                            </div>
                            
                            <!-- Add New Mood Form (hidden by default) -->
                            <div id="add-mood-form" style="background: #f0f8ff; border: 1px solid #e0e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
                                <h5 style="margin: 0 0 15px 0;">âž• Add Contextual Mood</h5>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                    <div>
                                        <label for="mood-name" style="display: block; font-size: 12px; margin-bottom: 3px; font-weight: bold;">Mood Name:</label>
                                        <input type="text" id="mood-name" placeholder="e.g., creative_inspiration" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                                    </div>
                                    <div>
                                        <label for="mood-probability" style="display: block; font-size: 12px; margin-bottom: 3px; font-weight: bold;">Trigger Probability:</label>
                                        <input type="number" id="mood-probability" value="0.7" min="0" max="1" step="0.1" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <label for="mood-triggers" style="display: block; font-size: 12px; margin-bottom: 3px; font-weight: bold;">Context Triggers (comma-separated OR conditions):</label>
                                    <input type="text" id="mood-triggers" placeholder="e.g., sunny, morning, coding, user_happy" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px;">
                                    <div style="font-size: 11px; color: #666; margin-top: 2px;">
                                        If ANY of these conditions are true, this mood can trigger (subject to probability)
                                    </div>
                                </div>
                                
                                <div id="trance-words-section" style="margin-bottom: 15px;">
                                    <label style="display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold;">Trance Words & Phrases:</label>
                                    <div style="font-size: 11px; color: #666; margin-bottom: 8px; padding: 8px; background: #fff3cd; border-radius: 3px;">
                                        <strong>ðŸ’­ What are Trance Words?</strong><br>
                                        These are custom words, phrases, or even full sentences that will be added to the personality's system message when this mood is triggered. 
                                        They influence how the AI responds and behaves during the conversation.<br>
                                        <strong>Examples:</strong> "Be more creative", "Focus on artistic aspects", "You feel inspired by the morning light", "Channel your inner poet"
                                    </div>
                                    <div id="mood-influences-list" style="margin-bottom: 10px;">
                                        <!-- Trance words will be added here -->
                                    </div>
                                    <button type="button" onclick="addMoodInfluence()" style="background: #17a2b8; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">+ Add Trance Phrase</button>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" onclick="saveMoodToForm()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">ðŸ’¾ Add This Mood</button>
                                    <button type="button" onclick="resetMoodForm()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">Clear Form</button>
                                    <button type="button" onclick="hideMoodForm()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">Cancel</button>
                                    <button type="button" onclick="toggleMoodHelp()" style="background: #ffc107; color: black; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">â“ Help</button>
                                </div>
                                
                                <!-- Help Section -->
                                <div id="mood-help" style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; display: none;">
                                    <h6 style="margin: 0 0 8px 0;">ðŸŽ­ About Contextual Moods</h6>
                                    <p style="margin: 0 0 8px 0; font-size: 12px;">
                                        Contextual moods add dynamic personality shifts based on environmental triggers and user input. 
                                        When triggered, the "trance words" are added to the personality's system message, influencing how the AI responds.
                                    </p>
                                    <div style="margin: 8px 0; padding: 8px; background: #e8f5e8; border-radius: 3px;">
                                        <strong style="font-size: 11px; color: #2d5a2d;">ðŸ“‹ Available Trigger Conditions (OR logic):</strong>
                                        <div style="font-size: 10px; color: #2d5a2d; margin-top: 4px; line-height: 1.3;">
                                            <strong>Time:</strong> morning, afternoon, evening, night<br>
                                            <strong>Weather:</strong> sunny, hot, warm, cold, cool, rainy, snowy, cloudy<br>
                                            <strong>User Emotions:</strong> user_sad, user_happy, user_angry, user_afraid, user_excited, user_frustrated<br>
                                            <strong>Activities:</strong> coding, music, creative, learning, gaming, working<br>
                                            <strong>Interactions:</strong> compliment, criticism, error, help_needed, philosophical, small_talk<br>
                                            <strong>System:</strong> high_load, low_battery, startup, shutdown
                                        </div>
                                    </div>
                                    <p style="margin: 0; font-size: 11px; color: #856404;">
                                        <strong>How it works:</strong> If ANY trigger matches current conditions, this mood may activate based on its probability.
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Configured Moods List -->
                            <div id="configured-moods-display" style="margin-bottom: 15px;">
                                <div style="font-weight: bold; margin-bottom: 8px;">Configured Moods for this Personality:</div>
                                <div id="temp-moods-list" style="min-height: 30px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                                    <em style="color: #666;">No moods configured yet. Add moods above to enhance this personality.</em>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="createPersonality()">Create Personality</button>
                        
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Create custom personalities with specific voices and interaction styles. Each personality can have its own system message that defines how it responds.
                        </p>
                    </div>
                    
                    <div class="settings-group">
                        <h3>ðŸ”„ Concurrent Request Settings</h3>
                        <div class="setting-item">
                            <label for="concurrent-requests-input">Maximum Concurrent Requests</label>
                            <input type="number" id="concurrent-requests-input" min="1" max="10" value="{{ current_concurrent }}" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <span class="current-value">Current: <span id="current-concurrent">{{ current_concurrent }}</span></span>
                            <br>
                            <button onclick="saveConcurrentSetting()">Update Limit</button>
                            <p style="margin-top: 10px; color: #666; font-size: 14px;">
                                Controls how many web requests can be processed simultaneously. Set to 1 for single-threaded operation (recommended for Raspberry Pi). Higher values allow parallel processing on more powerful systems.
                            </p>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3>ðŸŽ¤ Speech & Audio Settings</h3>
                        <div class="setting-item">
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="streaming-tts" {% if streaming_tts_enabled %}checked{% endif %} style="margin: 0;">
                                <span style="font-weight: bold;">Enable Streaming Speech</span>
                            </label>
                            <div style="margin-top: 10px; color: #666; font-size: 14px;">
                                <p style="margin: 0 0 8px 0;">
                                    When enabled, RoverSeer starts speaking as soon as it completes sentences, rather than waiting for the entire response. This makes conversations feel more natural and responsive.
                                </p>
                                <div style="margin-top: 8px; color: #888; font-size: 12px;">
                                    <div><strong>Disabled:</strong> Generate entire text, then speak it all at once</div>
                                    <div><strong>Enabled:</strong> Stream text into buffer, speak sentences as they're completed</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <h3>ðŸŒ Ollama Server Configuration</h3>
                        
                        <!-- Current Server Status -->
                        <div id="ollama-status-display" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span id="ollama-current-server">Loading server status...</span>
                                <button onclick="refreshOllamaStatus()" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ðŸ”„ Refresh</button>
                            </div>
                        </div>
                        
                        <!-- Remote Server Configuration -->
                        <div class="setting-item">
                            <label>
                                <input type="checkbox" id="remote-ollama-enabled" style="margin-right: 10px;">
                                Enable Remote Ollama Server
                            </label>
                            <p style="margin: 5px 0; color: #666; font-size: 12px;">
                                When enabled, RoverSeer will try the remote server first, then fallback to local.
                            </p>
                        </div>
                        
                        <div class="setting-item">
                            <label for="remote-ollama-host">Remote Host</label>
                            <input type="text" id="remote-ollama-host" placeholder="e.g., M2cBook.local" style="width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        </div>
                        
                        <div class="setting-item">
                            <label for="remote-ollama-port">Remote Port</label>
                            <input type="number" id="remote-ollama-port" min="1" max="65535" value="11434" style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                        </div>
                        
                        <div class="setting-item">
                            <button onclick="saveOllamaConfig()">Update Configuration</button>
                            <button onclick="testOllamaServers()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-left: 10px;">ðŸ” Test Servers</button>
                        </div>
                        
                        <!-- Test Results -->
                        <div id="ollama-test-results" style="margin-top: 15px; display: none;">
                            <h4>Server Test Results:</h4>
                            <div id="remote-test-result" style="padding: 8px; margin: 5px 0; border-radius: 5px;"></div>
                            <div id="local-test-result" style="padding: 8px; margin: 5px 0; border-radius: 5px;"></div>
                        </div>
                        
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Configure a more powerful remote machine (like M2cBook.local) to handle LLM processing. The system will automatically use the remote server when available and fallback to local processing when needed.
                        </p>
                    </div>
                    
                    <div class="settings-group">
                        <h3>ðŸ“¦ Ollama Model Library</h3>
                        
                        <!-- Search and Filter Controls -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                                <input type="text" id="model-search-input" placeholder="Search models..." 
                                       style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <select id="model-size-filter" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                    <option value="all">All Sizes</option>
                                    <option value="small">Small (â‰¤7B)</option>
                                    <option value="medium">Medium (8B-14B)</option>
                                    <option value="large">Large (â‰¥30B)</option>
                                </select>
                                <button onclick="searchOllamaModels()" 
                                        style="background: #4169e1; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                    ðŸ” Search
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="ollama-models-results" style="display: none;">
                            <h4>Available Models</h4>
                            <div id="models-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                                <!-- Models will be populated here -->
                            </div>
                            <div id="models-loading" style="text-align: center; padding: 20px; display: none;">
                                <div class="loading-animation">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                                <p>Searching Ollama library...</p>
                            </div>
                        </div>
                        
                        <!-- Download Progress -->
                        <div id="download-progress" style="display: none; margin-top: 15px; padding: 15px; background: #e8f5e8; border: 1px solid #c3e6c3; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0;">ðŸ“¥ Download in Progress</h4>
                            <div id="download-status">Starting download...</div>
                            <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                                Downloads run in the background. Check your terminal or Ollama logs for progress.
                            </p>
                        </div>
                        
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Browse and download models from the Ollama library. Models are downloaded directly to your Ollama installation and become available immediately.
                        </p>
                    </div>
                    
                    <div id="status-message" class="status-message"></div>
                </div>
            
            {% elif view_mode == 'voice_training' %}
                <h2>ðŸ§  Neural Voice Training</h2>
                <p>Train custom voices using your own audio samples to create personalized TTS models.</p>
                
                <div class="settings-section">
                    <!-- Training Status Section -->
                    <div class="settings-group">
                        <h3>ðŸŽ¯ Training Status</h3>
                        <div id="training-status-display" style="padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span id="training-status-text">Loading...</span>
                                <button id="refresh-status-btn" onclick="refreshTrainingStatus()" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">ðŸ”„ Refresh</button>
                            </div>
                            <div id="training-progress" style="margin-top: 10px; display: none;">
                                <div style="background: #e0e0e0; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div id="progress-bar" style="background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                                <p id="progress-text" style="margin: 5px 0 0 0; font-size: 12px; color: #666;"></p>
                            </div>
                        </div>
                        
                        <!-- Training Log Viewer -->
                        <div id="training-log-section" style="display: none;">
                            <h4>ðŸ” Training Log</h4>
                            <div id="training-log" style="background: #000; color: #00ff00; padding: 15px; border-radius: 5px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 15px;">
                                <!-- Training log will be populated here -->
                            </div>
                            <button id="cancel-training-btn" onclick="cancelTraining()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; display: none;">
                                â›” Cancel Training
                            </button>
                        </div>
                    </div>
                    
                    <!-- Available Voice Samples Section -->
                    <div class="settings-group">
                        <h3>ðŸŽ¤ Available Voice Samples</h3>
                        <div id="available-voices-list" style="margin-bottom: 15px;">
                            <!-- Will be populated dynamically -->
                        </div>
                        <button onclick="refreshAvailableVoices()" style="background: #4169e1; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            ðŸ”„ Refresh Voice List
                        </button>
                        <p style="margin-top: 10px; color: #666; font-size: 14px;">
                            Voice sample directories should be placed in <code>/home/codemusic/texty/voice_data/</code>. Each directory should contain MP3, WAV, or FLAC audio files of the voice you want to train.
                        </p>
                    </div>
                    
                    <!-- Start Training Section -->
                    <div class="settings-group">
                        <h3>ðŸš€ Start Voice Training</h3>
                        <div class="setting-item">
                            <label for="training-voice-select">Select Voice to Train</label>
                            <select id="training-voice-select" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                <option value="">Select a voice...</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <button id="start-training-btn" onclick="startVoiceTraining()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                                ðŸ§  Start Neural Voice Training
                            </button>
                        </div>
                        
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 15px; margin-top: 15px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">âš ï¸ Training Requirements</h4>
                            <ul style="margin: 0; padding-left: 20px; color: #856404;">
                                <li>Voice samples should be high quality (44.1kHz, 16-bit minimum)</li>
                                <li>Each voice directory should contain 50-200 audio samples</li>
                                <li>Training typically takes 30-60 minutes depending on sample count</li>
                                <li>Ensure textymcspeechy-piper Docker container is running</li>
                                <li>Only one voice can be trained at a time</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Voice Registry Section -->
                    <div class="settings-group">
                        <h3>ðŸ“š Voice Training Registry</h3>
                        
                        <!-- Quick Training Controls -->
                        <div id="quick-training-controls" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                            <strong style="color: #856404;">ðŸ§  Training Active</strong>
                            <div style="margin: 5px 0;">
                                <span id="quick-training-voice" style="color: #856404;"></span>
                            </div>
                            <div style="margin-top: 10px;">
                                <button onclick="refreshTrainingStatus()" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                    ðŸ”„ Check Status
                                </button>
                                <button onclick="cancelTraining()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-right: 5px;">
                                    â›” Cancel
                                </button>
                                <button onclick="window.location.href='/system?view=voice_training'" style="background: #4169e1; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
                                    ðŸŽ¯ Full Interface
                                </button>
                            </div>
                        </div>
                        
                        <div id="voice-registry" style="margin-bottom: 15px;">
                            <!-- Will be populated dynamically -->
                        </div>
                        <button onclick="refreshVoiceRegistry()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            ðŸ“‹ Refresh Registry
                        </button>
                    </div>
                    
                    <div id="training-status-message" class="status-message"></div>
                </div>
            
            {% else %}
                <h2>RoverSeer System</h2>
                <p>Select a log type from the sidebar to view entries, or explore model information.</p>
                <div style="margin-top: 30px;">
                    <h3>ðŸ“Š Quick Actions</h3>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin: 10px 0;"><a href="/system?view=models&sort_by={{ sort_by }}" style="color: #4169e1; text-decoration: none;">ðŸ¤– View All Models</a></li>
                        <li style="margin: 10px 0;"><a href="/system?log_type=llm_usage&sort_by={{ sort_by }}" style="color: #4169e1; text-decoration: none;">ðŸ¤– View LLM Usage Logs</a></li>
                        <li style="margin: 10px 0;"><a href="/system?log_type=penphin_mind&sort_by={{ sort_by }}" style="color: #4169e1; text-decoration: none;">ðŸ§  View PenphinMind Logs</a></li>
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>
</body>
</html> 