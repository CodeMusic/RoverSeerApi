<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>RoverSeer Status</title>
    <style>
        body 
        {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; 
            background: #f4f4f4; 
            color: #333; 
            margin: 20px;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            body {
                margin: 0;
                padding: 0;
                background: #000000; /* Black background like iPhone */
            }
            
            .topbar {
                background: #1c1c1e;
                color: white;
                padding: 8px 10px; /* Reduced padding */
                padding-top: max(8px, env(safe-area-inset-top)); /* Reduced top padding */
                flex-direction: column;
                gap: 8px; /* Reduced gap */
                position: sticky;
                top: 0;
                z-index: 100;
            }
            
            .status-container {
                justify-content: center;
                text-align: center;
                flex-direction: column;
                gap: 6px; /* Reduced gap */
                width: 100%;
            }
            
            /* Mobile status toggle */
            .mobile-status-toggle {
                background: #333;
                color: #87CEEB;
                border: 1px solid #555;
                padding: 4px 8px; /* Reduced padding */
                border-radius: 4px; /* Smaller radius */
                font-size: 11px; /* Smaller font */
                cursor: pointer;
                margin-bottom: 4px; /* Reduced margin */
                transition: all 0.3s ease;
            }
            
            .mobile-status-toggle:hover {
                background: #444;
                color: #ADD8E6;
            }
            
            /* Hide site status by default on mobile */
            .status-section {
                display: none;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 6px; /* Reduced margin */
                animation: slideDown 0.3s ease-out;
                gap: 8px; /* Add gap for better spacing */
            }
            
            .status-section.mobile-expanded {
                display: flex;
            }
            
            @keyframes slideDown {
                from {
                    opacity: 0;
                    max-height: 0;
                }
                to {
                    opacity: 1;
                    max-height: 400px; /* Increased for sensor data */
                }
            }
            
            /* Always show AI pipeline only */
            .essential-status {
                display: flex;
                flex-direction: column;
                gap: 4px; /* Reduced gap */
                align-items: center;
            }
            
            .sensor-data {
                font-size: 11px; /* Smaller font */
                padding: 4px 6px; /* Reduced padding */
                gap: 6px; /* Reduced gap */
                border-radius: 6px; /* Smaller radius */
                max-width: 100%;
                overflow-x: auto;
                white-space: nowrap;
                background: #2c5f2d;
                color: #ffffff;
                margin-bottom: 4px; /* Add spacing when in collapsed section */
                display: flex; /* Ensure flex display */
                flex-wrap: wrap; /* Allow wrapping on small screens */
                justify-content: center; /* Center items */
            }
            
            .ai-pipeline-status {
                background: #1e3a8a;
                color: #ffffff;
                margin-left: 0;
                font-size: 11px; /* Smaller font */
                padding: 4px 6px; /* Reduced padding */
                gap: 6px; /* Reduced gap */
                border-radius: 6px; /* Smaller radius */
                max-width: 100%;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .sensor-item {
                font-size: 10px; /* Smaller font */
                margin-right: 8px; /* Reduced margin */
            }
            
            .pipeline-item {
                font-size: 11px; /* Smaller font */
                gap: 4px; /* Reduced gap */
            }
            
            .status-item {
                margin: 0 3px 3px 0; /* Reduced margins */
                font-size: 10px; /* Smaller font */
            }
            
            .refresh {
                font-size: 14px; /* Smaller refresh icon */
                margin-top: 4px; /* Add some spacing */
            }
            
            .chatbox {
                margin: 0;
                border-radius: 0;
                height: calc(100vh - env(safe-area-inset-top) - 80px); /* Adjusted for smaller topbar */
                max-height: calc(100vh - env(safe-area-inset-top) - 80px);
                box-shadow: none;
            }
            
            .chat-header {
                padding: 10px 15px;
                border-top-left-radius: 0;
                border-top-right-radius: 0;
            }
            
            .chat-header h2 {
                font-size: 16px;
            }
            
            .action-buttons {
                gap: 5px;
            }
            
            .action-buttons button {
                font-size: 12px;
                padding: 6px 10px;
            }
            
            .messages-container {
                padding: 15px 10px;
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            .message {
                max-width: 85%; /* Wider on mobile like iMessage */
                margin-bottom: 8px;
            }
            
            .message-bubble {
                padding: 8px 12px;
                border-radius: 16px;
                font-size: 16px; /* Larger text on mobile */
                line-height: 1.4;
            }
            
            .message-info {
                font-size: 10px;
                margin-top: 2px;
                padding: 0 8px;
            }
            
            .chat-input-container {
                padding: 10px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
                background: #f6f6f6;
            }
            
            .chat-controls {
                gap: 5px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }
            
            .chat-controls select, .chat-controls input {
                font-size: 14px;
                padding: 8px 10px;
                white-space: nowrap;
                min-width: fit-content;
            }
            
            .chat-controls label {
                white-space: nowrap;
                font-size: 14px;
            }
            
            .chat-input-form {
                gap: 8px;
            }
            
            .chat-textarea {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 44px; /* iOS touch target minimum */
                border-radius: 22px;
                padding: 12px 16px;
            }
            
            .send-button {
                min-width: 44px; /* iOS touch target minimum */
                height: 44px;
                border-radius: 22px;
                font-size: 16px;
                padding: 0 20px;
            }
            
            /* Custom system message textarea on mobile */
            #custom-system-group textarea {
                font-size: 14px;
                padding: 8px 12px;
                border-radius: 12px;
            }
            
            /* Hide less important status items on very small screens */
            @media (max-width: 480px) {
                .sensor-data {
                    flex-wrap: wrap;
                    justify-content: center;
                }
                
                .sensor-item {
                    margin-bottom: 2px;
                }
                
                .chat-controls {
                    flex-direction: column;
                    gap: 8px;
                }
                
                .chat-controls > * {
                    width: 100%;
                }
            }
        }
        
        .topbar 
        { 
            background: #333; 
            color: white; 
            padding: 8px 10px; /* Reduced padding */
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .status-container 
        { 
            display: flex; 
            flex-wrap: wrap; 
            align-items: center; 
            gap: 10px; /* Reduced gap */
        }
        /* Desktop status section */
        @media (min-width: 769px) {
            .status-section 
            { 
                display: flex; 
                flex-wrap: wrap; 
                align-items: center; 
                gap: 10px; /* Add gap for better spacing */
            }
        }
        
        .status-item 
        { 
            margin-right: 8px; /* Reduced margin */
        }
        .status-link 
        { 
            color: #87CEEB; 
            text-decoration: underline; 
        }
        .status-link:hover 
        { 
            color: #ADD8E6; 
            text-decoration: underline; 
        }
        .sensor-data 
        { 
            background: #444; 
            padding: 6px 10px; /* Reduced padding */
            border-radius: 4px; /* Smaller radius */
            display: flex; 
            gap: 12px; /* Reduced gap */
            margin-bottom: 8px; /* Add spacing when in collapsed section */
        }
        .sensor-item 
        { 
            display: flex; 
            align-items: center; 
            gap: 4px; /* Reduced gap */
        }
        .refresh 
        { 
            cursor: pointer; 
            font-size: 16px; /* Smaller refresh icon */
            margin-top: 4px; /* Add some spacing */
        }
        
        /* AI Pipeline Status - keep minimal */
        .ai-pipeline-status {
            background: #555;
            padding: 6px 10px; /* Reduced padding */
            border-radius: 4px; /* Smaller radius */
            display: flex;
            gap: 12px; /* Reduced gap */
            margin-left: 0; /* Remove left margin */
        }
        
        .pipeline-item {
            display: flex;
            align-items: center;
            gap: 4px; /* Reduced gap */
            font-size: 13px; /* Slightly smaller font */
        }
        
        .pipeline-item .status-indicator {
            font-size: 11px; /* Smaller indicator */
        }
        
        .pipeline-item .detail {
            font-size: 10px; /* Smaller detail text */
            color: #ccc;
        }
        
        /* Better select styling for visibility */
        select option {
            background-color: white;
            color: black;
            padding: 4px;
        }
        
        select option:hover,
        select option:focus,
        select option:checked {
            background-color: #007AFF;
            color: white;
        }
        
        /* Voice category styling */
        select optgroup {
            font-weight: bold;
            color: #333;
            background-color: #f0f0f0;
            padding: 4px 0;
        }
        
        select optgroup option {
            font-weight: normal;
            padding-left: 16px;
            background-color: white;
        }
        
        /* Ensure personality emojis show properly */
        #voice-select option {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        
        /* iPhone Messages Style */
        .chatbox { background: white; padding: 0; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; height: 600px; display: flex; flex-direction: column; }
        
        .chat-header { 
            background: #f6f6f6; 
            padding: 15px 20px; 
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-header h2 { margin: 0; font-size: 18px; font-weight: 600; }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            max-width: 70%;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .message.user {
            align-self: flex-end;
        }
        
        .message.assistant {
            align-self: flex-start;
        }
        
        .message-bubble {
            padding: 10px 14px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }
        
        .message.user .message-bubble {
            background: #007AFF;
            color: white;
        }
        
        .message.assistant .message-bubble {
            background: #E5E5EA;
            color: black;
        }
        
        .message-info {
            font-size: 11px;
            color: #8e8e93;
            margin-top: 2px;
            padding: 0 10px;
        }
        
        .message.user .message-info {
            text-align: right;
        }
        
        .chat-input-container {
            padding: 15px;
            background: #f6f6f6;
            border-top: 1px solid #e5e5e7;
        }
        
        .chat-input-form {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .chat-input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .chat-controls select, .chat-controls input {
            padding: 6px 10px;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            background: white;
            font-size: 14px;
        }
        
        .chat-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e5e5e7;
            border-radius: 20px;
            resize: none;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            min-height: 40px;
            max-height: 120px;
        }
        
        .chat-textarea:focus {
            border-color: #007AFF;
        }
        
        .send-button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
            flex-shrink: 0;
            height: 40px;
        }
        
        .send-button:hover {
            background: #0051D5;
        }
        
        .send-button:disabled {
            background: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        
        .send-button:disabled:hover {
            background: #cccccc;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .clear-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .clear-button:hover {
            background: #c82333;
        }
        
        .logs-button {
            background: #4169e1;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .logs-button:hover {
            background: #2950d1;
        }
        
        /* Audio player styling */
        audio {
            width: 100%;
            margin-top: 10px;
            border-radius: 8px;
        }
        
        /* Think section styling */
        .think-toggle {
            display: inline-block;
            font-size: 11px;
            color: #007AFF;
            cursor: pointer;
            margin-bottom: 5px;
            user-select: none;
        }
        
        .think-toggle:hover {
            text-decoration: underline;
        }
        
        .think-content {
            display: none;
            background: #f0f0f0;
            padding: 8px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }
        
        .think-content.expanded {
            display: block;
        }
        
        /* Loading animation */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            padding: 10px 14px;
            background: #E5E5EA;
            border-radius: 18px;
            margin-bottom: 10px;
        }
        
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #8e8e93;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        
        /* Flash animation for status indicator */
        @keyframes flash {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.3;
            }
        }
    </style>
    
    <!-- Template data as JSON to avoid linter conflicts -->
    <script type="application/json" id="roverseer-data">
        {
            "voices": {{ voices | tojson }},
            "categorizedVoices": {{ categorized_voices | tojson }},
            "personalities": {{ personalities | tojson }},
            "currentPersonality": {{ current_personality | tojson if current_personality else 'null' | safe }},
            "selectedModel": {{ selected_model | tojson }},
            "selectedVoice": {{ selected_voice | tojson }}
        }
    </script>
    
    <script>
        // Configuration
        var STATUS_REFRESH_INTERVAL = 5000; // 5 seconds
        
        // Parse template data from JSON script
        var roverseerDataScript = document.getElementById('roverseer-data');
        var roverseerData = JSON.parse(roverseerDataScript.textContent);
        
        // Use the properly escaped template data
        var availableVoices = roverseerData.voices;
        var categorizedVoices = roverseerData.categorizedVoices;
        var availablePersonalities = roverseerData.personalities;
        var currentPersonalityName = roverseerData.currentPersonality ? roverseerData.currentPersonality.name : null;
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function processThinkTags(text) {
            // Check if text contains <think> tags
            var thinkRegex = /<think>([\s\S]*?)<\/think>/gi;
            var matches = text.match(thinkRegex);
            
            if (!matches) {
                return escapeHtml(text);
            }
            
            // Extract think content and main content
            var thinkContent = '';
            var mainContent = text;
            
            matches.forEach(function(match) {
                var content = match.replace(/<\/?think>/gi, '');
                thinkContent += content + '\n';
                mainContent = mainContent.replace(match, '');
            });
            
            mainContent = mainContent.trim();
            thinkContent = thinkContent.trim();
            
            // Generate unique ID for this think section - using 4 characters instead of 2
            var thinkId = 'think-' + Date.now() + '-' + Math.random().toString(36).substr(0, 4);
            
            // Build HTML with collapsible think section
            var html = '';
            if (thinkContent) {
                html += '<span class="think-toggle" onclick="toggleThink(\'' + thinkId + '\')">▶ Show thoughts</span>';
                html += '<div class="think-content" id="' + thinkId + '">' + escapeHtml(thinkContent) + '</div>';
            }
            html += escapeHtml(mainContent);
            
            return html;
        }
        
        function toggleThink(thinkId) {
            var thinkElement = document.getElementById(thinkId);
            var toggleElement = thinkElement.previousElementSibling;
            
            if (thinkElement.classList.contains('expanded')) {
                thinkElement.classList.remove('expanded');
                toggleElement.textContent = '▶ Show thoughts';
            } else {
                thinkElement.classList.add('expanded');
                toggleElement.textContent = '▼ Hide thoughts';
            }
        }
        
        // Auto-scroll to bottom of messages
        window.onload = function() {
            var messagesContainer = document.getElementById('messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Process all existing messages for think tags
            document.querySelectorAll('.message.assistant .message-bubble').forEach(function(bubble) {
                var text = bubble.textContent;
                if (text.includes('<think>')) {
                    bubble.innerHTML = processThinkTags(text);
                }
            });
            
            // Process any new message that needs processing
            document.querySelectorAll('.needs-processing').forEach(function(bubble) {
                var text = bubble.getAttribute('data-text');
                var audioHtml = bubble.querySelector('audio') ? bubble.querySelector('audio').outerHTML : '';
                bubble.innerHTML = processThinkTags(text) + audioHtml;
                bubble.classList.remove('needs-processing');
            });
            
            // Start auto-refresh of status every 5 seconds
            setInterval(refreshStatus, STATUS_REFRESH_INTERVAL);
        }
        
        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }
        
        // Track if request is in progress
        var requestInProgress = false;
        
        // Store current form selections
        var currentSelections = {
            outputType: 'speak',
            model: roverseerData.selectedModel,
            voice: roverseerData.selectedVoice
        };
        
        // Function to toggle between personality and voice mode
        function togglePersonalityMode() {
            var usePersonality = document.getElementById('use-personality').checked;
            var voiceSelect = document.getElementById('voice-select');
            var customSystemGroup = document.getElementById('custom-system-group');
            var systemTextarea = document.getElementById('system-message');
            
            // Clear current options
            voiceSelect.innerHTML = '';
            
            if (usePersonality) {
                // Show personalities
                customSystemGroup.style.display = 'none';
                systemTextarea.value = ''; // Clear system message
                
                availablePersonalities.forEach(function(personality) {
                    var option = document.createElement('option');
                    option.value = personality.voice_id;
                    option.setAttribute('data-personality', personality.name);
                    option.textContent = personality.avatar_emoji + ' ' + personality.name;
                    
                    // Select current personality if it matches
                    if (currentPersonalityName && currentPersonalityName === personality.name) {
                        option.selected = true;
                    }
                    
                    voiceSelect.appendChild(option);
                });
            } else {
                // Show voices with categories
                customSystemGroup.style.display = 'block';
                
                // Check if we have categorized voices
                if (categorizedVoices && categorizedVoices.categorized) {
                    // Create optgroups for each category
                    for (var categoryName in categorizedVoices.categorized) {
                        if (categorizedVoices.categorized.hasOwnProperty(categoryName)) {
                            var voices = categorizedVoices.categorized[categoryName];
                            
                            // Create optgroup for this category (unless it's uncategorized)
                            if (categoryName === 'uncategorized') {
                                // Add uncategorized voices directly (no optgroup)
                                voices.forEach(function(voice) {
                                    var option = document.createElement('option');
                                    option.value = voice;
                                    option.textContent = voice;
                                    
                                    if (roverseerData.selectedVoice === voice) {
                                        option.selected = true;
                                    }
                                    
                                    voiceSelect.appendChild(option);
                                });
                            } else {
                                // Create optgroup for categorized voices
                                var optgroup = document.createElement('optgroup');
                                optgroup.label = categoryName;
                                
                                voices.forEach(function(voice) {
                                    var option = document.createElement('option');
                                    option.value = voice;
                                    option.textContent = voice;
                                    
                                    if (roverseerData.selectedVoice === voice) {
                                        option.selected = true;
                                    }
                                    
                                    optgroup.appendChild(option);
                                });
                                
                                voiceSelect.appendChild(optgroup);
                            }
                        }
                    }
                } else {
                    // Fallback to flat list if no categorization
                    availableVoices.forEach(function(voice) {
                        var option = document.createElement('option');
                        option.value = voice;
                        option.textContent = voice;
                        
                        // Select current voice if it matches
                        if (roverseerData.selectedVoice === voice) {
                            option.selected = true;
                        }
                        
                        voiceSelect.appendChild(option);
                    });
                }
            }
        }
        
        // Update selections when changed
        document.addEventListener('DOMContentLoaded', function() 
        {
            // Initialize the voice/personality dropdown
            togglePersonalityMode();
            
            // Debug: Log initial voice value
            console.log('Initial voice value after toggle:', document.querySelector('[name="voice"]').value);
            
            document.querySelector('[name="output_type"]').addEventListener('change', function(e) 
            {
                currentSelections.outputType = e.target.value;
            });
            document.querySelector('[name="model"]').addEventListener('change', function(e) 
            {
                currentSelections.model = e.target.value;
            });
            document.querySelector('[name="voice"]').addEventListener('change', function(e) 
            {
                currentSelections.voice = e.target.value;
                console.log('Voice changed to:', e.target.value);
                
                var usePersonality = document.getElementById('use-personality').checked;
                
                if (usePersonality) 
                {
                    // Get the selected option's personality data
                    var selectedOption = e.target.options[e.target.selectedIndex];
                    var personalityName = selectedOption.getAttribute('data-personality');
                    
                    if (personalityName) 
                    {
                        // Fetch personality details to get model preference
                        fetch('/system/personalities')
                            .then(response => response.json())
                            .then(data => 
                            {
                                var personality = data.personalities.find(p => p.name === personalityName);
                                if (personality && personality.model_preference) 
                                {
                                    // Update model selection if personality has a preference
                                    var modelSelect = document.querySelector('[name="model"]');
                                    
                                    // Check if model exists in dropdown
                                    var modelExists = false;
                                    for (var i = 0; i < modelSelect.options.length; i++) 
                                    {
                                        if (modelSelect.options[i].value === personality.model_preference) 
                                        {
                                            modelExists = true;
                                            break;
                                        }
                                    }
                                    
                                    if (modelExists) 
                                    {
                                        modelSelect.value = personality.model_preference;
                                        currentSelections.model = personality.model_preference;
                                        console.log('Updated model to personality preference:', personality.model_preference);
                                    } 
                                    else 
                                    {
                                        console.warn('Personality preferred model not available:', personality.model_preference);
                                    }
                                }
                            })
                            .catch(error => 
                            {
                                console.error('Error fetching personality details:', error);
                            });
                    }
                }
            });
            
            // Set initial values from the form elements
            currentSelections.outputType = document.querySelector('[name="output_type"]').value;
            currentSelections.model = document.querySelector('[name="model"]').value;
            currentSelections.voice = document.querySelector('[name="voice"]').value;
        });
        
        function refreshStatus() 
        {
            console.log('🔄 Auto-refreshing status at', new Date().toLocaleTimeString());
            
            // Only refresh status, not reload the page
            fetch('/status_only')
                .then(response => response.json())
                .then(data => 
                {
                    console.log('📊 Status data received:', data);
                    
                    // Update sensor data
                    if (data.sensor_data) 
                    {
                        var sensorElement = document.querySelector('.sensor-data');
                        if (sensorElement) {
                            sensorElement.innerHTML = 
                                '<span class="sensor-item">🌡️ HAT: ' + data.sensor_data.hat_temperature + '</span>' +
                                '<span class="sensor-item">🖥️ CPU: ' + data.sensor_data.cpu_temperature + '</span>' +
                                '<span class="sensor-item">🌊 ' + data.sensor_data.pressure + '</span>' +
                                '<span class="sensor-item">🏔️ ' + data.sensor_data.altitude + '</span>' +
                                '<span class="sensor-item">🌬️ Fan: ' + data.sensor_data.fan_state + '</span>';
                            console.log('✅ Sensor data updated');
                        } else {
                            console.warn('⚠️ .sensor-data element not found');
                        }
                    }
                    
                    // Update TCP status - find or create TCP services container
                    if (data.tcp_status) 
                    {
                        var statusHtml = '';
                        for (const [name, info] of Object.entries(data.tcp_status)) 
                        {
                            if (name === "Ollama") 
                            {
                                statusHtml += '<span class="status-item">' +
                                    '<a href="http://roverseer.local:' + info.port + '/api/tags" onclick="window.open(this.href, \'_blank\'); return false;" class="status-link">' +
                                        info.status + ' ' + name + ' (' + info.port + ')' +
                                    '</a>' +
                                '</span>';
                            } 
                            else 
                            {
                                statusHtml += '<span class="status-item">' +
                                    '<a href="http://roverseer.local:' + info.port + '" onclick="window.open(this.href, \'_blank\'); return false;" class="status-link">' +
                                        info.status + ' ' + name + ' (' + info.port + ')' +
                                    '</a>' +
                                '</span>';
                            }
                        }
                        
                        // Find the TCP services container and update only that part
                        var statusSection = document.querySelector('.status-section');
                        var tcpContainer = statusSection ? statusSection.querySelector('.tcp-services') : null;
                        
                        if (tcpContainer) {
                            // Update existing TCP container
                            tcpContainer.innerHTML = statusHtml;
                            console.log('✅ TCP services updated');
                        } else {
                            console.warn('⚠️ .tcp-services container not found');
                            // Create TCP container if it doesn't exist and insert before sensor data
                            if (statusSection) {
                                var sensorData = statusSection.querySelector('.sensor-data');
                                var newTcpContainer = document.createElement('div');
                                newTcpContainer.className = 'tcp-services';
                                newTcpContainer.innerHTML = statusHtml;
                                statusSection.insertBefore(newTcpContainer, sensorData);
                                console.log('✅ TCP services container created and updated');
                            }
                        }
                    }
                    
                    // Update AI pipeline status
                    if (data.ai_pipeline) 
                    {
                        updateAIPipelineStatus(data.ai_pipeline);
                        console.log('✅ AI pipeline status updated');
                    }
                })
                .catch(error => {
                    console.error('❌ Error refreshing status:', error);
                });
        }
        
        function updateAIPipelineStatus(pipeline) 
        {
            var pipelineDiv = document.querySelector('.ai-pipeline-status');
            if (pipelineDiv) 
            {
                var statusHtml = 
                    '<div class="pipeline-item">' +
                        '<span class="status-indicator">' + pipeline.status + '</span>' +
                        '<span>RoverSeer</span>' +
                        (pipeline.activity !== 'idle' ? '<span class="detail">' + pipeline.activity + '</span>' : '') +
                        (pipeline.detail ? '<span class="detail">(' + pipeline.detail + ')</span>' : '') +
                        (pipeline.requests ? '<span class="detail">[' + pipeline.requests + ']</span>' : '') +
                    '</div>';
                pipelineDiv.innerHTML = statusHtml;
            }
        }
        
        // Handle form submission
        function handleSubmit(event) 
        {
            event.preventDefault(); // Prevent default form submission
            
            // Immediately disable submit button and check if already in progress
            var submitButton = event.target.querySelector('[type="submit"]');
            if (submitButton.disabled || requestInProgress) 
            {
                return; // Already processing
            }
            
            // Check if RoverSeer is already busy by fetching current status
            fetch('/status_only')
                .then(response => response.json())
                .then(data => 
                {
                    if (data.ai_pipeline && data.ai_pipeline.status !== '🔵') 
                    {
                        // RoverSeer is busy
                        var messagesContainer = document.getElementById('messages-container');
                        var typingIndicator = document.getElementById('typing-indicator');
                        
                        var errorDiv = document.createElement('div');
                        errorDiv.className = 'message assistant';
                        errorDiv.innerHTML = 
                            '<div class="message-bubble">RoverSeer is currently busy processing another request. Please wait a moment and try again.</div>' +
                            '<div class="message-info">System</div>';
                        messagesContainer.insertBefore(errorDiv, typingIndicator);
                        
                        // Scroll to bottom
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        
                        // Flash the status indicator
                        var statusIndicator = document.querySelector('.ai-pipeline-status .status-indicator');
                        if (statusIndicator) 
                        {
                            statusIndicator.style.animation = 'flash 0.5s ease-in-out 3';
                            setTimeout(() => 
                            {
                                statusIndicator.style.animation = '';
                            }, 1500);
                        }
                        
                        return; // Don't proceed with submission
                    }
                    
                    // RoverSeer is idle, proceed with submission
                    proceedWithSubmission(event);
                })
                .catch(error => 
                {
                    // If status check fails, proceed anyway
                    console.error('Failed to check status:', error);
                    proceedWithSubmission(event);
                });
        }
        
        function proceedWithSubmission(event) 
        {
            var submitButton = event.target.querySelector('[type="submit"]');
            
            // Set request in progress and disable button
            requestInProgress = true;
            submitButton.disabled = true;
            
            // Get form values
            var userInput = document.querySelector('[name="user_input"]').value.trim();
            var model = document.querySelector('[name="model"]').value;
            var modelDisplay = document.querySelector('[name="model"] option:checked').text;
            var voice = document.querySelector('[name="voice"]').value;
            var outputType = document.querySelector('[name="output_type"]').value;
            var usePersonality = document.getElementById('use-personality').checked;
            var systemMessage = document.getElementById('system-message').value.trim();
            
            // Validate voice selection - use default if empty
            if (!voice) 
            {
                voice = roverseerData.selectedVoice || 'en_US-amy-medium';
                console.warn('No voice selected, using default:', voice);
            }
            
            if (!userInput) 
            {
                // Re-enable if no input
                requestInProgress = false;
                submitButton.disabled = false;
                return;
            }
            
            // Add user message immediately
            var messagesContainer = document.getElementById('messages-container');
            var typingIndicator = document.getElementById('typing-indicator');
            
            var userDiv = document.createElement('div');
            userDiv.className = 'message user';
            userDiv.innerHTML = 
                '<div class="message-bubble">' + escapeHtml(userInput) + '</div>' +
                '<div class="message-info">You</div>';
            messagesContainer.insertBefore(userDiv, typingIndicator);
            
            // Clear input and reset height
            document.querySelector('[name="user_input"]').value = '';
            document.querySelector('[name="user_input"]').style.height = 'auto';
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            
            // Update status to show activity immediately
            updateAIPipelineStatus({
                status: '🟢',
                activity: '🤔 thinking',
                detail: modelDisplay.split(' ')[0]
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Submit via AJAX
            var formData = new FormData();
            formData.append('action', 'chat');
            formData.append('user_input', userInput);
            formData.append('model', model);
            formData.append('voice', voice);
            formData.append('output_type', outputType);
            formData.append('use_personality', usePersonality);
            formData.append('system_message', systemMessage);
            
            // Debug logging
            console.log('Submitting form with voice:', voice);
            console.log('Use personality:', usePersonality);
            
            fetch('/chat_ajax', {
                method: 'POST',
                body: formData
            })
            .then(response => 
            {
                // Check if we got a 429 (Too Many Requests) status
                if (response.status === 429) 
                {
                    return response.json().then(data => 
                    {
                        throw new Error(data.error || 'RoverSeer is busy');
                    });
                }
                return response.json();
            })
            .then(data => 
            {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                if (data.error) 
                {
                    // Show error message
                    var errorDiv = document.createElement('div');
                    errorDiv.className = 'message assistant';
                    errorDiv.innerHTML = 
                        '<div class="message-bubble">Error: ' + escapeHtml(data.error) + '</div>' +
                        '<div class="message-info">System</div>';
                    messagesContainer.insertBefore(errorDiv, typingIndicator);
                } 
                else 
                {
                    // Add assistant message
                    var assistantDiv = document.createElement('div');
                    assistantDiv.className = 'message assistant';
                    
                    var messageContent = processThinkTags(data.reply);
                    
                    if (data.audio_url) 
                    {
                        messageContent += '<audio controls autoplay>' +
                            '<source src="' + data.audio_url + '" type="audio/wav">' +
                            'Your browser does not support the audio element.' +
                        '</audio>';
                    }
                    
                    // Get current personality info for display
                    var personalityDisplay = '';
                    if (data.personality) 
                    {
                        personalityDisplay = data.personality.avatar_emoji + ' ' + 
                                           data.personality.name;
                    }
                    if (!personalityDisplay.trim()) 
                    {
                        personalityDisplay = modelDisplay; // Fallback to model
                    }
                    
                    assistantDiv.innerHTML = 
                        '<div class="message-bubble">' + messageContent + '</div>' +
                        '<div class="message-info">' + escapeHtml(personalityDisplay) + '</div>';
                    messagesContainer.insertBefore(assistantDiv, typingIndicator);
                }
                
                // Update AI pipeline status
                if (data.ai_pipeline) 
                {
                    updateAIPipelineStatus(data.ai_pipeline);
                }
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Re-enable submit button
                submitButton.disabled = false;
                
                // Restore form selections
                document.querySelector('[name="output_type"]').value = currentSelections.outputType;
                document.querySelector('[name="model"]').value = currentSelections.model;
                
                // Safely restore voice selection
                var voiceSelect = document.querySelector('[name="voice"]');
                if (voiceSelect && currentSelections.voice) 
                {
                    // Check if the voice option exists
                    var voiceExists = false;
                    for (var i = 0; i < voiceSelect.options.length; i++) 
                    {
                        if (voiceSelect.options[i].value === currentSelections.voice) 
                        {
                            voiceExists = true;
                            break;
                        }
                    }
                    
                    if (voiceExists) 
                    {
                        voiceSelect.value = currentSelections.voice;
                    } 
                    else 
                    {
                        console.warn('Voice option not found:', currentSelections.voice);
                        // Let it use the default selected option
                    }
                }
                
                // Clear request flag
                requestInProgress = false;
            })
            .catch(error => 
            {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                
                // Add error message
                var errorDiv = document.createElement('div');
                errorDiv.className = 'message assistant';
                errorDiv.innerHTML = 
                    '<div class="message-bubble">Sorry, an error occurred: ' + escapeHtml(error.toString()) + '</div>' +
                    '<div class="message-info">System</div>';
                messagesContainer.insertBefore(errorDiv, typingIndicator);
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Re-enable submit button
                submitButton.disabled = false;
                
                // Update status back to idle
                updateAIPipelineStatus({
                    status: '🔵',
                    activity: 'idle',
                    detail: ''
                });
                
                // Clear request flag
                requestInProgress = false;
            });
        }
        
        // Mobile status toggle functionality
        function toggleMobileStatus() {
            var statusSection = document.querySelector('.status-section');
            var toggleButton = document.querySelector('.mobile-status-toggle');
            
            console.log('Toggling mobile status. Current classes:', statusSection.className);
            
            if (statusSection.classList.contains('mobile-expanded')) {
                statusSection.classList.remove('mobile-expanded');
                toggleButton.textContent = '📡 Show Status';
                console.log('Status collapsed');
            } else {
                statusSection.classList.add('mobile-expanded');
                toggleButton.textContent = '📡 Hide Status';
                console.log('Status expanded');
            }
        }
        
        // Show mobile toggle button only on mobile
        function setupMobileUI() {
            console.log('Setting up mobile UI. Window width:', window.innerWidth);
            
            var toggleButton = document.querySelector('.mobile-status-toggle');
            var statusSection = document.querySelector('.status-section');
            
            if (window.innerWidth <= 768) {
                toggleButton.style.display = 'block';
                console.log('Mobile mode: toggle button shown');
                // Start with status expanded on mobile for better UX
                statusSection.classList.add('mobile-expanded');
                toggleButton.textContent = '📡 Hide Status';
            } else {
                toggleButton.style.display = 'none';
                // Ensure status section is visible on desktop
                statusSection.classList.add('mobile-expanded');
                console.log('Desktop mode: status always visible');
            }
        }
        
        // Setup mobile UI on load and resize
        window.addEventListener('load', setupMobileUI);
        window.addEventListener('resize', setupMobileUI);
    </script>
    
    {% if reply_text %}
    <!-- Messages are already rendered server-side, no need for JavaScript -->
    {% endif %}
</head>
<body>
    <div class="topbar">
        <div><strong>RoverSeer</strong></div>
        <div class="status-container">
            <!-- Mobile toggle button for expanded status -->
            <button class="mobile-status-toggle" onclick="toggleMobileStatus()" style="display: none;">
                📡 Show Status
            </button>
            
            <!-- Collapsible status section - includes TCP services, sensor data, and refresh -->
            <div class="status-section">
                <!-- TCP Services -->
                <div class="tcp-services">
                    {% for name, info in statuses.items() %}
                        <span class="status-item">
                            {% if name == "Ollama" %}
                                <a href="http://roverseer.local:{{ info.port }}/api/tags" onclick="window.open(this.href, '_blank'); return false;" class="status-link">
                                    {{ info.status }} {{ name }} ({{ info.port }})
                                </a>
                            {% else %}
                                <a href="http://roverseer.local:{{ info.port }}" onclick="window.open(this.href, '_blank'); return false;" class="status-link">
                                    {{ info.status }} {{ name }} ({{ info.port }})
                                </a>
                            {% endif %}
                        </span>
                    {% endfor %}
                </div>
                
                <!-- Sensor Data (moved from essential-status) -->
                <div class="sensor-data">
                    <span class="sensor-item">🌡️ HAT: {{ sensor_data.hat_temperature }}</span>
                    <span class="sensor-item">🖥️ CPU: {{ sensor_data.cpu_temperature }}</span>
                    <span class="sensor-item">🌊 {{ sensor_data.pressure }}</span>
                    <span class="sensor-item">🏔️ {{ sensor_data.altitude }}</span>
                    <span class="sensor-item">🌬️ Fan: {{ sensor_data.fan_state }}</span>
                </div>
                
                <!-- Refresh button (moved from outside) -->
                <span class="refresh" onclick="refreshStatus()">🔄</span>
            </div>
            
            <!-- Essential status - only AI pipeline always visible -->
            <div class="essential-status">
                <div class="ai-pipeline-status">
                    <div class="pipeline-item">
                        <span class="status-indicator">{{ ai_pipeline.status }}</span>
                        <span>RoverSeer</span>
                        {% if ai_pipeline.activity != 'idle' %}
                        <span class="detail">{{ ai_pipeline.activity }}</span>
                        {% endif %}
                        {% if ai_pipeline.detail %}
                        <span class="detail">({{ ai_pipeline.detail }})</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="chatbox">
        <div class="chat-header">
            <h2>RoverSeer Chat{% if current_personality %} - {{ current_personality.avatar_emoji }} {{ current_personality.name }}{% endif %}</h2>
            <div class="action-buttons">
                <form method="post" style="display: inline;">
                    <input type="hidden" name="action" value="clear_context">
                    <button type="submit" class="clear-button">🗑️ Clear</button>
                </form>
                <button onclick="window.location.href='/system'" class="logs-button">📊 System</button>
            </div>
        </div>
        
        <div class="messages-container" id="messages-container">
            {% for user, reply, model in history %}
                <div class="message user">
                    <div class="message-bubble">{{ user }}</div>
                    <div class="message-info">You</div>
                </div>
                <div class="message assistant">
                    <div class="message-bubble">{{ reply }}</div>
                    <div class="message-info">{{ model }}</div>
                </div>
            {% endfor %}
            
            <div class="typing-indicator" id="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="chat-input-container">
            <form method="post" id="chat_form" class="chat-input-form" onsubmit="handleSubmit(event)">
            <input type="hidden" name="action" value="chat">
            
                <div class="chat-input-wrapper">
                    <div class="chat-controls">
                        <select name="output_type" title="Output Type">
                            <option value="speak">🔊 RoverSeer</option>
                            <option value="audio_file">🎵 Local Audio</option>
                            <option value="text">📝 Text Only</option>
            </select>
            
                        <select name="model" title="AI Model">
                {% for tag in models %}
                    <option value="{{ tag.full_name }}" {% if tag.full_name == selected_model %}selected{% endif %}>
                        {{ tag.display_name }}
                    </option>
                {% endfor %}
            </select>
            
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="use-personality" name="use_personality" checked onchange="togglePersonalityMode()">
                            <span style="white-space: nowrap;">Use Personality</span>
                        </label>
                        
                        <select name="voice" id="voice-select" title="Voice/Personality">
                            <!-- Will be populated dynamically based on checkbox state -->
                        </select>
                    </div>
                    
                    <div id="custom-system-group" style="display: none; margin-top: 8px;">
                        <textarea 
                            name="system" 
                            id="system-message" 
                            class="chat-textarea" 
                            style="min-height: 60px; font-size: 14px;"
                            placeholder="Enter custom system message..."
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    
                    <textarea 
                        name="user_input" 
                        class="chat-textarea" 
                        placeholder="Type a message..."
                        oninput="autoResize(this)"
                        onkeydown="if(event.key === 'Enter' && (event.metaKey || event.ctrlKey || !event.shiftKey)) { event.preventDefault(); document.getElementById('chat_form').requestSubmit(); }"
                    ></textarea>
                </div>
                
                <button type="submit" class="send-button">Send</button>
        </form>
        </div>
    </div>
</body>
</html> 